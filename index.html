<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>å¹³å°é—–é—œï¼ˆè³‡æ–™é©…å‹•éª¨æ¶ Â· Phase 1ï¼‰</title>
<style>
  html,body{margin:0;height:100%;background:#0e1126;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial}
  canvas{display:block;width:100vw;height:100vh;touch-action:none}

  /* ä¸Šæ–¹å·¥å…·åˆ— */
  #uiTop{position:fixed;left:8px;right:8px;top:8px;display:flex;gap:8px;align-items:center;z-index:10}
  .btn{appearance:none;border:0;background:#21d07a;color:#042;font-weight:800;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.grey{background:#cfe3ff;color:#0a2352}

  /* èª¿è‰²ç›¤ï¼ˆåº•éƒ¨é¢æ¿ï¼‰ */
  .panel{position:fixed;left:8px;right:8px;bottom:8px;background:#0008;border:1px solid #ffffff22;border-radius:12px;padding:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;z-index:2}
  .tile{min-width:42px;min-height:42px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#ffffff14;border:1px solid #ffffff22;user-select:none}
  .tile.active{outline:2px solid #ffd34e}
  .group-title{font-size:12px;opacity:.85;padding:4px 6px;border-radius:6px;background:#ffffff14;border:1px solid #ffffff22;user-select:none}
  .pill{appearance:none;border:0;background:#cfe3ff;color:#0a2352;font-weight:800;border-radius:999px;padding:6px 12px;cursor:pointer}
  .pill.active{background:#ffd34e;color:#3b2900}
  .pal-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pal-row.header{width:100%}
  .pal-row.tiles{padding-top:4px;flex-wrap:wrap}
  .pal-row.footer{margin-left:auto}
  .hidden{display:none !important}
</style>
</head>
<body>
<canvas id="cv" aria-label="ä¸»ç•«å¸ƒ"></canvas>

<!-- ç°¡æ˜“å·¥å…·åˆ—ï¼ˆPhase 1 åªå«åœ°ç·¨ç›¸é—œï¼‰ -->
<div id="uiTop">
  <button id="mapBtn" class="btn">åœ°åœ–</button>
  <button id="helpBtn" class="btn grey">èªªæ˜</button>
</div>

<!-- èª¿è‰²ç›¤ï¼šåˆ†é¡ + å‹•æ…‹é …ç›® + è¦–åœ–å·¥å…· -->
<div class="panel" id="palette" aria-label="èª¿è‰²ç›¤">
  <div class="pal-row header">
    <span class="group-title">èª¿è‰²ç›¤</span>
    <button class="pill" data-cat="building">å»ºç¯‰</button>
    <button class="pill" data-cat="monsters">æ€ªç¸</button>
    <button class="pill" data-cat="critters">å‹•ç‰©</button>
    <button id="palBackBtn" class="pill hidden">â† è¿”å›åˆ†é¡</button>
    <span style="margin-left:auto"></span>
  </div>
  <div id="palTiles" class="pal-row tiles"></div>
  <div class="pal-row footer">
    <span class="group-title">è¦–åœ– / å·¥å…·</span>
    <span style="margin-left:auto"></span>
    <button id="smallerBtn" class="btn grey">ç¸®å°æ ¼</button>
    <button id="biggerBtn" class="btn grey">æ”¾å¤§æ ¼</button>
    <button id="dragBtn"   class="btn grey" data-brush="DRAG">æ‹–ç§»</button>
    <button id="eraseBtn"  class="btn grey" data-brush=".">åˆªé™¤</button>
  </div>
</div>

<script>
/* =========================
   Phase 1ï¼šæ ¸å¿ƒéª¨æ¶ï¼ˆåœ°åœ–/èª¿è‰²ç›¤/ç•«æ ¼/æ‹–ç§»/ç¸®æ”¾ï¼‰
   - Canvas + UI
   - è³‡æ–™è¨»å†Šè¡¨ï¼šENTï¼ˆç”Ÿç‰©ï¼‰ã€SPAWNERSï¼ˆåˆ·æ€ªé»â†’æ€ªç‰©ï¼‰ã€TILE_TYPESï¼ˆå»ºç¯‰ï¼‰
   - èª¿è‰²ç›¤è‡ªå‹•ç”Ÿæˆï¼ˆä¾è¨»å†Šè¡¨ï¼‰
   - åœ°åœ–è³‡æ–™çµæ§‹ã€è½ç­†ï¼ˆæ”¾ç½®/åˆªé™¤ï¼‰ã€è¦–åœ–æ‹–ç§»ã€ç¸®æ”¾
   - ç”Ÿç‰©/åˆ·æ€ªé»ï¼šé€šç”¨ spawn/renderã€Œæ¡†æ¶ã€ï¼ˆç›®å‰ä¸å¸¶ä»»ä½•æ€ª/å‹•ç‰©ï¼Œä¹‹å¾Œ Phase 2+ æœƒå¡«ï¼‰
   ========================= */

(()=>{

/* ---------- ç•«å¸ƒèˆ‡ç›¸æ©Ÿ ---------- */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', { alpha:false });
const DPR = Math.max(1, Math.min(3, window.devicePixelRatio||1));
let vw=0,vh=0;
function resize(){ vw=innerWidth; vh=innerHeight; cv.width=Math.floor(vw*DPR); cv.height=Math.floor(vh*DPR); cv.style.width=vw+'px'; cv.style.height=vh+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
resize(); addEventListener('resize', resize);

let TILE = 48;
let VIEW_SCALE = 1, VIEW_MIN=0.5, VIEW_MAX=2.0, VIEW_STEP=0.1;
let camX=0, camY=0;
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function toWorld(cx,cy){ return { x: camX + cx/VIEW_SCALE, y: camY + cy/VIEW_SCALE }; }

/* ---------- è³‡æ–™è¨»å†Šè¡¨ï¼ˆç©ºæ®¼ï¼Œå¾… Phase 2+ å¡«å…¥ç‰©ç¨®/AIï¼‰ ---------- */
const ENT = {
  // ä¹‹å¾Œæœƒç™»è¨˜ï¼š'dragon': {label:'å™´ç«é¾', kind:'monster', ai:'dragon', stats:{...}, render:(ctx,e)=>{...}}
};
const SPAWNERS = {
  // ä¹‹å¾Œæœƒç™»è¨˜åˆ·æ€ªé»ç¨®é¡æ˜ å°„ï¼Œä¾‹å¦‚ï¼š'GD':'dragon'
};
const TILE_TYPES = {
  building: [
    {label:'# åœ°é¢', val:'#', solid:true},
    {label:'^ å°–åˆº', val:'^'},
    {label:'o é‡‘å¹£', val:'o'},
    {label:'S å‡ºç”Ÿ', val:'S'},
  ],
  monsters: [
    // ä¹‹å¾Œç”± ENT è‡ªå‹•é¡å°„é€²ä¾†
  ],
  critters: [
    // ä¹‹å¾Œç”± ENT è‡ªå‹•é¡å°„é€²ä¾†
  ]
};

// å°‡ ENT ä¾ kind æ˜ å°„åˆ°åˆ†é¡ï¼ˆç›®å‰ ENT ç‚ºç©ºï¼ŒUI ä»æœƒé¡¯ç¤ºåˆ†é¡ä½†ç„¡é …ç›®ï¼‰
function computePaletteGroups(){
  const mons=[], crits=[];
  for(const [key,def] of Object.entries(ENT)){
    const item = {label:(def.label||key), val:key};
    if(def.kind==='monster') mons.push(item);
    else if(def.kind==='critter') crits.push(item);
  }
  return {
    building: TILE_TYPES.building.slice(),
    monsters: mons,
    critters: crits
  };
}

/* ---------- åœ°åœ–è³‡æ–™çµæ§‹ ---------- */
let mapW=40, mapH=24;
const DOT='.'; // ç©ºç™½
let tiles = makeEmpty(mapW,mapH);
let startPos = {x:2, y: mapH-14};
seedBasic();

function makeEmpty(w,h){ const a=[]; for(let y=0;y<h;y++) a.push(Array(w).fill(DOT)); return a; }
function seedBasic(){
  // åœ°æ¿
  for(let x=0;x<mapW;x++) tiles[mapH-1][x]='#';
  // èµ·é»/çµ‚é»/å¹¾æšé‡‘å¹£
  startPos = { x:2, y: mapH-6 };
  tiles[startPos.y][startPos.x] = 'S';
  tiles[mapH-2][Math.min(mapW-1, 20)] = 'X';
  tiles[mapH-3][8]='o'; tiles[mapH-6][12]='o';
}

/* ---------- ç”Ÿç‰©/åˆ·æ€ªé»ï¼šé€šç”¨è³‡æ–™èˆ‡æ¸²æŸ“ï¼ˆç›®å‰åªæœ‰å ä½ï¼‰ ---------- */
const entities = [];   // æ™®é€šç”Ÿç‰©ï¼š{type, x,y,w,h, spawnX,spawnY, ...}
const spawners = [];   // åˆ·æ€ªé»ï¼š{gtype, x,y, ...}

function spawnEntity(type, gx, gy, opts={}){
  const w = TILE - 12, h = TILE - 12;
  const e = {
    type,
    spawnX: gx, spawnY: gy,
    x: gx*TILE + (TILE - w)/2,
    y: gy*TILE + (TILE - h),
    w, h,
    ...opts
  };
  entities.push(e);
  return e;
}

function spawnSpawner(gtype, gx, gy, opts={}){
  const s = { gtype, x:gx, y:gy, ...opts };
  spawners.push(s); return s;
}
function renderEntities(){
  for(const e of entities){
    const def = ENT[e.type];
    if(def && typeof def.render==='function'){ def.render(ctx,e); }
    else{ drawPlaceholder(e.x,e.y,e.w,e.h, e.type); }
  }
  for(const s of spawners){
    drawSpawnerPlaceholder(s.x*TILE, s.y*TILE, TILE, TILE, s.gtype||'G?');
  }
}

/* ---------- èª¿è‰²ç›¤ï¼šåˆ†é¡/å‹•æ…‹ tiles ---------- */
const palette = {
  root: document.getElementById('palette'),
  tiles: document.getElementById('palTiles'),
  backBtn: document.getElementById('palBackBtn')
};
let currentCategory = null;
let brush = '#';

function renderCategory(cat){
  currentCategory = cat;
  palette.tiles.innerHTML = '';
  document.querySelectorAll('#palette .pill[data-cat]').forEach(b=>b.classList.remove('active'));
  const catBtn = document.querySelector(`#palette .pill[data-cat="${cat}"]`);
  if (catBtn) catBtn.classList.add('active');

  palette.backBtn.classList.remove('hidden');

  const groups = computePaletteGroups();
  const items = groups[cat] || [];
  if(items.length===0){
    const div=document.createElement('div');
    div.className='tile';
    div.textContent='ï¼ˆæ­¤åˆ†é¡å°šç„¡é …ç›®ï¼‰';
    div.style.opacity=.7;
    palette.tiles.appendChild(div);
  }else{
    for(const item of items){
      const div=document.createElement('div');
      div.className='tile';
      div.setAttribute('data-brush', item.val);
      div.textContent=item.label;
      palette.tiles.appendChild(div);
    }
  }
  refreshActiveBrushUI();
}
function backToCategories(){
  currentCategory = null;
  palette.tiles.innerHTML = '';
  document.querySelectorAll('#palette .pill[data-cat]').forEach(b=>b.classList.remove('active'));
  palette.backBtn.classList.add('hidden');
}
function refreshActiveBrushUI(){
  palette.tiles.querySelectorAll('.tile').forEach(el=>{
    el.classList.toggle('active', el.getAttribute('data-brush')===brush);
  });
}

palette.root.addEventListener('click', (e)=>{
  const catBtn = e.target.closest('.pill[data-cat]');
  if(catBtn){ renderCategory(catBtn.getAttribute('data-cat')); return; }
  if(e.target.id==='palBackBtn'){ backToCategories(); return; }
  const tile = e.target.closest('.tile');
  if(tile){ brush = tile.getAttribute('data-brush'); refreshActiveBrushUI(); }
});

document.getElementById('dragBtn').onclick = ()=>{ brush='DRAG'; refreshActiveBrushUI(); };
document.getElementById('eraseBtn').onclick= ()=>{ brush='.';    refreshActiveBrushUI(); };
document.getElementById('smallerBtn').onclick=()=>{ VIEW_SCALE = Math.max(VIEW_MIN, +(VIEW_SCALE - VIEW_STEP).toFixed(2)); };
document.getElementById('biggerBtn').onclick=()=>{ VIEW_SCALE = Math.min(VIEW_MAX, +(VIEW_SCALE + VIEW_STEP).toFixed(2)); };

// é è¨­é¡¯ç¤ºåˆ†é¡ç¸½è¦½
backToCategories();

/* ---------- ç·¨è¼¯ï¼šè½ç­†/åˆªé™¤ + è¦–åœ–æ‹–ç§» ---------- */
cv.addEventListener('contextmenu', e=>e.preventDefault());
let draggingView=false, dragStart={x:0,y:0}, camStart={x:0,y:0};
let isErasing=false;

cv.addEventListener('pointerdown', e=>{
  if(brush==='DRAG'){
    draggingView=true;
    dragStart={x:e.clientX, y:e.clientY};
    camStart={x:camX, y:camY};
    return;
  }
  isErasing = (e.button===2 || e.ctrlKey || brush==='.');
  paintAtEvent(e);
});
cv.addEventListener('pointermove', e=>{
  if(draggingView && brush==='DRAG'){
    const dx=e.clientX-dragStart.x, dy=e.clientY-dragStart.y;
    camX = clamp(camStart.x - dx/VIEW_SCALE, 0, mapW*TILE - vw/VIEW_SCALE);
    camY = clamp(camStart.y - dy/VIEW_SCALE, 0, mapH*TILE - vh/VIEW_SCALE);
    return;
  }
  if(e.buttons && brush!=='DRAG') paintAtEvent(e);
});
cv.addEventListener('pointerup', ()=>{
  draggingView=false;
});

function paintAtEvent(e){
  const {x,y}=toWorld(e.clientX,e.clientY);
  const gx=Math.floor(x/TILE), gy=Math.floor(y/TILE);
  if(gx<0||gy<0||gx>=mapW||gy>=mapH) return;

  if(isErasing){
    // åˆªé™¤åœ°å¡Š/èµ·é»
    if(tiles[gy][gx]==='S'){ tiles[gy][gx]=DOT; }
    else tiles[gy][gx]=DOT;

    // åˆªé™¤åŒä½ç½®çš„ç”Ÿç‰©/åˆ·æ€ªé»ï¼ˆè‹¥æœªä¾†æœ‰ï¼‰
    for(let i=entities.length-1;i>=0;i--) if(entities[i].spawnX===gx&&entities[i].spawnY===gy) entities.splice(i,1);
    for(let i=spawners.length-1;i>=0;i--) if(spawners[i].x===gx&&spawners[i].y===gy) spawners.splice(i,1);
  }else{
    // æ”¾ç½®ï¼šè‹¥ brush æ˜¯å·²ç™»è¨˜çš„ç”Ÿç‰© -> ç”Ÿæˆï¼›å¦å‰‡è¦–ç‚ºåœ°å¡Š
    if(ENT[brush]){
      // å–®æ ¼åªå…è¨±ä¸€å€‹ç”Ÿç‰©
      for(let i=entities.length-1;i>=0;i--) if(entities[i].spawnX===gx&&entities[i].spawnY===gy) entities.splice(i,1);
      spawnEntity(brush,gx,gy);
    }else if(SPAWNERS[brush]){
      for(let i=spawners.length-1;i>=0;i--) if(spawners[i].x===gx&&spawners[i].y===gy) spawners.splice(i,1);
      spawnSpawner(brush,gx,gy);
    }else{
      // S èµ·é»å”¯ä¸€
      if(brush==='S'){
        for(let y=0;y<mapH;y++) for(let x=0;x<mapW;x++){ if(tiles[y][x]==='S') tiles[y][x]=DOT; }
  startPos = { x: gx, y: gy };
      }
      tiles[gy][gx]=brush;
      if (brush==='S') snapPlayerToStart();
window.dispatchEvent(new CustomEvent('startpos-change', {
  detail: { x: startPos.x, y: startPos.y }
}));
    }
  }
  autoSave();
}

// â˜… æ–°å¢æ•´æ®µï¼šæŠŠç©å®¶ç§»åˆ° startPosï¼ˆSï¼‰ä¸Šï¼Œä¸¦æŠŠé¡é ­ç½®ä¸­ï¼ˆPhase 1 å…§ï¼‰
function snapPlayerToStart(){
  try{
    if (window.__ensurePlayer){
      const p = window.__ensurePlayer(); // æ²’æœ‰å°±æœƒé †ä¾¿ç”Ÿæˆç©å®¶
      const T = TILE;
      p.x = startPos.x*T + (T - p.w)/2;
      p.y = startPos.y*T + (T - p.h);
      p.vx = 0; p.vy = 0;
      p.onGround = false; p.coyote = 0; p.jumpBuf = 0;
    }
    if (window.__centerOn){ window.__centerOn(startPos.x, startPos.y); }
  }catch{}
}


/* ---------- å­˜æª”ï¼ˆPhase 1ï¼šå–®ä¸€ autosaveï¼‰ ---------- */
const SAVE_KEY='dd_skel_phase1';
function exportJSON(){
  return JSON.stringify({
    w:mapW, h:mapH,
    tileRows: tiles.map(r=>r.join('')),
    start: startPos,
    tileSize: TILE,
    // âœ… ä¿å­˜æ›´å¤šæ€ªç‰©ç‹€æ…‹
    entities: entities.map(e=>({
      type: e.type,
      spawnX: e.spawnX, spawnY: e.spawnY,
      x: e.x, y: e.y, w: e.w, h: e.h,
      vx: e.vx||0, vy: e.vy||0, face: e.face||1,
      stats: e.stats ? { ...e.stats } : undefined,
      extra: e.extra || undefined
    })),
    // âœ… ä¿å­˜åˆ·æ€ªé»åƒæ•¸
    spawners: spawners.map(s=>({
      gtype: s.gtype, x: s.x, y: s.y,
      freq: s.freq||8, chance: s.chance||0.5, maxAlive: s.maxAlive||3
    }))
  });
}

function importJSON(txt){
  const d=JSON.parse(txt);
  mapW=d.w; mapH=d.h;
  tiles = d.tileRows.map(r=>r.split(''));
  startPos = d.start || startPos;
  TILE = d.tileSize || TILE;

  // é‡æ–°ç”Ÿæˆ entities
  entities.length=0;
  (d.entities||[]).forEach(e=>{
    const inst = spawnEntity(e.type, e.spawnX, e.spawnY);
    if(!inst) return;
    if(typeof e.x==='number') inst.x = e.x;
    if(typeof e.y==='number') inst.y = e.y;
    if(typeof e.w==='number') inst.w = e.w;
    if(typeof e.h==='number') inst.h = e.h;
    inst.vx = e.vx||0; inst.vy = e.vy||0;
    inst.face = e.face||1;
    if(e.stats) inst.stats = { ...e.stats };
    if(e.extra) inst.extra = e.extra;
  });

  // é‡æ–°ç”Ÿæˆ spawners
  spawners.length=0;
  (d.spawners||[]).forEach(s=>{
    const ss = spawnSpawner(s.gtype, s.x, s.y);
    if(!ss) return;
    ss.freq = s.freq||8;
    ss.chance = s.chance||0.5;
    ss.maxAlive = s.maxAlive||3;
  });
}

function autoSave(){ try{ localStorage.setItem(SAVE_KEY, exportJSON()); }catch{} }
(function(){ const s=localStorage.getItem(SAVE_KEY); if(s){ try{ importJSON(s); }catch{} } })();


// ===== é‡‘å¹£æ’¿å–ï¼šPhase1 ç«¯ =====
window.addEventListener('pickup-tile', (e)=>{
  const { gx, gy, type } = e.detail || {};
  if (gx==null || gy==null) return;
  if (gx<0 || gy<0 || gx>=mapW || gy>=mapH) return;

  if (type === 'coin' && tiles[gy][gx] === 'o') {
    tiles[gy][gx] = '.';   // æ¸…ç©ºè©²æ ¼
    autoSave();            // å­˜æª”è®“å½±å­åœ°åœ–æ›´æ–°
  }
});
// ===== é‡‘å¹£æ’¿å–ï¼šPhase1 end =====

/* ---------- UIï¼šæ–°åœ°åœ–/èªªæ˜ï¼ˆæä¾›å°å¤– APIï¼‰ ---------- */
function __newMap(){
  if(!confirm('å»ºç«‹æ–°åœ°åœ–ï¼Ÿç›®å‰å…§å®¹æœƒè¢«è¦†è“‹ï¼ˆå·²è‡ªå‹•å„²å­˜å¯å†è¼‰å›ï¼‰ã€‚')) return;
  mapW=40; mapH=24; TILE=48; tiles=makeEmpty(mapW,mapH); seedBasic();
  entities.length=0; spawners.length=0;
  camX=0; camY=0; VIEW_SCALE=1;
  if (typeof snapPlayerToStart === 'function') snapPlayerToStart();
  autoSave();
  alert('âœ… å·²å»ºç«‹æ–°åœ°åœ–ï¼');
  requestAnimationFrame(render);
}
window.__newMap = __newMap; // å°å‡ºçµ¦ Phase 3 çš„ã€Œåœ°åœ–ã€é¸å–®ä½¿ç”¨

document.getElementById('helpBtn').onclick=()=>alert(
`Phase 1ï¼ˆéª¨æ¶ï¼‰ï¼š
- ä¸‹æ–¹ã€Œèª¿è‰²ç›¤ã€é¸åˆ†é¡â†’é» tile æ”¾ç½®ï¼›æŒ‰ã€Œåˆªé™¤ã€æˆ–æŒ‰ä½ Ctrl/å³éµå¯æ“¦é™¤ã€‚
- è¦–åœ–ï¼šç”¨ã€Œæ‹–ç§»ã€æ‹‰å‹•ã€æ”¾å¤§/ç¸®å°èª¿æ•´æ ¼å­å¤§å°ï¼ˆç·¨è¼¯è¦–åœ–ç¸®æ”¾ï¼‰ã€‚
- æ­¤éšæ®µæ²’æœ‰ç©å®¶/AI/æˆ°é¬¥ã€‚ä¹‹å¾Œ Phase 2~4 æœƒé€æ­¥åŠ å…¥ã€‚
`
);

/* ---------- ç¹ªåœ– ---------- */
function render(){
  // èƒŒæ™¯
  const g = ctx.createLinearGradient(0,0,0,vh);
  g.addColorStop(0,'#0e1126');
  g.addColorStop(1,'#1a1f3d');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,vw,vh);

  ctx.save();
  ctx.translate(-camX*VIEW_SCALE, -camY*VIEW_SCALE);
  ctx.scale(VIEW_SCALE, VIEW_SCALE);

  // å¯è¦–ç¯„åœ
  const xMin = Math.max(0, Math.floor(camX/TILE)-1);
  const yMin = Math.max(0, Math.floor(camY/TILE)-1);
  const xMax = Math.min(mapW-1, Math.floor((camX+vw/VIEW_SCALE)/TILE)+1);
  const yMax = Math.min(mapH-1, Math.floor((camY+vh/VIEW_SCALE)/TILE)+1);

  // â˜… ç›®å‰æ˜¯å¦ã€ŒéŠç©æ¨¡å¼ã€
  const isPlay = (typeof window.__getMode === 'function' && window.__getMode() === 'play');

  // åœ°å¡Š
  for(let y=yMin; y<=yMax; y++){
    for(let x=xMin; x<=xMax; x++){
      const ch = tiles[y][x], px = x*TILE, py = y*TILE;
      if (ch === '#') {
        ctx.fillStyle = '#3e466e';
        ctx.fillRect(px, py, TILE, TILE);
        // â˜… åªåœ¨ã€Œç·¨è¼¯æ¨¡å¼ã€ç•«å¤–æ¡†ï¼›éŠç©æ¨¡å¼ä¸ç•«ï¼Œé¿å…çœ‹èµ·ä¾†åƒç¶²æ ¼
        if (!isPlay) {
          ctx.strokeStyle = '#5a6494';
          ctx.lineWidth = 2;
          ctx.strokeRect(px+0.5, py+0.5, TILE-1, TILE-1);
        }
      } else if (ch === 'o') {
        drawCoin(px, py);
      } else if (ch === '^') {
        drawSpikes(px, py, TILE, TILE);
      } else if (ch === 'X') {
        drawFlag(px, py);
      } else if (ch === 'S') {
        drawStart(px, py);
      } else if (ch === 'D') {
        drawDoor(px, py);
      } else {
        // â˜… æ–°å¢ï¼šæŠŠæœªçŸ¥å­—å…ƒäº¤çµ¦å¤–æ›ç•«ï¼ˆä¾‹å¦‚æ°´ã€Œ~ã€ï¼‰
        if (typeof window.__drawUnknownTile === 'function') {
          window.__drawUnknownTile(ctx, ch, px, py, TILE);
        }
      }
    }
  }

  // ç”Ÿç‰© / åˆ·æ€ªé»ï¼ˆç›®å‰é¡¯ç¤ºå ä½ï¼‰
  renderEntities();


  // â˜… æ–°å¢ï¼šæˆ°é¬¥ç‰¹æ•ˆï¼ˆåˆ€å…‰/ç®­çŸ¢ç­‰ï¼‰
  if (typeof window.__drawCombat === 'function') {
    window.__drawCombat(ctx);
  }




  // â˜… ç¶²æ ¼ç·šï¼šåªåœ¨ã€Œç·¨è¼¯æ¨¡å¼ã€é¡¯ç¤ºï¼ˆéŠç©æ¨¡å¼éš±è—ï¼‰
  if (!isPlay) {
    ctx.strokeStyle = 'rgba(255,255,255,.08)'; // æƒ³æ¸¬è©¦å¯è¦‹åº¦å¯è‡¨æ™‚æ”¹æˆ .18
    for (let x = xMin; x <= xMax + 1; x++) {
      ctx.beginPath();
      ctx.moveTo(x * TILE, yMin * TILE);
      ctx.lineTo(x * TILE, (yMax + 1) * TILE);
      ctx.stroke();
    }
    for (let y = yMin; y <= yMax + 1; y++) {
      ctx.beginPath();
      ctx.moveTo(xMin * TILE, y * TILE);
      ctx.lineTo((xMax + 1) * TILE, y * TILE);
      ctx.stroke();
    }
  }

  // â˜… ä¸€å®šè¦é‚„åŸåº§æ¨™èˆ‡ç‹€æ…‹
  ctx.restore();
}
/* ---------- åŸºç¤åœ–å¡Šç¹ªè£½ ---------- */
function drawCoin(x,y){
  ctx.beginPath(); ctx.arc(x+TILE/2, y+TILE/2, 10, 0, Math.PI*2);
  ctx.fillStyle='#ffd34e'; ctx.fill();
  ctx.strokeStyle='#e5b93c'; ctx.stroke();
}
function drawSpikes(x,y,w,h){
  ctx.fillStyle='#ff4d6d';
  const n=4; for(let i=0;i<n;i++){ const bx=x+i*(w/n);
    ctx.beginPath(); ctx.moveTo(bx,y+h); ctx.lineTo(bx+(w/n)/2,y+8); ctx.lineTo(bx+(w/n),y+h); ctx.closePath(); ctx.fill();
  }
}
function drawFlag(x,y){
  ctx.fillStyle='#5a6494'; ctx.fillRect(x+22,y+8,4,TILE-8);
  ctx.beginPath(); ctx.moveTo(x+26,y+12); ctx.lineTo(x+48,y+20); ctx.lineTo(x+26,y+28); ctx.closePath();
  ctx.fillStyle='#ffd34e'; ctx.fill();
}
function drawStart(x,y){
  ctx.fillStyle='#21d07a'; ctx.fillRect(x+8,y+8,TILE-16,TILE-16);
  ctx.fillStyle='#042'; ctx.fillRect(x+12,y+12,TILE-24,10);
}
function drawDoor(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='#2e3a7a'; ctx.fillRect(8,4,TILE-16,TILE-8);
  ctx.fillStyle='#8ab4f8'; ctx.fillRect(12,8,TILE-24,TILE-20);
  ctx.strokeStyle='#b4c8ff'; ctx.strokeRect(11.5,7.5,TILE-23,TILE-19);
  ctx.restore();
}
function drawPlaceholder(x,y,w,h,txt='?'){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='#ffffff55'; ctx.strokeRect(0.5,0.5,w-1,h-1);
  ctx.fillStyle='#fff'; ctx.font='12px ui-sans-serif'; ctx.fillText(txt, 6, 16);
  ctx.restore();
}
function drawSpawnerPlaceholder(x,y,w,h,txt='G?'){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='#8a6cff'; ctx.fillRect(10,10,w-20,h-20);
  ctx.fillStyle='#111'; ctx.fillRect(16,16,w-32,h-32);
  ctx.fillStyle='#fff'; ctx.font='12px ui-sans-serif'; ctx.fillText(txt, 14, 24);
  ctx.restore();
}

/* ---------- ä¸»å¾ªç’°ï¼ˆPhase 1 åªæœ‰æ¸²æŸ“ï¼‰ ---------- */
function loop(){ render(); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* ---------- å°å‡ºä¸€äº›å…¨åŸŸï¼ˆæ–¹ä¾¿ Phase 2+ ç–Šä»£å­˜å–ï¼‰ ---------- */
Object.assign(window, {
  ENT, SPAWNERS, TILE_TYPES,
  spawnEntity, spawnSpawner,
  // â˜… æ—¢æœ‰ï¼šç½®ä¸­é¡é ­åˆ°ã€Œæ ¼åº§æ¨™ã€ï¼ˆgx, gyï¼‰

  // â˜… æ–°å¢ï¼šæ ¹æ“š type ç§»é™¤æ‰€æœ‰å¯¦é«”ï¼ˆé›¢é–‹éŠç©æ™‚ç”¨ï¼‰
  __despawnByType(type){
    for (let i = entities.length - 1; i >= 0; i--) {
      if (entities[i].type === type) entities.splice(i, 1);
    }
  },

  __centerOn(gx, gy){
    const cx = gx*TILE + TILE/2;
    const cy = gy*TILE + TILE/2;
    camX = clamp(cx - vw/(2*VIEW_SCALE), 0, mapW*TILE - vw/VIEW_SCALE);
    camY = clamp(cy - vh/(2*VIEW_SCALE), 0, mapH*TILE - vh/VIEW_SCALE);
  },

  // â˜… æ–°å¢ï¼šä»¥ã€Œä¸–ç•Œåº§æ¨™ï¼ˆåƒç´ ï¼‰ã€ç¬é–“ç½®ä¸­é¡é ­
  __centerOnWorld(wx, wy){
    camX = clamp(wx - vw/(2*VIEW_SCALE), 0, mapW*TILE - vw/VIEW_SCALE);
    camY = clamp(wy - vh/(2*VIEW_SCALE), 0, mapH*TILE - vh/VIEW_SCALE);
  },

  // â˜… æ–°å¢ï¼ˆå¹³æ»‘ç‰ˆï¼‰ï¼šä»¥ã€Œä¸–ç•Œåº§æ¨™ï¼ˆåƒç´ ï¼‰ã€å¹³æ»‘ç½®ä¸­
  //    alpha è¶Šå¤§è¶Šè·Ÿç·Šï¼Œå»ºè­° 0.12 ~ 0.22
  __centerOnWorldSmooth(wx, wy, alpha = 0.16){
    const tx = clamp(wx - vw/(2*VIEW_SCALE), 0, mapW*TILE - vw/VIEW_SCALE);
    const ty = clamp(wy - vh/(2*VIEW_SCALE), 0, mapH*TILE - vh/VIEW_SCALE);
    camX += (tx - camX) * alpha;
    camY += (ty - camY) * alpha;
  }
});
})(); 

</script>
<script>
/* =========================
   Phase 2ï¼šç©å®¶èˆ‡ç‰©ç† + AI æ´¾ç™¼å™¨ + åˆ·æ€ªéª¨æ¶
   - ç©å®¶ï¼ˆéµç›¤ï¼‰ï¼šå·¦å³ç§»å‹•ã€è·³èºã€é‡åŠ›ã€ç“¦ç‰‡ç¢°æ’
   - ENT è¨»å†Šï¼šplayerï¼ˆè³‡æ–™é©…å‹•ï¼‰ã€AI ç­–ç•¥è¡¨éª¨æ¶
   - åˆ·æ€ªç³»çµ±éª¨æ¶ï¼šç”± localStorage spawners è®€å…¥ï¼ˆç›®å‰ç„¡æ€ªå‰‡ä¸æœƒç”Ÿï¼‰
   - ä¸ä¿®æ”¹ Phase1 å…§éƒ¨è®Šæ•¸ï¼šæ”¹è®€ autosave å»ºç«‹ã€Œå½±å­åœ°åœ–ã€åšç¢°æ’
   ========================= */
(() => {
  "use strict";

  /* ---------- èˆ‡ Phase1 æºé€šçš„æ©‹æ¥ ---------- */



// ===== é€šç”¨ï¼šæŠŠç©å®¶é€å›èµ·é»ï¼ˆé‡ç”Ÿï¼‰ =====
function __respawnToStart(e, showToast = true){
  loadWorldSnapshot(true);
  const sPos = world.start, T = world.tileSize;
  e.x = sPos.x*T + (T - e.w)/2;
  e.y = sPos.y*T + (T - e.h);
  e.vx = e.vy = 0;
  e.onGround = false; e.coyote = 0; e.jumpBuf = 0;

  // å›æ»¿è¡€ï¼ˆå¯æ”¹ï¼šå›åŠè¡€ç­‰ï¼‰
  const stats = (ENT.player && ENT.player.stats) || (e.stats ||= {maxHp:100,hp:100});
  stats.hp = stats.maxHp;

  if (showToast){
    const box = document.getElementById('toastBox');
    if (box){
      box.textContent = 'ğŸ’€ å€’åœ°ï¼Œå›åˆ°èµ·é»';
      box.style.background = '#000b';
      box.style.padding = '8px 12px'; box.style.borderRadius = '8px';
      clearTimeout(window.__die_toast);
      window.__die_toast = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
    }
  }
}

// ===== é€šç”¨ï¼šå°ç©å®¶é€ æˆå‚·å®³ï¼ˆå«ç„¡æ•µæ™‚é–“ã€æ“Šé€€ã€æ­»äº¡â†’é‡ç”Ÿï¼‰ =====
function __hurtPlayer(e, opts = {}){
  const { dmg=1, iFrames=0.8, kx=0, ky=-520, fx=true, color='rgba(255,100,120,0.95)' } = opts;

  // ç„¡æ•µæ™‚é–“å€’æ•¸
  e._hurtTimer = Math.max(0, (e._hurtTimer || 0) - (opts.dt || 0));

  if (e._hurtTimer > 0) return false; // é‚„åœ¨ç„¡æ•µï¼Œä¸åƒå‚·å®³

  const s = (ENT.player && ENT.player.stats) || (e.stats ||= {maxHp:100,hp:100});
  s.hp = Math.max(0, (s.hp|0) - Math.max(0, dmg|0));

  e._hurtTimer = iFrames;
  e._flash = 10;

  // æ“Šé€€
  if (kx) e.vx = kx;
  if (typeof ky === 'number') e.vy = ky;

  // å—æ“Š FXï¼ˆå¯é¸ï¼‰
  if (fx && window.SKIN && SKIN.spawnFx){
    for (let i=0;i<6;i++){
      SKIN.spawnFx({
        x: e.x + e.w/2 + (Math.random()*12-6),
        y: e.y + e.h/2 + (Math.random()*8-4),
        vx: (Math.random()*160-80),
        vy: (-60 - Math.random()*120),
        r: 4, color, life: 0.5, maxLife: 0.5
      });
    }
  }

  // æ­»äº¡ â†’ å›èµ·é»
  if (s.hp <= 0){
    __respawnToStart(e, true);
    return true;
  }
  return false;
}

// å°å‡ºçµ¦å…¶ä»–æ¨¡çµ„/æ€ªç‰© AI ç›´æ¥å‘¼å«ï¼ˆå¯é¸ï¼‰
window.__respawnPlayer = ()=>{ const p = (window.__ensurePlayer && window.__ensurePlayer()); if(p) __respawnToStart(p,true); };
window.__hurtPlayer = (opts={})=>{ const p = (window.__ensurePlayer && window.__ensurePlayer()); if(p) return __hurtPlayer(p, opts); return false; };
//æ­»äº¡é‚è¼¯çµæŸ


  const SAVE_KEY = 'dd_skel_phase1';              // Phase1 çš„ autosave key
  const ENT = window.ENT || {};                   // Phase1 æš´éœ²
  const SPAWNERS = window.SPAWNERS || {};         // Phase1 æš´éœ²
  const spawnEntity = window.spawnEntity;         // Phase1 æš´éœ²

  /* ---------- å½±å­åœ°åœ–ï¼ˆå¾ autosave å–å‡ºï¼Œç”¨æ–¼ç¢°æ’/èµ·é»ï¼‰ ---------- */
  let world = null, _rawCache = null;
  function loadWorldSnapshot(force=false){
    const raw = localStorage.getItem(SAVE_KEY) || '';
    if (!force && raw === _rawCache) return world;
    _rawCache = raw;
    try{
      const d = JSON.parse(raw || '{}');
      world = {
        w: d.w || 40,
        h: d.h || 24,
        tileSize: d.tileSize || 48,
        tiles: (d.tileRows||[]).map(r=>r.split('')),
        spawners: d.spawners || [],
        start: d.start || {x:2, y:Math.max(0,(d.h||24)-6)}
      };
    }catch{
      world = { w:40, h:24, tileSize:48, tiles:[], spawners:[], start:{x:2,y:18} };
    }
    return world;
  }
  loadWorldSnapshot(true);

/* ---------- åœ°åœ–æŸ¥è©¢ ---------- */
function tileAtGX(gx,gy){
  if(!world) return '.';
  if (gx<0 || gy<0 || gx>=world.w || gy>=world.h) return '#'; // ç‰†å¤–ç•¶å¯¦å¿ƒ
  const row = world.tiles[gy];
  if(!row) return '.';
  return row[gx] || '.';
}

function isSolidAtRect(rx,ry,rw,rh){
  const T = world.tileSize;
  const x0 = Math.floor(rx/T), x1 = Math.floor((rx+rw-1)/T);
  const y0 = Math.floor(ry/T), y1 = Math.floor((ry+rh-1)/T);
  for(let y=y0;y<=y1;y++){
    for(let x=x0;x<=x1;x++){
      const ch = tileAtGX(x,y);
      // â˜… æ–°ç‰ˆåˆ¤æ–·ï¼šæ”¯æ´å¤–æ› Tile API
      if (typeof window.__tileIsSolid === 'function') {
        if (window.__tileIsSolid(ch)) return true;
      } else if (ch === '#') {
        return true;
      }
    }
  }
  return false;
}

  /* ---------- ç©å®¶å®šç¾©ï¼ˆè³‡æ–™é©…å‹• ENTï¼‰ ---------- */
  ENT.player = {
    label: 'ç©å®¶',
    kind:  'player',
    ai:    '__player',         // äº¤çµ¦ AI ç­–ç•¥è¡¨ä¸­çš„ __player è™•ç†
    stats: { maxHp:100, hp:100, atk:10, def:2, spd:360, jump:820 },
    render(ctx, e){
      const t = performance.now()/1000;
      const W = Math.max(e.w, world.tileSize*0.6);
      const H = Math.max(e.h, world.tileSize*0.95);
      // èµ°è·¯å¾®å¹…èµ·ä¼
      const bob = (e.onGround ? Math.sin(t*8)*1.8 : Math.sin(t*4)*0.6);
      const cx = e.x + e.w/2, cy = e.y + e.h;

      ctx.save();
      ctx.translate(cx, cy + bob);
      ctx.scale(e.face>0?1:-1, 1);

      // ç°¡æ˜“èº«å½¢
      ctx.fillStyle = '#4a86e8';                      // è—å¤–è¡£
      ctx.fillRect(-W*0.25, -H*0.85, W*0.5, H*0.6);
      ctx.fillStyle = '#f2f5f9';                      // ç™½è¤²
      ctx.fillRect(-W*0.20, -H*0.25, W*0.4, H*0.25);
      ctx.fillStyle = '#ffd34e';                      // å°ç‹å† é»ç¶´
      ctx.beginPath();
      ctx.moveTo(-W*0.18, -H*0.85);
      ctx.lineTo(0, -H*0.95);
      ctx.lineTo(W*0.18, -H*0.85);
      ctx.closePath(); ctx.fill();

      ctx.restore();

      // HP æ¢ï¼ˆç°¡æ˜“ï¼Œæ­£å¼ HUD ç•™åˆ° Phase3ï¼‰
      const s = ENT.player.stats;
      const pct = Math.max(0, Math.min(1, s.hp/s.maxHp));
      const bw = 40, bh = 5;
      const bx = e.x + (e.w - bw)/2, by = e.y - 8;
      ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(bx,by,bw,bh);
      ctx.fillStyle = pct>0.5? '#37e3a1' : pct>0.25? '#ffd34e' : '#ff6b6b';
      ctx.fillRect(bx,by,bw*pct,bh);
    }
  };

  /* ---------- ç”Ÿæˆç©å®¶ï¼ˆå¾ S èµ·é»ï¼‰ ---------- */
  let PLAYER = null;
  function ensurePlayer(){
    loadWorldSnapshot(); // å–æœ€æ–°
    if (PLAYER && typeof PLAYER.x === 'number') return PLAYER;
    const s = world.start || {x:2,y:world.h-6};
    // spawnEntity éœ€æ ¼åº§æ¨™ï¼Œç”¢ç”Ÿå¾Œå›å‚³çš„ç‰©ä»¶å°±æ˜¯å…§éƒ¨ entities ä¸­çš„åŒä¸€åƒè€ƒ
    PLAYER = spawnEntity('player', s.x, s.y, {
      vx:0, vy:0, w:28, h:40,
      onGround:false, coyote:0, jumpBuf:0, face:1,
  stats: ENT.player.stats
});

    return PLAYER;
  }

  /* ---------- æ§åˆ¶èˆ‡æ¨¡å¼ ---------- */
  let mode='edit', running=false;
  const keys = { left:false, right:false, jump:false };

  // å»ºç«‹æ¨¡å¼æŒ‰éˆ•ï¼ˆæ’å…¥åˆ° #uiTop å³å´ï¼‰
  const uiTop = document.getElementById('uiTop');
  const modeBtn = document.createElement('button');
  modeBtn.id='modeBtn'; modeBtn.className='btn';
  modeBtn.textContent='åˆ‡åˆ°ï¼šéŠç©æ¨¡å¼';
  uiTop.appendChild(modeBtn);

  // å»ºç«‹é€æ˜é®ç½©ï¼ŒPlay æ™‚æ“‹ä½ç•«å¸ƒç·¨è¼¯æ“ä½œ
  const playShield = document.createElement('div');
  Object.assign(playShield.style, {
    position:'fixed', left:0, top:0, right:0, bottom:0,
    zIndex:1, pointerEvents:'none', background:'transparent'
  });
  document.body.appendChild(playShield);

playShield.id = 'playShield';

// å°å¤–å…¬å¸ƒä¸€å€‹ç©©å®šçš„æ¨¡å¼ç‹€æ…‹ï¼ˆçµ¦ Phase 3 ç”¨ï¼‰
window.__modeState = { value:'edit' };
function setMode(next){
  if(next==='play'){
    window.__modeState.value = 'play';
    mode = 'play'; running = true;
    modeBtn.textContent = 'åˆ‡åˆ°ï¼šç·¨è¼¯æ¨¡å¼';
    playShield.style.pointerEvents = 'auto';

    // â˜… åªåœ¨é€²å…¥ Play æ‰ç”Ÿæˆç©å®¶
    const p = ensurePlayer();

    // é€²å…¥ Play æ™‚ç½®ä¸­åˆ°ç©å®¶
    if (p && window.__centerOn) {
      const T = world.tileSize;
      const gx = Math.floor((p.x + p.w/2) / T);
      const gy = Math.floor((p.y + p.h/2) / T);
      window.__centerOn(gx, gy);
    }

  } else {
    window.__modeState.value = 'edit';
    mode = 'edit'; running = false;
    modeBtn.textContent = 'åˆ‡åˆ°ï¼šéŠç©æ¨¡å¼';
    playShield.style.pointerEvents = 'none';

    // â˜… å›åˆ°ç·¨è¼¯æ¨¡å¼ï¼šæŠŠç©å®¶å¯¦é«”ç§»é™¤ï¼Œé¿å…åœ¨ç·¨è¼¯æ™‚è¢«ç•«æ ¼å½±éŸ¿
    if (window.__despawnByType) window.__despawnByType('player');
    PLAYER = null; // æ–·é–‹åƒè€ƒï¼Œç¢ºä¿ä¸‹æ¬¡ Play æœƒé‡æ–°ç”Ÿæˆ
  }

  // é€šçŸ¥å…¶ä»–éšæ®µï¼ˆPhase 3ï¼‰ç›®å‰æ¨¡å¼
  window.dispatchEvent(new CustomEvent('modechange',{ detail:{ mode } }));
}
window.__setMode = setMode;
window.__getMode = () => window.__modeState.value;

modeBtn.onclick = ()=> setMode(mode==='edit' ? 'play' : 'edit');

// â˜… æ–°å¢ï¼šç•¶ Phase 1 èªªã€Œèµ·é»æ”¹äº†ã€â†’ ç«‹åˆ»æŠŠç©å®¶æ¬åˆ°æ–°èµ·é»ä¸¦ç½®ä¸­é¡é ­
window.addEventListener('startpos-change', (e)=>{
  // â˜… åªæœ‰åœ¨éŠç©æ¨¡å¼æ‰è™•ç†ç©å®¶
  if (window.__getMode && window.__getMode() !== 'play') return;

  const p = ensurePlayer();           // ç¢ºä¿ç©å®¶å­˜åœ¨ï¼ˆåªæœ‰ play æœƒçœŸçš„ç”Ÿæˆï¼‰
  loadWorldSnapshot(true);            // å–æœ€æ–°ç‰ˆ start/tileSize
  const T = world.tileSize;
  const s = e.detail || world.start;

  // æ”¾åˆ° S çš„ä¸Šé¢
  p.x = s.x*T + (T - p.w)/2;
  p.y = s.y*T + (T - p.h);
  p.vx = 0; p.vy = 0;
  p.onGround = false; p.coyote = 0; p.jumpBuf = 0;

  // ç½®ä¸­é¡é ­
  if (window.__centerOn) window.__centerOn(s.x, s.y);
});

// è®“èˆŠå‡½å¼ä¹Ÿèµ°æ–°é‚è¼¯ï¼ˆä¿ç•™ç›¸å®¹æ€§ï¼‰
function enterPlay(){ setMode('play'); }
function enterEdit(){ setMode('edit'); }


  // éµç›¤
addEventListener('keydown', (e)=>{
  if (mode !== 'play') return;

  if (e.code === 'ArrowLeft'  || e.code === 'KeyA') keys.left  = true;
  if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;

  // â˜… åªåœ¨éé‡è¤‡ keydown æ™‚çŒä¸€æ¬¡ jumpBufï¼Œé¿å…é•·æŒ‰é€ æˆç©ºä¸­å†è·³
  if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
    if (!e.repeat && PLAYER) PLAYER.jumpBuf = 0.14;
    keys.jump = true;
  }
});

addEventListener('keyup', (e)=>{
  if (e.code === 'ArrowLeft'  || e.code === 'KeyA') keys.left  = false;
  if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
  if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') keys.jump = false;
});

  /* ---------- ç‰©ç†å·¥å…· ---------- */
  const GRAVITY = 2400;
  function moveWithCollisions(o, dt){
    if(!world) return;

    const T = world.tileSize;

    // æ°´å¹³
    let nx = o.x + o.vx*dt;
    if(!isSolidAtRect(nx, o.y, o.w, o.h)){
      o.x = nx;
    }else{
      const dir = Math.sign(o.vx)||1;
      let px = o.x;
      while(!isSolidAtRect(px+dir, o.y, o.w, o.h)) px += dir;
      o.x = px; o.vx = 0;
    }
    // å‚ç›´
    let ny = o.y + o.vy*dt;
    o.onGround = false;
    if(!isSolidAtRect(o.x, ny, o.w, o.h)){
      o.y = ny;
    }else{
      const dir = Math.sign(o.vy)||1;
      let py = o.y;
      while(!isSolidAtRect(o.x, py+dir, o.w, o.h)) py += dir;
      o.y = py;
      if(dir>0) o.onGround = true;
      o.vy = 0;
    }
    // ä¸–ç•Œé‚Šç•Œï¼ˆé˜²å‘†ï¼‰
    const maxX = world.w*T - o.w, maxY = world.h*T - o.h;
    o.x = Math.max(0, Math.min(maxX, o.x));
    o.y = Math.max(0, Math.min(maxY, o.y));
  }

  /* ---------- AI ç­–ç•¥è¡¨ï¼ˆéª¨æ¶ï¼‰ ---------- */
  const AI = {
    // ç©å®¶ï¼šéµç›¤æ§åˆ¶ + åŸºç¤è·³èºç·©è¡/åœŸç‹¼æ™‚é–“
    '__player'(e, dt){
      const s = ENT.player.stats;
      const MOVE = s.spd, JUMP = s.jump;



// --- å…¨åŸŸæ­»äº¡æª¢æŸ¥ï¼šHP <= 0 å°±å›åˆ°å‡ºç”Ÿé» ---
if ((s.hp|0) <= 0) {
  try{ loadWorldSnapshot(true); }catch{}
  const T = world.tileSize, S = world.start;
  e.x = S.x*T + (T - e.w)/2;
  e.y = S.y*T + (T - e.h);
  e.vx = e.vy = 0;
  e.onGround = false; e.coyote = 0; e.jumpBuf = 0;
  s.hp = s.maxHp;  // é‡ç”Ÿå›æ»¿
  // å¯é¸æç¤º
  const box = document.getElementById('toastBox');
  if (box){
    box.textContent = 'ğŸ’€ å€’åœ°ï¼Œå›åˆ°èµ·é»';
    box.style.background = '#000b';
    box.style.padding = '8px 12px'; box.style.borderRadius = '8px';
    clearTimeout(window.__die_toast);
    window.__die_toast = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
  }
  return; // æœ¬å¹€åˆ°æ­¤çµæŸ
}


      // æ›´æ–°ä¸–ç•Œå¿«ç…§ï¼ˆç·¨è¼¯æ™‚æœƒè®Šå‹•ï¼‰
      _accumSnap += dt;
      if(_accumSnap>=0.5){ loadWorldSnapshot(); _accumSnap = 0; }

      let ax = 0;
      if(keys.left)  ax -= 1;
      if(keys.right) ax += 1;
      e.vx = ax * MOVE;
      if(ax) e.face = ax>0 ? 1 : -1;

      // å‚ç›´é‹å‹•
      e.vy += GRAVITY * dt;
      if(e.vy > 2000) e.vy = 2000;

      // é‡æ–°åµæ¸¬æ˜¯å¦è¸©åœ¨åœ°é¢ï¼ˆé¿å…ç«™å®šæ™‚ onGround è¢«æ¸…æ‰ï¼‰
      e.onGround = isSolidAtRect(e.x, e.y + 1, e.w, e.h);

      // è·³èºï¼ˆå–®è·³ï¼›åœç”¨åœŸç‹¼ï¼‰
      e.jumpBuf = Math.max(0, e.jumpBuf - dt);
      if (e.onGround && e.jumpBuf > 0) {
        e.vy = -JUMP;
        e.onGround = false;
        e.jumpBuf = 0;
      }

      // é¬†é–‹è·³èºéµï¼Œå‰Šé ‚
      // é¬†é–‹è·³èºéµï¼Œå‰Šé ‚ï¼ˆä½†åœ¨æ°´ä¸­ä¸å‰Šï¼‰
      if (!keys.jump && !e._inWater && e.vy < -180) e.vy = -180;


      // å®Œå…¨ä¸ä½¿ç”¨ coyote
      e.coyote = 0;

      moveWithCollisions(e, dt);

      // ç¢°æ’å¾Œå†æª¢æŸ¥ä¸€æ¬¡åœ°é¢ç‹€æ…‹
      e.onGround = isSolidAtRect(e.x, e.y + 1, e.w, e.h);



// ===== å°–åˆºå‚·å®³ + é‡‘å¹£æ’¿å–ï¼ˆæ•´æ®µæ›¿æ›é€™è£¡ï¼‰ =====
const gx = Math.floor((e.x + e.w/2)/world.tileSize);
const gy = Math.floor((e.y + e.h/2)/world.tileSize);

// ç„¡æ•µå€’æ•¸ï¼ˆé¿å…é€£çºŒåƒå‚·å®³ï¼‰
e._hurtTimer = Math.max(0, (e._hurtTimer||0) - dt);

// ---------- 1) å°–åˆºï¼šæ‰£è¡€ / ç„¡æ•µ / å½ˆé–‹ / æ­»äº¡é‡ç”Ÿ ----------
if (tileAtGX(gx, gy) === '^' && e._hurtTimer === 0) {
  const s = ENT.player.stats;          // ç©å®¶æ•¸å€¼ï¼ˆHUD ç”¨é€™ä»½ï¼‰
  const DMG = 25;                       // å°–åˆºå‚·å®³ï¼ˆè‡ªè¡Œèª¿æ•´ï¼‰
  s.hp = Math.max(0, s.hp - DMG);       // æ‰£è¡€
  e._hurtTimer = 0.8;                   // ç„¡æ•µæ™‚é–“ï¼ˆç§’ï¼‰
  e._flash = 10;                        // ï¼ˆå¯é¸ï¼‰çµ¦ render é–ƒçˆç”¨

  // å½ˆé–‹ï¼šä¾é¢å‘åšæ°´å¹³æ“Šé€€
  const knockDir = (e.face >= 0 ? -1 : 1);
  e.vy = -520;
  e.vx = 240 * knockDir;

  // å—æ“Šç‰¹æ•ˆï¼ˆå¯é¸ï¼‰
  try{
    if (window.SKIN && SKIN.spawnFx) {
      for (let i=0;i<6;i++){
        SKIN.spawnFx({
          x: e.x + e.w/2 + (Math.random()*12-6),
          y: e.y + e.h/2 + (Math.random()*8 -4),
          vx: (Math.random()*160-80),
          vy: (-60 - Math.random()*120),
          r: 4, color: 'rgba(255,100,120,0.95)', life: 0.5, maxLife: 0.5
        });
      }
    }
  }catch{}

  // æ­»äº¡è™•ç†ï¼šå›èµ·é»ä¸¦å›æ»¿è¡€
  if (s.hp <= 0) {
    const sPos = world.start, T = world.tileSize;
    e.x = sPos.x*T + (T - e.w)/2;
    e.y = sPos.y*T + (T - e.h);
    e.vx = e.vy = 0;
    e.onGround = false; e.coyote = 0; e.jumpBuf = 0;
    s.hp = s.maxHp;                        // é‡ç”Ÿå›æ»¿

    // æç¤º
    const box = document.getElementById('toastBox');
    if (box){
      box.textContent = 'ğŸ’€ å€’åœ°ï¼Œå›åˆ°èµ·é»';
      box.style.background = '#000b';
      box.style.padding = '8px 12px'; box.style.borderRadius = '8px';
      clearTimeout(window.__die_toast);
      window.__die_toast = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
    }
  }
}

// ---------- 2) é‡‘å¹£ï¼šæ’¿èµ· +1ï¼Œæ¸…æ‰åœ°åœ–è©²æ ¼ ----------
if (tileAtGX(gx, gy) === 'o') {
  // èƒŒåŒ… +1
  const INV = window.INVENTORY || (window.INVENTORY = { meat:0, loot:0, coins:0 });
  INV.coins = (INV.coins|0) + 1;
  if (typeof window.refreshBag === 'function') window.refreshBag();

  // é€šçŸ¥ Phase1 æŠŠè©²æ ¼æ¸…ç©º & autosaveï¼ˆè‹¥æ²’æ›ç›£è½ä¹Ÿä¸æœƒæ‹‹éŒ¯ï¼‰
  try{
    window.dispatchEvent(new CustomEvent('pickup-tile', { detail:{ gx, gy, type:'coin' }}));
  }catch{}

  // ç«‹åˆ»åˆ·æ–°å½±å­åœ°åœ–å¿«ç…§ï¼Œé¿å…ä¸‹ä¸€å¹€åˆåˆ¤åˆ° 'o'
  try{ if (typeof loadWorldSnapshot === 'function') loadWorldSnapshot(true); }catch{}

  // æç¤º
  const box = document.getElementById('toastBox');
  if (box){
    box.textContent = 'ğŸª™ +1';
    box.style.background = '#000b';
    box.style.padding = '8px 12px'; box.style.borderRadius='8px';
    clearTimeout(window.__coin_toast);
    window.__coin_toast = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 600);
  }
}
// ===== å°–åˆºå‚·å®³ + é‡‘å¹£æ’¿å–ï¼ˆæ•´æ®µæ›¿æ›åˆ°é€™è£¡çµæŸï¼‰ =====
// ===== é‡‘å¹£æ’¿å–ï¼šPhase2 åµæ¸¬ =====
if (tileAtGX(gx, gy) === 'o') {
  // 1) åŠ å…¥èƒŒåŒ…
  const INV = window.INVENTORY || (window.INVENTORY = { meat:0, loot:0, coins:0 });
  INV.coins = (INV.coins|0) + 1;
  if (typeof window.refreshBag === 'function') window.refreshBag();

  // 2) é€šçŸ¥ Phase1 æ¸…ç©ºè©²æ ¼
  window.dispatchEvent(new CustomEvent('pickup-tile', { detail:{ gx, gy, type:'coin' }}));

  // 3) ç«‹å³åˆ·æ–°å½±å­åœ°åœ–ï¼Œé¿å…ä¸‹ä¸€å¹€é‚„åˆ¤åˆ° 'o'
  if (typeof loadWorldSnapshot === 'function') loadWorldSnapshot(true);

  // 4) æç¤ºæ–‡å­—
  const box = document.getElementById('toastBox');
  if (box){
    box.textContent = 'ğŸª™ +1';
    box.style.background = '#000b';
    box.style.padding = '8px 12px';
    box.style.borderRadius = '8px';
    clearTimeout(window.__coin_toast);
    window.__coin_toast = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 600);
  }
}
// ===== é‡‘å¹£æ’¿å–ï¼šPhase2 end =====



    },




    // æ—¥å¾Œç”¨ï¼šä¸€èˆ¬æ€ªï¼ˆä¸ç”¨ç¾åœ¨ï¼‰
    'idle'(e, dt){ /* ç«™è‘—ä¸å‹•éª¨æ¶ */ },
    'walker'(e, dt){ /* å·¦å³å·¡é‚éª¨æ¶ */ },
    'dragon'(e, dt){ /* å™´ç«éª¨æ¶ï¼ˆPhase4 å¯¦ä½œï¼‰ */ }
  };

  /* ---------- åˆ·æ€ªé»éª¨æ¶ï¼ˆè®€ autosave spawnersï¼‰ ---------- */
  let _spawnerStates = []; // {x,y,gtype, timer}
  function rebuildSpawners(){
    loadWorldSnapshot();
    _spawnerStates = (world.spawners||[]).map(s=>({
      x:s.x, y:s.y, gtype:s.gtype, timer:0,
      freq: s.freq || 8, chance: s.chance || 0.5, maxAlive: s.maxAlive || 3
    }));
  }
  rebuildSpawners();

  function updateSpawners(dt){
    // ç›®å‰æ²’æœ‰ä»»ä½•æ€ªç‰© ENT è¨»å†Šï¼Œæ‰€ä»¥é€™æ®µåªæ˜¯éª¨æ¶ï¼Œä¸æœƒç”¢ç”Ÿæ±è¥¿
    for(const st of _spawnerStates){
      st.timer += dt;
      if(st.timer < st.freq) continue;
      st.timer = 0;
      if(Math.random() >= st.chance) continue;
      const spawnKind = SPAWNERS[st.gtype]; // ä¾‹å¦‚ 'GD' -> 'dragon'
      if(!spawnKind) continue;
      if(!ENT[spawnKind]) continue;         // å°šæœªè¨»å†Šè©²æ€ªç‰©
      spawnEntity(spawnKind, st.x, st.y, { spawnerKey:`${st.x},${st.y}` });
    }
  }

  /* ---------- æ›´æ–°ä¸»è¿´åœˆï¼ˆåªåšé‚è¼¯ï¼›Phase1 çš„ render ä»ç”±å…¶ rAF è™•ç†ï¼‰ ---------- */
  let _lastTs = 0, _accumSnap = 0;
  function tick(ts){
    const dt = Math.min(0.033, _lastTs ? (ts - _lastTs)/1000 : 0);
    _lastTs = ts;

    if(running){
      const p = ensurePlayer();
      // æ´¾ç™¼ç©å®¶ AIï¼ˆå…¶ä»–ç”Ÿç‰©ç­‰å¾ŒçºŒéšæ®µå–å¾— entity é™£åˆ—å¾Œå†ä¸€èµ·è™•ç†ï¼‰
      AI['__player'](p, dt);
      // åˆ·æ€ªéª¨æ¶
      updateSpawners(dt);
  // â˜… æ–°å¢ï¼šéŠç©æ¨¡å¼ä¸‹é¡é ­è·Ÿè‘—ç©å®¶ï¼ˆä»¥ä¸–ç•Œåº§æ¨™ç½®ä¸­ï¼›å„ªå…ˆä½¿ç”¨å¹³æ»‘ï¼‰
  if (p){
    const cx = p.x + p.w/2;
    const cy = p.y + p.h/2;
    if (window.__centerOnWorldSmooth) {
      window.__centerOnWorldSmooth(cx, cy, 0.16); // æƒ³æ›´ç·Šè·Ÿå¯èª¿ 0.20
    } else if (window.__centerOnWorld) {
      window.__centerOnWorld(cx, cy);
    } else if (window.__centerOn) {
      // æœ€çµ‚å‚™æ´ï¼šç”¨æ ¼åº§æ¨™è¿‘ä¼¼ï¼ˆç¨å¾®è·³æ ¼ï¼Œä½†èƒ½ç”¨ï¼‰
      const T = world.tileSize;
      window.__centerOn((cx/T) - 0.5, (cy/T) - 0.5);
    }
  }
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  /* ---------- å°å‡ºï¼ˆä¹‹å¾Œ Phase3/4 æœƒç”¨åˆ°ï¼‰ ---------- */
  Object.assign(window, {
    __ensurePlayer: ensurePlayer,
    __rebuildSpawners: rebuildSpawners,
    __AI: AI
  });

})(); // Phase 2 IIFE
</script>

<script>
/* =========================
   Phase 3ï¼šç³»çµ±åŠŸèƒ½éª¨æ¶
   åŠŸèƒ½ï¼š
   - HP/å±¬æ€§ HUDï¼ˆè®€ ENT.player.statsï¼‰
   - èƒŒåŒ…é¢æ¿ï¼ˆINVENTORYï¼šmeat/loot/coinsï¼‰
   - Checkpointï¼ˆå­˜/è¼‰ï¼‰ã€è‡ªå‹•å­˜æª”æ©‹æ¥
   - ä¸–ç•Œæ¸…å–®ï¼ˆlocalStorage å‘½åå­˜/è¼‰/åˆªï¼‰
   - æ‰‹æ©Ÿè™›æ“¬æŒ‰éµï¼ˆç™¼é€éµç›¤äº‹ä»¶çµ¦ Phase2ï¼‰
   æ³¨æ„ï¼š
   - åªåšéª¨æ¶ï¼Œæ²’æœ‰é¤µé£Ÿ/æ‰è½/é¦´æœé‚è¼¯ï¼ˆä¹‹å¾Œ Phase4 å¡«ï¼‰
   ========================= */
(() => {
  'use strict';

  /* ---------- èˆ‡ Phase1/2 æ©‹æ¥ ---------- */
  const SAVE_KEY = 'dd_skel_phase1';     // Phase1/2 ä½¿ç”¨çš„ autosave key
  const CHECKPOINT_KEY = 'dd_checkpoint_phase3';
  const ENT = window.ENT || {};
  const ensurePlayer = window.__ensurePlayer || (() => null);

  /* ---------- å°å·¥å…·ï¼šå»ºç«‹æˆ–å–å¾—å…ƒç´  ---------- */
  function ensureEl(id, html, parent=document.body){
    let el = document.getElementById(id);
    if (!el) {
      el = document.createElement('div');
      el.id = id;
      el.innerHTML = html || '';
      parent.appendChild(el);
    }
    return el;
  }
  function css(el, obj){ Object.assign(el.style, obj); return el; }

  /* ---------- INVENTORY éª¨æ¶ ---------- */
  const INVENTORY = window.INVENTORY || { meat:0, loot:0, coins:0 };
  window.INVENTORY = INVENTORY;  // å°å‡ºä¾›ä¹‹å¾Œé‚è¼¯ä½¿ç”¨

/* ---------- ç½®é ‚å·¥å…·åˆ—ï¼šåŠ å…¥æ–°æŒ‰éˆ•ï¼ˆåœ°åœ–é¸å–® + èƒŒåŒ…ï¼‰ ---------- */
const uiTop = document.getElementById('uiTop') || ensureEl('uiTop','', document.body);
const mkBtn = (id, text, cls='btn')=>{
  let b=document.getElementById(id);
  if(!b){ b=document.createElement('button'); b.id=id; b.className=cls; b.textContent=text; uiTop.appendChild(b); }
  return b;
};
const bagBtn = mkBtn('bagBtn','èƒŒåŒ…','btn');
const mapBtn = mkBtn('mapBtn','åœ°åœ–','btn');
const playerBtn = mkBtn('playerBtn','ç©å®¶','btn');

// å°é¸å–®ï¼ˆæ–°åœ°åœ– / å­˜ç‚ºèµ·é» / ä¸–ç•Œç®¡ç†ï¼‰
let mapMenu = document.getElementById('mapMenu');
if(!mapMenu){
  mapMenu = document.createElement('div');
  mapMenu.id = 'mapMenu';
  mapMenu.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:6px">
      <button id="mNew"  class="btn">æ–°åœ°åœ–</button>
      <button id="mCP"   class="btn grey">å­˜ç‚ºèµ·é»</button>
      <button id="mWorld" class="btn grey">ä¸–ç•Œç®¡ç†</button>
    </div>`;
  Object.assign(mapMenu.style,{
    position:'fixed', top:'48px', left:'8px', zIndex:7,
    background:'#0b1024', border:'1px solid #ffffff33',
    borderRadius:'12px', padding:'8px', display:'none'
  });
  document.body.appendChild(mapMenu);

  // ç¶å®šäº‹ä»¶
  mapMenu.querySelector('#mNew').onclick  = ()=>{ window.__newMap && window.__newMap(); hideMenu(); };
  mapMenu.querySelector('#mCP').onclick   = ()=>{ saveCheckpoint(); hideMenu(); };
  mapMenu.querySelector('#mWorld').onclick= ()=>{ renderWorldList(); portal.style.display='block'; hideMenu(); };

  function hideMenu(){ mapMenu.style.display='none'; }
  function toggleMenu(){
    mapMenu.style.display = (mapMenu.style.display==='none' ? 'block' : 'none');
  }
  mapBtn.onclick = toggleMenu;
  window.addEventListener('click', (e)=>{
    if(e.target===mapBtn || mapMenu.contains(e.target)) return;
    hideMenu();
  });
}
  /* ---------- HUDï¼ˆHP èˆ‡å±¬æ€§ï¼‰ ---------- */
  const hpHud = ensureEl('hpHud', `
    <div style="background:#0008;border:1px solid #ffffff22;border-radius:8px;padding:6px 10px;font-weight:800">
      <div>HPï¼š<b id="hpNum">â€”/â€”</b></div>
      <div class="bar" style="width:160px;height:10px;background:#222;border-radius:6px;overflow:hidden;margin-top:6px">
        <div id="hpFill" style="height:100%;background:linear-gradient(90deg,#ff5f6d,#ffc371);width:100%"></div>
      </div>
      <div class="small" id="statLine" style="font-size:12px;opacity:.85">ATK â€”ï½œDEF â€”ï½œSPD â€”ï½œJUMP â€”</div>
    </div>
  `);
  css(hpHud, {position:'fixed', left:'10px', top:'56px', zIndex:4, display:'none'});

  function showHud(v){ hpHud.style.display = v ? 'block' : 'none'; }
  function updateHud(){
    const p = ensurePlayer();
    if(!p || !ENT.player) return;
    const s = ENT.player.stats;
    const hpEl = document.getElementById('hpNum');
    const fill = document.getElementById('hpFill');
    const stL  = document.getElementById('statLine');
    if(!hpEl || !fill || !stL) return;

    hpEl.textContent = `${Math.max(0, Math.ceil(s.hp))}/${s.maxHp}`;
    fill.style.width = `${100 * Math.max(0, s.hp)/s.maxHp}%`;
    stL.textContent  = `ATK ${s.atk}ï½œDEF ${s.def}ï½œSPD ${s.spd}ï½œJUMP ${s.jump}`;
  }

  /* ---------- èƒŒåŒ…é¢æ¿ ---------- */
  const bag = ensureEl('bag', `
    <div style="font-weight:800;margin-bottom:6px">ğŸ’ èƒŒåŒ…</div>
    <div class="bag-list">
      <div class="bag-row" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px 8px;border-radius:8px;background:#ffffff10">
        <span>ğŸ– è…è‚‰</span><b id="bagMeat">0</b>
      </div>
      <div class="bag-row" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px 8px;border-radius:8px;background:#ffffff10">
        <span>ğŸ æ‰è½ç‰©</span><b id="bagLoot">0</b>
      </div>
      <div class="bag-row" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px 8px;border-radius:8px;background:#ffffff10">
        <span>ğŸª™ é‡‘å¹£</span><b id="bagCoins">0</b>
      </div>
      <div class="bag-row" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px 8px;border-radius:8px;background:#ffffff10">
        <span>ğŸ§¬ è£å‚™ï¼ˆé ç•™ï¼‰</span><span class="small" style="font-size:12px;opacity:.85">å¾… Phase4</span>
      </div>
    </div>
  `);
  css(bag, {position:'fixed', right:'8px', top:'56px', background:'#0b1024cc',
            border:'1px solid #ffffff33', borderRadius:'12px', padding:'12px',
            zIndex:5, display:'none', minWidth:'240px', maxWidth:'40vw'});

  function refreshBag(){
    const q=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=String(v); };
    q('bagMeat',  INVENTORY.meat|0);
    q('bagLoot',  INVENTORY.loot|0);
    q('bagCoins', INVENTORY.coins|0);
  }
  bagBtn.onclick = ()=>{ bag.style.display = (bag.style.display==='none'?'block':'none'); refreshBag(); };


// ---------- æ‰è½ç‰©ï¼šé»æ“Šï¼é•·æŒ‰é–‹ç®± â†’ æŠ½è£å‚™ï¼ˆä¿®æ­£ç‰ˆï¼‰ ----------
(function bindLootOpen(){
  const lootLabel = document.getElementById('bagLoot');
  if(!lootLabel) return;
  const lootRow = lootLabel.closest('.bag-row');

  const P = { gear:0.35, coin:0.45, meat:0.20 };

  function rollOne(){
    if((INVENTORY.loot|0) <= 0){ toast('æ²’æœ‰æ‰è½ç‰©äº†'); return false; }
    INVENTORY.loot--;
    const r = Math.random();
    if(r < P.gear){
      const g = (window.GEAR_REG || [{ id:'sword_short', name:'çŸ­åŠ', slot:'weapon', atk:3, rarity:'C' }])[Math.floor(Math.random()*(window.GEAR_REG?.length||1))];
      const inst = { id:g.id, name:g.name, slot:g.slot, atk:g.atk||0, def:g.def||0, rarity:g.rarity||'C' };
      (window.GEAR?.slots ? (g.slot==='weapon' ? window.GEAR.weapons : window.GEAR.stash) : []).push(inst);
      if(window.saveGear) window.saveGear();
      toast(`ğŸ‰ ç²å¾—è£å‚™ï¼š${inst.name}`);
    }else if(r < P.gear + P.coin){
      INVENTORY.coins++; toast('ğŸª™ +1');
    }else{
      INVENTORY.meat++;  toast('ğŸ– +1');
    }
    refreshBag();
    return true;
  }

  let holdTimer=null, loopTimer=null;
  let long=false, pressing=false;

  function clearTimers(){
    if(holdTimer){ clearTimeout(holdTimer); holdTimer=null; }
    if(loopTimer){ clearInterval(loopTimer); loopTimer=null; }
    long=false; pressing=false;
  }

  function start(){
    pressing=true; long=false;
    holdTimer = setTimeout(()=>{
      if(!pressing) return;
      long=true;
      loopTimer = setInterval(()=>{ if(!rollOne()) clearTimers(); }, 140);
    }, 350);
  }

  function end(){
    if(!pressing) return;          // â† åªæœ‰åœ¨ loot åˆ—å•Ÿå‹•éæ‰ç†æœƒ
    if(!long) rollOne();
    clearTimers();
  }

  // åªå°ã€Œæ‰è½ç‰©ã€é‚£ä¸€åˆ—å•Ÿå‹•
  lootRow.addEventListener('mousedown',  start);
  lootRow.addEventListener('touchstart', start, {passive:true}); // ä¸é˜»æ–·å¤–éƒ¨é»æ“Š

  // å…¨åŸŸè½çµæŸï¼Œä½†ä¸ preventDefaultã€ä¸è™•ç†éæœ¬æ¬¡æŒ‰å£“
  window.addEventListener('mouseup',     end);
  window.addEventListener('touchend',    end);
  window.addEventListener('touchcancel', clearTimers);
})();


  /* ---------- Checkpointï¼ˆéª¨æ¶ï¼‰ ---------- */
  function saveCheckpoint(){
    const raw = localStorage.getItem(SAVE_KEY)||'';
    try{
      const d = JSON.parse(raw||'{}');
      localStorage.setItem(CHECKPOINT_KEY, JSON.stringify(d));
      toast('âœ… å·²å­˜ç‚ºèµ·é»ï¼ˆCheckpointï¼‰');
    }catch{
      toast('âš ï¸ èµ·é»å­˜æª”å¤±æ•—');
    }
  }
  function loadCheckpoint(){
    const s = localStorage.getItem(CHECKPOINT_KEY)||'';
    if(!s){ toast('å°šæœªè¨­å®šèµ·é»'); return false; }
    try{
      // è¦†å¯«ç•¶å‰ autosave ä¸¦å¼·åˆ¶åˆ·æ–°ï¼ˆéª¨æ¶åšæ³•ï¼Œç°¡å–®ç›´è¦ºï¼‰
      localStorage.setItem(SAVE_KEY, s);
      toast('âœ… å·²è¼‰å…¥èµ·é»ï¼Œé‡æ–°æ•´ç†ä»¥å¥—ç”¨'); 
      // è‹¥ä½ çš„ Phase1 æœ‰å°å¤– import APIï¼Œå¯åœ¨æ­¤ç›´æ¥å‘¼å«å–ä»£ reload
      setTimeout(()=>location.reload(), 350);
      return true;
    }catch{
      toast('âš ï¸ èµ·é»è¼‰å…¥å¤±æ•—');
      return false;
    }
  }

  /* ---------- ä¸–ç•Œç®¡ç†ï¼ˆæœ¬åœ°å‘½åå­˜/è¼‰/åˆªï¼‰ ---------- */
  const portal = ensureEl('portal', `
    <div style="position:relative">
      <button id="portalClose" class="btn grey" style="position:absolute;top:6px;right:6px">é—œé–‰</button>
      <h3 style="margin:0 0 8px 0">ğŸšª ä¸–ç•Œç®¡ç†</h3>
      <div class="small" style="opacity:.9;margin-bottom:10px">ä»¥æœ¬æ©Ÿ localStorage å„²å­˜/è¼‰å…¥ã€‚</div>

      <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
        <input id="worldName" type="text" placeholder="ä¸–ç•Œåç¨±"
               style="flex:1;padding:6px 8px;border-radius:8px;border:1px solid #334155;background:#020617;color:#cbd5e1">
        <button id="saveWorldBtn" class="btn">å„²å­˜ç›®å‰ä¸–ç•Œ</button>
      </div>

      <div class="small" style="opacity:.9;margin-top:10px">å·²å­˜ä¸–ç•Œï¼š</div>
      <div id="portalList" style="margin-top:6px"></div>
    </div>
  `);
  css(portal, {position:'fixed', left:'50%', top:'50%', transform:'translate(-50%,-50%)',
               background:'#0b1024', border:'1px solid #ffffff33', borderRadius:'12px',
               padding:'12px', zIndex:8, display:'none', minWidth:'320px'});
  portal.querySelector('#portalClose').onclick = ()=> portal.style.display='none';
  portal.querySelector('#saveWorldBtn').onclick = ()=>{
    const name = (portal.querySelector('#worldName').value||'').trim();
    saveWorldAs(name);
  };

  function nextWorldKey(){
    let idx=1; while(localStorage.getItem('world_'+idx)) idx++;
    return 'world_'+idx;
  }
  function saveWorldAs(name){
    const raw = localStorage.getItem(SAVE_KEY)||'';
    let obj=null; try{ obj=JSON.parse(raw||'{}'); }catch{}
    if(!obj){ toast('âš ï¸ æ²’æœ‰å¯å„²å­˜çš„ä¸–ç•Œ'); return; }

    const now = new Date().toISOString();
    obj.meta = obj.meta||{};
    if(name) obj.meta.name = name;
    obj.meta.editedAt = now;

    // è¦†è“‹åŒåï¼ˆè‹¥å­˜åœ¨ï¼‰
    const { keyByName } = scanWorlds();
    const overwriteKey = name && keyByName[name];

    const key = overwriteKey || nextWorldKey();
    localStorage.setItem(key, JSON.stringify(obj));
    renderWorldList();
    toast(overwriteKey? `âœ… å·²è¦†è“‹ã€Œ${name}ã€` : `âœ… å·²å„²å­˜ç‚º ${key}${name?`ï¼ˆ${name}ï¼‰`:''}`);
  }
  function scanWorlds(){
    const keys = Object.keys(localStorage).filter(k=>k.startsWith('world_'));
    const list = [];
    const keyByName = {};
    for(const k of keys){
      try{
        const v = JSON.parse(localStorage.getItem(k)||'{}');
        const name = v?.meta?.name || '';
        const editedAt = v?.meta?.editedAt || '';
        if(name && !keyByName[name]) keyByName[name]=k;
        list.push({key:k, name, editedAt});
      }catch{}
    }
    // æ–°åˆ°èˆŠ
    list.sort((a,b)=> (Date.parse(b.editedAt||0)-Date.parse(a.editedAt||0)) || a.key.localeCompare(b.key));
    return { list, keyByName };
  }
  function renderWorldList(){
    const box = portal.querySelector('#portalList');
    box.innerHTML = '';
    const { list } = scanWorlds();
    if(list.length===0){
      box.innerHTML = `<div class="small" style="opacity:.8">å°šç„¡ä¸–ç•Œï¼Œè¼¸å…¥åç¨±å¾ŒæŒ‰ã€Œå„²å­˜ç›®å‰ä¸–ç•Œã€ã€‚</div>`;
      return;
    }
    for(const it of list){
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;background:#ffffff10;border:1px solid #ffffff22;border-radius:8px;padding:6px 8px;margin:6px 0';
      const label = it.name ? `${it.name}ï¼ˆ${it.key}ï¼‰` : it.key;
      const timeStr = it.editedAt ? new Date(it.editedAt).toLocaleString() : '';
      row.innerHTML = `
        <div><div style="font-weight:700">${label}</div>
             <div class="small" style="opacity:.8">${timeStr}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn" data-act="load" data-k="${it.key}">è¼‰å…¥</button>
          <button class="btn grey" data-act="rename" data-k="${it.key}">é‡æ–°å‘½å</button>
          <button class="btn grey" data-act="delete" data-k="${it.key}">åˆªé™¤</button>
        </div>`;
      box.appendChild(row);
    }
    // ç¶å®š
    box.querySelectorAll('button').forEach(btn=>{
      const act = btn.getAttribute('data-act');
      const k   = btn.getAttribute('data-k');
      btn.onclick = ()=>{
        if(act==='load'){
          const txt = localStorage.getItem(k)||'';
          if(!txt){ toast('è®€å–å¤±æ•—'); return; }
          localStorage.setItem(SAVE_KEY, txt);
          toast('âœ… å·²è¼‰å…¥ï¼Œé‡æ–°æ•´ç†ä»¥å¥—ç”¨');
          setTimeout(()=>location.reload(), 350);
        }else if(act==='rename'){
          let obj=null; try{ obj=JSON.parse(localStorage.getItem(k)||'{}'); }catch{}
          const curr = obj?.meta?.name || '';
          const nn = prompt('è¼¸å…¥æ–°åç¨±ï¼ˆå¯ç•™ç©ºï¼‰', curr);
          if(nn===null) return;
          obj.meta = obj.meta||{};
          obj.meta.name = (nn||'').trim();
          obj.meta.editedAt = new Date().toISOString();
          localStorage.setItem(k, JSON.stringify(obj));
          renderWorldList();
        }else if(act==='delete'){
          if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){
            localStorage.removeItem(k);
            renderWorldList();
          }
        }
      };
    });
  }

  /* ---------- æ‰‹æ©Ÿè™›æ“¬æŒ‰éµï¼ˆæŠŠè§¸æ§è½‰æˆéµç›¤äº‹ä»¶ï¼‰ ---------- */
  const controls = ensureEl('controls', `
    <div class="cluster left" style="position:absolute;left:12px;bottom:12px;display:flex;gap:12px;align-items:center">
      <div class="key wide" data-key="left">â†</div>
      <div class="key wide" data-key="right">â†’</div>
    </div>
    <div class="cluster right" style="position:absolute;right:12px;bottom:12px;display:flex;gap:10px;align-items:flex-end;flex-direction:column">
      <div style="display:flex;gap:10px;">
        <div class="key" data-key="jump"  style="width:56px;height:56px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.12);backdrop-filter:blur(4px);font-weight:900">â¤’</div>
      </div>
    </div>
  `);
  css(controls, {position:'fixed', left:0, right:0, bottom:0, pointerEvents:'none', zIndex:6, display:'none'});

// â˜… è®“æ¯é¡† .key å¯ä»¥åƒåˆ°æŒ‡æ¨™äº‹ä»¶ï¼ˆå®¹å™¨ä»æ˜¯ pointer-events:noneï¼‰
controls.querySelectorAll('.key').forEach(el => el.style.pointerEvents = 'auto');

// ç©å®¶æ“ä½œéˆ•å¤–è§€
controls.querySelectorAll('.key').forEach(el=>{
  el.style.userSelect = 'none';
  el.style.padding = '10px 14px';
  el.style.borderRadius = '10px';
  el.style.background = 'rgba(255,255,255,.12)';
  el.style.fontWeight = '900';
  el.style.display = 'flex';
  el.style.alignItems = 'center';
  el.style.justifyContent = 'center';
});
controls.querySelectorAll('.key.wide').forEach(el=>{
  el.style.width = '64px';
  el.style.height = '40px';
});

 // åªæœ‰é€²å…¥éŠç©æ™‚é¡¯ç¤ºï¼ˆè·Ÿ Phase2 æ¨¡å¼åŒæ­¥ï¼‰
const modeBtn   = document.getElementById('modeBtn');
const paletteEl = document.getElementById('palette'); // â˜… å–å¾—èª¿è‰²ç›¤
if (modeBtn){
  // ç›£è½ Phase 2 å»£æ’­çš„ modechange
  window.addEventListener('modechange', (e)=>{
    const on = e.detail.mode === 'play';
    controls.style.display = on ? 'block' : 'none';
    showHud(on);
    if (paletteEl) paletteEl.style.display = on ? 'none' : 'flex'; // â˜… éŠç©éš±è—ï¼Œç·¨è¼¯é¡¯ç¤º
  });

  // åˆå§‹åŒ–ä¸€æ¬¡ï¼ˆå‰›è¼‰å…¥å°±å·²æ˜¯ play çš„æƒ…æ³ï¼‰
  const on = (window.__getMode && window.__getMode()==='play');
  controls.style.display = on ? 'block' : 'none';
  showHud(on);
  if (paletteEl) paletteEl.style.display = on ? 'none' : 'flex'; // â˜… åˆå§‹ç‹€æ…‹åŒæ­¥
}

  function sendKey(code, type){
    const ev = new KeyboardEvent(type, {code, key:code, bubbles:true});
    window.dispatchEvent(ev);
  }
  function bindTouchKey(el, downCode, upCode=downCode){
    const down = (e)=>{ sendKey(downCode,'keydown'); e.preventDefault(); };
    const up   = (e)=>{ sendKey(upCode,'keyup'); e.preventDefault(); };
    el.addEventListener('touchstart', down, {passive:false});
    el.addEventListener('touchend',   up,   {passive:false});
    el.addEventListener('touchcancel',up,   {passive:false});
    el.addEventListener('mousedown',  down);
    window.addEventListener('mouseup', up);
  }
  // ç¶å®š Left/Right/Jump â†’ Phase2 å·²ç›£è½ ArrowLeft/ArrowRight/Space
  controls.querySelectorAll('[data-key="left"]').forEach(el=>bindTouchKey(el,'ArrowLeft'));
  controls.querySelectorAll('[data-key="right"]').forEach(el=>bindTouchKey(el,'ArrowRight'));
  controls.querySelectorAll('[data-key="jump"]').forEach(el=>bindTouchKey(el,'Space'));

  /* ---------- ç°¡æ˜“ Toast ---------- */
  const toastBox = ensureEl('toastBox','');
  css(toastBox,{position:'fixed',left:'50%',bottom:'10%',transform:'translateX(-50%)',
                zIndex:9,color:'#fff',fontWeight:'700',fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial'});
  let toastTimer=null;
  function toast(msg){
    toastBox.textContent = msg;
    toastBox.style.background = '#000b';
    toastBox.style.padding = '8px 12px';
    toastBox.style.borderRadius = '8px';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ toastBox.textContent=''; toastBox.style.padding='0'; }, 1400);
  }


  /* ---------- ç©å®¶é¢æ¿ï¼ˆè£å‚™æ¬„ / æ­¦å™¨æ¬„ / å¯µç‰©ï¼‰ ---------- */
  // è³‡æ–™ï¼šå¯æ“´å……çš„è¨»å†Šè¡¨ + å­˜æª”
  const GEAR_SAVE_KEY = 'dd_gear_v1';

  // æ’ä»¶å¼è¨»å†Šï¼šè£å‚™å®šç¾©ï¼ˆä¹‹å¾Œè¦åŠ æ–°è£å‚™åªè¦ pushï¼‰
  const GEAR_REG = [
    { id:'cap_wood',    name:'æœ¨ç›”',   slot:'head',  def:1, rarity:'C' },
    { id:'armor_leath', name:'çš®ç”²',   slot:'body',  def:2, rarity:'C' },
    { id:'boots_cloth', name:'å¸ƒé´',   slot:'feet',  def:1, rarity:'C' },
    { id:'sword_short', name:'çŸ­åŠ',   slot:'weapon',atk:3, rarity:'C' },
  ];

  // ç©å®¶è£å‚™æ§½ + å€‰åº«ï¼ˆstashï¼‰
  const GEAR = window.GEAR || {
    slots: { head:null, body:null, feet:null, weapon:null },
    stash: [],               // å°šæœªè£å‚™çš„è£å‚™
    weapons: [],             // é¡å¤–æ­¦å™¨æ¬„ï¼ˆå¯ç•¶ stash çš„åˆ¥åç¾¤çµ„ï¼‰
    pets: []                 // å¯µç‰©æ¸…å–®ï¼ˆç®¡ç†ç”¨ï¼‰
  };
  (function loadGear(){
    try{
      const raw = localStorage.getItem(GEAR_SAVE_KEY)||'';
      if(raw){ const obj = JSON.parse(raw);
        if(obj?.slots)  GEAR.slots  = obj.slots;
        if(obj?.stash)  GEAR.stash  = obj.stash;
        if(obj?.weapons)GEAR.weapons= obj.weapons;
        if(obj?.pets)   GEAR.pets   = obj.pets;
      }
    }catch{}
  })();
  function saveGear(){ try{ localStorage.setItem(GEAR_SAVE_KEY, JSON.stringify(GEAR)); }catch{} }
  window.GEAR = GEAR; // æš´éœ²çµ¦å¤–éƒ¨æ’ä»¶

  // UIï¼šé¢æ¿éª¨æ¶
  const playerPanel = ensureEl('playerPanel', `
    <div style="font-weight:800;margin-bottom:8px;display:flex;gap:6px;align-items:center">
      <span>ğŸ§ ç©å®¶</span>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="pill" data-tab="equip">è£å‚™æ¬„</button>
        <button class="pill" data-tab="weapon">æ­¦å™¨æ¬„</button>
        <button class="pill" data-tab="pet">å¯µç‰©</button>
      </div>
    </div>
    <div id="playerTabBody" style="min-width:280px;max-width:42vw"></div>
  `);
  css(playerPanel, {
    position:'fixed', right:'8px', top:'56px', zIndex:7,
    background:'#0b1024cc', border:'1px solid #ffffff33', borderRadius:'12px',
    padding:'12px', display:'none'
  });

  let currentPlayerTab = 'equip';
  function setTab(tab){
    currentPlayerTab = tab;
    playerPanel.querySelectorAll('.pill').forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
    renderPlayerTab();
  }
  playerPanel.querySelectorAll('.pill').forEach(b=>{
    b.onclick = ()=> setTab(b.getAttribute('data-tab'));
  });

  // æ¸²æŸ“ä¸‰åˆ†é 
  function renderPlayerTab(){
    const body = document.getElementById('playerTabBody');
    if(!body) return;
    if(currentPlayerTab==='equip'){
      body.innerHTML = renderEquipHTML();
      bindEquipEvents(body);
    }else if(currentPlayerTab==='weapon'){
      body.innerHTML = renderWeaponHTML();
      bindWeaponEvents(body);
    }else{
      body.innerHTML = renderPetHTML();
      bindPetEvents(body);
    }
  }

  function renderEquipHTML(){
    const s = GEAR.slots;
    const slotLabel = { head:'é ­éƒ¨', body:'èº«é«”', feet:'è…³éƒ¨', weapon:'æ­¦å™¨' };
    const slotHtml = Object.keys(s).map(k=>{
      const v = s[k];
      const label = slotLabel[k] || k;
      return `<div style="display:flex;justify-content:space-between;align-items:center;background:#ffffff10;border:1px solid #ffffff22;border-radius:8px;padding:6px 8px;margin:4px 0">
        <span>${label}</span>
        <span>${v ? `ã€${v.name}ã€‘` : 'â€”'}</span>
        <button class="btn grey" data-act="unequip" data-slot="${k}" ${v?'':'disabled'}>å¸ä¸‹</button>
      </div>`;
    }).join('');

    const stashHtml = (GEAR.stash||[]).map((it,i)=>
      `<button class="pill" data-act="equipFromStash" data-idx="${i}" title="é»æ“Šè£å‚™">${it.name}ï¼ˆ${it.slot}ï¼‰</button>`
    ).join(' ') || `<div class="small" style="opacity:.8">å°šç„¡è£å‚™ï¼Œè«‹ç”±ã€ŒèƒŒåŒ…ï¼æ‰è½ç‰©ã€é–‹ç®±å–å¾—ã€‚</div>`;

    return `
      <div style="font-weight:800;margin-bottom:6px">å·²è£å‚™</div>
      ${slotHtml}
      <div style="font-weight:800;margin:10px 0 6px">è£å‚™å€‰åº«</div>
      <div>${stashHtml}</div>
    `;
  }
  function bindEquipEvents(root){
    root.querySelectorAll('[data-act="unequip"]').forEach(btn=>{
      btn.onclick = ()=>{
        const slot = btn.getAttribute('data-slot');
        if(!GEAR.slots[slot]) return;
        GEAR.stash.push(GEAR.slots[slot]);
        GEAR.slots[slot] = null;
        saveGear(); renderPlayerTab(); toast('å·²å¸ä¸‹');
      };
    });
    root.querySelectorAll('[data-act="equipFromStash"]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.getAttribute('data-idx');
        const it = GEAR.stash[idx]; if(!it) return;
        const slot = it.slot;
        if(GEAR.slots[slot]) GEAR.stash.push(GEAR.slots[slot]); // å…ˆæŠŠåŸæœ¬çš„æ”¾å›å€‰åº«
        GEAR.slots[slot] = it;
        GEAR.stash.splice(idx,1);
        saveGear(); renderPlayerTab(); toast(`å·²è£å‚™ï¼š${it.name}`);
      };
    });
  }

  function renderWeaponHTML(){
    const w = GEAR.slots.weapon;
    const extra = (GEAR.weapons||[]).map((it,i)=>
      `<button class="pill" data-act="equipWeaponFromList" data-idx="${i}">${it.name}</button>`
    ).join(' ') || `<div class="small" style="opacity:.8">æ²’æœ‰å¤šé¤˜æ­¦å™¨ã€‚</div>`;
    return `
      <div style="font-weight:800;margin-bottom:6px">ä¸»æ­¦å™¨</div>
      <div style="display:flex;justify-content:space-between;align-items:center;background:#ffffff10;border:1px solid #ffffff22;border-radius:8px;padding:6px 8px;margin:4px 0">
        <span>${w?`ã€${w.name}ã€‘`:'â€”'}</span>
        <button class="btn grey" data-act="unequipWeapon" ${w?'':'disabled'}>å¸ä¸‹</button>
      </div>
      <div style="font-weight:800;margin:10px 0 6px">æ­¦å™¨æ¸…å–®</div>
      <div>${extra}</div>
    `;
  }
  function bindWeaponEvents(root){
    const w = GEAR.slots.weapon;
    const btnU = root.querySelector('[data-act="unequipWeapon"]');
    if(btnU) btnU.onclick = ()=>{
      if(!GEAR.slots.weapon) return;
      GEAR.weapons.push(GEAR.slots.weapon);
      GEAR.slots.weapon = null;
      saveGear(); renderPlayerTab(); toast('å·²å¸ä¸‹ä¸»æ­¦å™¨');
    };
    root.querySelectorAll('[data-act="equipWeaponFromList"]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.getAttribute('data-idx');
        const it = GEAR.weapons[idx]; if(!it) return;
        if(GEAR.slots.weapon) GEAR.weapons.push(GEAR.slots.weapon);
        GEAR.slots.weapon = it;
        GEAR.weapons.splice(idx,1);
        saveGear(); renderPlayerTab(); toast(`å·²è£å‚™ï¼š${it.name}`);
      };
    });
  }

  function renderPetHTML(){
    const list = (GEAR.pets||[]).map((p,i)=>
      `<div class="bag-row" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px 8px;border-radius:8px;background:#ffffff10">
        <span>ğŸ¾ ${p.name||('å¯µç‰©'+(i+1))}</span>
        <button class="btn grey" data-act="releasePet" data-idx="${i}">æ”¾ç”Ÿ</button>
      </div>`
    ).join('') || `<div class="small" style="opacity:.8">å°šç„¡å¯µç‰©ã€‚</div>`;
    return `
      <div style="font-weight:800;margin-bottom:6px">å¯µç‰©ç®¡ç†</div>
      ${list}
    `;
  }
  function bindPetEvents(root){
    root.querySelectorAll('[data-act="releasePet"]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = +btn.getAttribute('data-idx');
        GEAR.pets.splice(i,1);
        saveGear(); renderPlayerTab(); toast('å·²æ”¾ç”Ÿ');
      };
    });
  }

  // æŒ‰éˆ•ï¼šé–‹é—œé¢æ¿
  if (playerBtn){
    playerBtn.onclick = ()=>{
      const on = playerPanel.style.display!=='block';
      playerPanel.style.display = on ? 'block' : 'none';
      if(on) { setTab(currentPlayerTab); }
    };
  }

  /* ---------- æ¯å¹€æ›´æ–°ï¼ˆåªè² è²¬ UIï¼‰ ---------- */
  function uiTick(){
    updateHud();
    // ä¹‹å¾Œå¯åœ¨æ­¤åŒæ­¥èƒŒåŒ…/æ‰è½ç­‰é¡¯ç¤º
    requestAnimationFrame(uiTick);
  }
  requestAnimationFrame(uiTick);

  /* ---------- å°å‡º ---------- */
  Object.assign(window, {
    saveCheckpoint, loadCheckpoint, refreshBag, showHud
  });

})(); // Phase 3 IIFE
</script>


<script>
/* =========================
   BGMï¼šå¾ªç’°æ’­æ”¾ï¼ˆå¯æ›¿æ›éŸ³æºï¼‰
   - é è¨­è·¯å¾‘ï¼šbgm.mp3ï¼ˆè‡ªè¡Œæ”¾æª”æˆ–æ”¹ setBGMï¼‰
   - è‡ªå‹•ï¼šç¬¬ä¸€æ¬¡äº’å‹•æˆ–åˆ‡åˆ° Play å³å˜—è©¦æ’­æ”¾
   - æš´éœ² window.AUDIO APIï¼šsetBGM / play / pause / setVolume
   ========================= */
(() => {
  'use strict';
  const AUDIO = {};
  let el = new Audio();
  el.src = 'bgm.mp3'; // â† å¯æ”¹
  el.loop = true;
  el.volume = 0.4;          // 0.0 ~ 1.0
  let unlocked = false;

  function tryPlay(){
    el.play().then(()=>{ unlocked = true; }).catch(()=>{ /* å¯èƒ½è¢«ç€è¦½å™¨æ“‹ï¼Œç­‰ä¸‹ä¸€æ¬¡äº’å‹• */ });
  }

  // ä½¿ç”¨è€…ä»»ä¸€äº’å‹•å°±å˜—è©¦è§£é–éŸ³è¨Š
  ['pointerdown','keydown'].forEach(t=>{
    window.addEventListener(t, tryPlay, { once:true, passive:true });
  });
  // é€²å…¥éŠç©æ¨¡å¼æ™‚ä¹Ÿå†å˜—è©¦ä¸€æ¬¡
  window.addEventListener('modechange', e=>{
    if (e && e.detail && e.detail.mode==='play') tryPlay();
  });

  AUDIO.setBGM = (url)=>{ el.src = url; if(unlocked) tryPlay(); };
  AUDIO.play   = ()=> tryPlay();
  AUDIO.pause  = ()=> el.pause();
  AUDIO.setVolume = (v)=>{ el.volume = Math.max(0, Math.min(1, v)); };

  window.AUDIO = AUDIO;
})();
</script>


<script>
/* =====================================================
   Phase 4ï¼šç¾è¡“èˆ‡æ“´å……éª¨æ¶ï¼ˆRenderer / FX / Hooksï¼‰
   ç›®çš„ï¼š
   1) æä¾›é€šç”¨çš„ã€Œæ¸²æŸ“è¨»å†Šè¡¨ã€èˆ‡ã€Œç‰¹æ•ˆç³»çµ±ã€éª¨æ¶
   2) ä¸å¹²æ“¾ä½ æ—¢æœ‰çš„ä¸»æ¸²æŸ“å¾ªç’°ï¼ˆPhase2ï¼‰ï¼Œç´”æ–°å¢ API
   3) ä¹‹å¾Œæ–°å¢å“ç¨®ï¼šåªåšã€Œè³‡æ–™ + ç¹ªåœ–å‡½å¼è¨»å†Šã€å³å¯

   ä½¿ç”¨æ–¹å¼ï¼ˆä¹‹å¾Œè¦åŠ å€‰é¼ /å™´ç«é¾ï¼‰ï¼š
   - ENT['hamster'] = {... åŸºç¤æ•¸å€¼/ai...}
   - SKIN.useEnt('hamster', drawHamster)   // è¨»å†Šç¹ªæ³•
   - ENT['dragon']  = {...}
   - SKIN.useEnt('dragon',  drawDragon)

   è£œå……ï¼š
   - é€™è£¡æä¾›å¯é¸çš„ã€Œçš®è†šæ¸²æŸ“å™¨ã€èˆ‡ã€Œç‰¹æ•ˆ FXã€éª¨æ¶ã€‚
   - ä½ ç›®å‰çš„ Phase2 å·²èƒ½é¡¯ç¤ºåœ°åœ–/ç©å®¶ï¼›é€™æ®µä¸æœƒæ¶ç•«é¢ã€‚
   - è‹¥ä½ æƒ³æŠŠ Phase4 çš„çš®è†šæ¥å…¥ä¸»è¿´åœˆï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹å‘¼å«ï¼š
       SKIN.attachTo({
         enumerateVisible, // å–å¾—å¯è¦‹çš„ tile èˆ‡ entity
         getCtx,           // å–å¾— ctx
         getCamera,        // å–å¾—é¡é ­è³‡è¨Š {x,y,scale}
       })
     ä¹Ÿå¯ä»¥è‡ªå·±åœ¨ä½ çš„ render() è£¡æ‰‹å‹•å‘¼å« SKIN.render(ctx, camera, ents, tiles)ã€‚
   ===================================================== */
(() => {
  'use strict';

  /* ---------- å–å¾—ç•«å¸ƒ / ä¸Šä¸‹æ–‡ï¼ˆä¸è¦†è“‹ï¼Œåªå€Ÿç”¨ï¼‰ ---------- */
  const cv  = document.getElementById('cv');
  const ctx = cv ? (cv.getContext && cv.getContext('2d')) : null;

  /* ---------- THEMEï¼ˆé¡è‰²æ–¹æ¡ˆï¼Œå¯æ›çš®ï¼‰ ---------- */
  const THEME = {
    bgTop:   '#0e1126',
    bgBot:   '#1a1f3d',
    grid:    'rgba(255,255,255,.06)',
    tile:    '#3e466e',
    tileEdge:'#5a6494',
    gold:    '#ffd34e',
    red:     '#ff6b6b',
    ui:      '#ffffff'
  };

  /* ---------- æ¸²æŸ“è¨»å†Šä¸­å¿ƒ ---------- */
  const SKIN = {
    ent: new Map(),       // type -> draw(ctx, en, t)
    tile: new Map(),      // key  -> paint(ctx, x, y, size, meta)
    fx: [],               // ç²’å­ç‰¹æ•ˆæ± 
    time: 0,

    useEnt(type, fn){ this.ent.set(type, fn); return this; },
    useTile(key, fn){ this.tile.set(key, fn); return this; },

    // å®‰å…¨å‘¼å«
    drawEntSafe(en, t){
      const fn = this.ent.get(en.type) || defaultEnt;
      fn && fn(ctx, en, t, THEME);
    },
    drawTileSafe(key, x, y, size, meta){
      const fn = this.tile.get(key) || defaultTile;
      fn && fn(ctx, x, y, size, meta, THEME);
    },

    /* ----- FXï¼ˆæœ€å°éª¨æ¶ï¼‰ ----- */
    spawnFx(p){ this.fx.push(p); },
    tickFx(dt){
      for(let i=this.fx.length-1;i>=0;i--){
        const f = this.fx[i];
        f.life -= dt; if(f.life<=0){ this.fx.splice(i,1); continue; }
        f.x += (f.vx||0) * dt;
        f.y += (f.vy||0) * dt;
      }
    },
    drawFx(){
      for(const f of this.fx){
        ctx.globalAlpha = Math.max(0, Math.min(1, f.life / (f.maxLife||1)));
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r||4, 0, Math.PI*2);
        ctx.fillStyle = f.color || THEME.gold;
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    },

    /* ----- å°è£ä¸€å€‹å¯é¸çš„æ›æ¥å™¨ï¼šè®“ä½ ç„¡ç—›æ¥å…¥ä¸»æ¸²æŸ“ ----- */
    __attached: null,
    attachTo(adaptor){
      // adaptorï¼š{ enumerateVisible, getCtx, getCamera }
      this.__attached = adaptor;
      return this;
    },
    detach(){ this.__attached = null; },

    /* ----- æä¾›ä¸€å€‹ä¸»æ¸²æŸ“å‡½å¼ï¼ˆä½ å¯æ‰‹å‹•å‘¼å«ï¼‰ ----- */
    render(camera, ents, tiles, tileSize){
      if(!ctx) return;
      const t = this.time;

      // èƒŒæ™¯ï¼ˆä¸è¦†è“‹ä½ åŸæœ¬èƒŒæ™¯ï¼Œé€™è£¡åªç¤ºç¯„ï¼‰
      // å¯æ”¹ç‚ºï¼šåªç•« FX èˆ‡ ç‰¹æ®Šå‰æ™¯
      // const g = ctx.createLinearGradient(0,0,0,cv.height);
      // g.addColorStop(0, THEME.bgTop);
      // g.addColorStop(1, THEME.bgBot);
      // ctx.fillStyle = g; ctx.fillRect(0,0,cv.width,cv.height);

      // Tilesï¼ˆå¯é¸ï¼šè‹¥ä½ ä¸æƒ³é‡ç•«åœ°é¢ï¼Œå°±ä¸å‘¼å«é€™æ®µï¼‰
      if (tiles && tileSize){
        for(const cell of tiles){ // cell: {x,y,key,meta}
          this.drawTileSafe(cell.key, cell.x, cell.y, tileSize, cell.meta);
        }
      }

      // Entitiesï¼ˆåªç•«æœ‰è¨»å†Šçš„ï¼Œæ²’è¨»å†Šç”¨ defaultEntï¼‰
      if (ents){
        for(const en of ents) this.drawEntSafe(en, t);
      }

      // FX
      this.drawFx();
    }
  };
  window.SKIN = SKIN; // å°å‡ºçµ¦å…¨åŸŸä½¿ç”¨

  /* ---------- é è¨­ç¹ªåœ–ï¼ˆå¾ˆç°¡å–®ï¼Œåƒ…éª¨æ¶ï¼‰ ---------- */
  function defaultEnt(ctx, en, t, C){
    // è¦–è¦ºï¼šç°è‰²å°è† å›Šï¼ˆç¤ºæ„ hitboxï¼‰
    ctx.save();
    ctx.translate(en.x + en.w/2, en.y + en.h/2);
    ctx.fillStyle = 'rgba(255,255,255,.12)';
    roundRect(ctx, -en.w/2, -en.h/2, en.w, en.h, 6);
    ctx.fill();
    ctx.restore();
  }
  function defaultTile(ctx, x, y, size, meta, C){
    ctx.fillStyle = THEME.tile;
    ctx.fillRect(x, y, size, size);
    ctx.strokeStyle = THEME.tileEdge;
    ctx.lineWidth = 2;
    ctx.strokeRect(x+0.5,y+0.5,size-1,size-1);
  }
  function roundRect(ctx, x, y, w, h, r){
    const rr=Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  /* ---------- ç¯„ä¾‹ï¼šè¨»å†Šå¹¾å€‹å¸¸ç”¨ Tile çš„ã€Œç¾è¡“ç•«æ³•ã€ ---------- */
  SKIN
    .useTile('#', (ctx, x, y, s, meta, C)=>{ // åœ°é¢
      ctx.fillStyle = THEME.tile; ctx.fillRect(x,y,s,s);
      ctx.strokeStyle = THEME.tileEdge; ctx.lineWidth=2;
      ctx.strokeRect(x+0.5,y+0.5,s-1,s-1);
    })
    .useTile('o', (ctx, x, y, s, meta, C)=>{ // é‡‘å¹£
      ctx.beginPath();
      ctx.arc(x+s/2, y+s/2, Math.min(10,s*0.22), 0, Math.PI*2);
      ctx.fillStyle = THEME.gold; ctx.fill();
      ctx.strokeStyle = '#e5b93c'; ctx.lineWidth=2; ctx.stroke();
    })
    .useTile('^', (ctx, x, y, s, meta, C)=>{ // å°–åˆº
      ctx.fillStyle = THEME.red;
      const n=4, w=s/n;
      for(let i=0;i<n;i++){
        const bx=x+i*w;
        ctx.beginPath();
        ctx.moveTo(bx, y+s);
        ctx.lineTo(bx+w/2, y+6);
        ctx.lineTo(bx+w, y+s);
        ctx.closePath(); ctx.fill();
      }
    })
    .useTile('S', (ctx, x, y, s, meta, C)=>{ // å‡ºç”Ÿé»
      ctx.fillStyle = '#21d07a';
      ctx.fillRect(x+6,y+6,s-12,s-12);
      ctx.fillStyle = '#042';
      ctx.fillRect(x+10,y+12,s-20,10);
    })

    });

  /* ---------- Hooksï¼šé ç•™æ›´å¤šäº¤äº’ï¼ˆä¹‹å¾Œå¡«å…¥ï¼‰ ---------- */
  const HOOKS = {
    onTileEnter: new Map(), // key -> fn(player, gx, gy)
    onTileStay:  new Map(),
    onTileExit:  new Map(),
    useEnter(key, fn){ this.onTileEnter.set(key, fn); return this; },
    useStay (key, fn){ this.onTileStay.set(key, fn);  return this; },
    useExit (key, fn){ this.onTileExit.set(key, fn);  return this; },
  };
  window.DD_HOOKS = HOOKS;

  // ç¯„ä¾‹ï¼ˆä¹‹å¾ŒçœŸæ­£è¦å•Ÿç”¨æ™‚ï¼Œåœ¨ Phase2 çš„ tile æª¢æ¸¬è™•å‘¼å«å³å¯ï¼‰
  // HOOKS.useEnter('o', (player,gx,gy)=>{ INVENTORY.coins++; /* æ¸…æ‰è©² tile ... */ });

  /* ---------- å¯é¸ï¼šæŠŠ Phase4 æ’å…¥ä½ çš„æ¸²æŸ“å¾ªç’°ï¼ˆéå¼·åˆ¶ï¼‰ ----------
     è‹¥ä½ æƒ³ç›´æ¥ä½¿ç”¨é€™çµ„çš®è†šæ¸²æŸ“ï¼Œå¯åœ¨ä½ çš„ä¸»ç¨‹å¼å‘¼å«ï¼š
       SKIN.attachTo({
         enumerateVisible: () => ({
           tiles: [ {x,y,key,meta}, ... ],
           ents:  [ entity, ... ],
           tileSize: TILE
         }),
         getCtx: () => ctx,
         getCamera: () => ({ x: camX, y: camY, scale: 1 })
       });
     ä¸‹é¢é€™å€‹ raf åªæœƒåœ¨ attachTo() ä¹‹å¾Œé–‹å§‹é‹ä½œã€‚
  ---------------------------------------------------------------- */
  (function phase4RenderLoop(){
    let last=performance.now();
    function tick(now){
      const dt = Math.min(0.033, (now-last)/1000); last=now;
      SKIN.time += dt; SKIN.tickFx(dt);

      if (SKIN.__attached){
        const { enumerateVisible, getCtx, getCamera } = SKIN.__attached;
        const out = enumerateVisible ? enumerateVisible() : null;
        const ktx = getCtx ? getCtx() : ctx;
        if (ktx && out){
          ktx.save();
          const cam = getCamera ? getCamera() : {x:0,y:0,scale:1};
          ktx.translate(-cam.x*(cam.scale||1), -cam.y*(cam.scale||1));
          if (cam.scale && cam.scale!==1) ktx.scale(cam.scale, cam.scale);

          // ä½¿ç”¨ Phase4 çš®è†šæ¸²æŸ“ï¼ˆåªç•«è¨»å†Šå…§å®¹ï¼‰
          SKIN.render(cam, out.ents||[], out.tiles||[], out.tileSize||48);

          ktx.restore();
        }
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  })();

  /* ---------- ä¾¿åˆ©å·¥å…·ï¼šå¹«åŠ©ä½ ä¹‹å¾Œå¿«é€Ÿåšçš®è†š ---------- */
  function wiggle(base, amp, t, speed=6){ return base + Math.sin(t*speed)*amp; }
  function drawShadow(x, y, w){
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.ellipse(x, y, w, 5.5, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  /* ---------- ï¼ˆç¤ºä¾‹ï¼‰å€‰é¼  & å™´ç«é¾çš„çš®è†šæ¥å£ï¼šå…ˆæ”¾ç©ºå‡½å¼ ----------
     ä½ ä¹‹å¾Œåªè¦ï¼š
       ENT['hamster'] = {...}
       SKIN.useEnt('hamster', drawHamster);
     å°±èƒ½æœ‰ç¨ç«‹çš„ç¾è¡“è¡¨ç¾ï¼ˆèˆ‡æ•¸å€¼/AI è§£è€¦ï¼‰ã€‚
  -------------------------------------------------------------- */
  function drawHamster(ctx, en, t, C){
    // ç¯„ä¾‹é€ å‹ï¼šåœ“æ»¾æ»¾ + å°è€³æœµï¼ˆä¹‹å¾Œä½ å¯æ›¿æ›ç‚ºæ›´ç²¾ç·»ï¼‰
    const r = Math.max(10, Math.min(en.w,en.h)*0.48);
    const cx = en.x + en.w/2;
    const cy = en.y + en.h/2 + Math.sin(t*6)*1.2;
    drawShadow(cx, en.y + en.h, r*0.7);

    ctx.save();
    ctx.translate(cx, cy);
    // èº«é«”
    ctx.fillStyle = '#d9a074';
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    // ç™½è‚š
    ctx.fillStyle = '#fff6ee';
    ctx.beginPath(); ctx.ellipse(0, r*0.15, r*0.65, r*0.55, 0, 0, Math.PI*2); ctx.fill();
    // è€³æœµ
    ctx.fillStyle = '#c98e63';
    ctx.beginPath(); ctx.arc(-r*0.55,-r*0.55,r*0.28,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( r*0.55,-r*0.55,r*0.28,0,Math.PI*2); ctx.fill();
    // çœ¼ç›
    ctx.fillStyle = '#2b2b2b';
    ctx.beginPath(); ctx.arc(-r*0.28, -r*0.1, r*0.09, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( r*0.28, -r*0.1, r*0.09, 0, Math.PI*2); ctx.fill();
    // é¼»å­
    ctx.fillStyle = '#ff6b6b';
    ctx.beginPath(); ctx.arc(0, r*0.05, r*0.08, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function drawDragon(ctx, en, t, C){
    const cx = en.x + en.w/2;
    const cy = en.y + en.h/2 + Math.sin(t*2)*1.5;
    const w  = Math.max(20, en.w*0.9), h = Math.max(20, en.h*0.9);
    drawShadow(cx, en.y + en.h, Math.min(w,h)*0.7);

    ctx.save();
    ctx.translate(cx, cy);

    // èº«é«”
    ctx.fillStyle = '#4a86e8';
    ctx.beginPath();
    ctx.ellipse(0,0,w*0.45,h*0.36,0,0,Math.PI*2);
    ctx.fill();

    // ç¿…è†€
    const flap = Math.sin(t*7)*8;
    ctx.fillStyle = '#6aa8ff';
    ctx.beginPath(); // å·¦
    ctx.moveTo(-w*0.45,0);
    ctx.quadraticCurveTo(-w*0.85,-h*0.28-flap,-w*0.6,-h*0.55-flap);
    ctx.quadraticCurveTo(-w*0.2,-h*0.2,-w*0.45,0);
    ctx.fill();

    ctx.beginPath(); // å³
    ctx.moveTo(w*0.45,0);
    ctx.quadraticCurveTo(w*0.85,-h*0.28+flap,w*0.6,-h*0.55+flap);
    ctx.quadraticCurveTo(w*0.2,-h*0.2,w*0.45,0);
    ctx.fill();

    // é ­
    ctx.fillStyle = '#3a73cc';
    ctx.beginPath();
    ctx.arc(0,-h*0.48,h*0.22,0,Math.PI*2); ctx.fill();

    // çœ¼ç›
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(-h*0.08,-h*0.50,h*0.06,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( h*0.08,-h*0.50,h*0.06,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#2b2b2b';
    ctx.beginPath(); ctx.arc(-h*0.08,-h*0.50,h*0.03,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( h*0.08,-h*0.50,h*0.03,0,Math.PI*2); ctx.fill();

    // ç«å£ï¼ˆåƒ…åšäº®é»ï¼Œä¹‹å¾Œå¯ç™¼å°„å½ˆé«”ï¼‰
    ctx.fillStyle = 'rgba(255,140,0,0.9)';
    ctx.fillRect(-4,-h*0.42, 8, 6);

    ctx.restore();
  }

  // å°å‡ºæ–¹ä¾¿ä½ ä¹‹å¾Œç›´æ¥å‘¼å«ï¼ˆä¸è‡ªå‹•è¨»å†Šä»»ä½•æ€ª/å‹•ç‰©ï¼‰
  Object.assign(window, {
    drawHamster, drawDragon, THEME
  });

})();
</script>

//ä¸»çµæ§‹çµæŸ








//æ€ªç¸æ’ä»¶é–‹å§‹



<!-- ============ Plugin: è¥¿æ–¹é»‘é­”é¾ v2ï¼ˆå·¡é‚ï¼šç·¨è¼¯æ¨¡å¼ä¹Ÿæœƒå‹•ï¼›è¿½æ“Šéœ€éŠç©+è¦–ç·šï¼‰ ============ -->
<script>
(() => {
  'use strict';

  const ENT  = window.ENT  || (window.ENT  = {});
  const SKIN = window.SKIN || (window.SKIN = { ent:{ get:()=>null }, useEnt:()=>{} });

  /* ========== ä¸–ç•Œå¿«ç…§ï¼ˆä¾›ç¢°æ’èˆ‡å°ºå¯¸ï¼‰ ========== */
  const SAVEK = 'dd_skel_phase1';
  let _rawCache=null, _world=null, _lastSnap=0;

  function loadWorldSnapshot(force=false){
    const now = performance.now();
    if(!force && now - _lastSnap < 450) return _world;
    const raw = localStorage.getItem(SAVEK) || '';
    if(!force && raw === _rawCache) return _world;
    _lastSnap = now; _rawCache = raw;
    try{
      const d = JSON.parse(raw || '{}');
      const tiles = (d.tileRows||[]).map(r=>r.split(''));
      const T = d.tileSize || 48;
      _world = {
        w: d.w || 40, h: d.h || 24, T, tiles,
        tileAt(gx,gy){
          if(gx<0||gy<0||gx>=this.w||gy>=this.h) return '#';
          const row=this.tiles[gy]||[]; return row[gx]||'.';
        },
        isSolidRect(rx,ry,rw,rh){
          const T=this.T;
          const x0=Math.floor(rx/T), x1=Math.floor((rx+rw-1)/T);
          const y0=Math.floor(ry/T), y1=Math.floor((ry+rh-1)/T);
          for(let y=y0;y<=y1;y++){
            for(let x=x0;x<=x1;x++){
              if(this.tileAt(x,y)==='#') return true;
            }
          }
          return false;
        }
      };
    }catch{
      _world = { w:40, h:24, T:48, tiles:[],
        tileAt(){return '.';}, isSolidRect(){return false;}
      };
    }
    return _world;
  }

  function moveWithCollisions(o, dt){
    const W = loadWorldSnapshot(); if(!W) return;
    // æ°´å¹³
    let nx = o.x + o.vx*dt;
    if(!W.isSolidRect(nx, o.y, o.w, o.h)){ o.x = nx; }
    else{
      const dir = Math.sign(o.vx)||1;
      let px=o.x; while(!W.isSolidRect(px+dir, o.y, o.w, o.h)) px+=dir;
      o.x=px; o.vx=0;
    }
    // å‚ç›´
    let ny = o.y + o.vy*dt; o.onGround=false;
    if(!W.isSolidRect(o.x, ny, o.w, o.h)){ o.y = ny; }
    else{
      const dir = Math.sign(o.vy)||1;
      let py=o.y; while(!W.isSolidRect(o.x, py+dir, o.w, o.h)) py+=dir;
      o.y=py; if(dir>0) o.onGround=true; o.vy=0;
    }
    // é‚Šç•Œå¤¾é™
    const maxX=W.w*W.T - o.w, maxY=W.h*W.T - o.h;
    o.x = Math.max(0, Math.min(maxX, o.x));
    o.y = Math.max(0, Math.min(maxY, o.y));
  }

  /* ========== è¦–ç·šï¼ˆLOSï¼‰æª¢æ¸¬ï¼šè·¯å¾‘ä¸­é‡åˆ°ç‰†ï¼ˆ#ï¼‰è¦–ç‚ºé®è”½ ========== */
  function hasLineOfSight(ax,ay,bx,by,W){
    const dx=bx-ax, dy=by-ay;
    const dist = Math.hypot(dx,dy)||1;
    const step = Math.max(4, Math.floor(W.T*0.5)); // ç´„åŠæ ¼å–æ¨£
    const steps = Math.ceil(dist/step);
    for(let i=0;i<=steps;i++){
      const t = i/steps;
      const x = ax + dx*t, y = ay + dy*t;
      const gx = Math.floor(x/W.T), gy = Math.floor(y/W.T);
      if(W.tileAt(gx,gy)==='#') return false;
    }
    return true;
  }

  /* ========== æ‰è½ ========== */
  const DROP = {
    coin: { chance: 0.70, min:1, max:3 },
    loot: { chance: 0.45, min:1, max:2 },
    meat: { chance: 0.35, min:1, max:1 }
  };
  function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
  function tryDrop(kind, inv, x, y, color){
    const cfg = DROP[kind]; if(!cfg) return 0;
    if(Math.random() > cfg.chance) return 0;
    const n = randInt(cfg.min, cfg.max);
    const key = (kind==='coin' ? 'coins' : kind);
    inv[key] = (inv[key]|0) + n;
    try{
      if(window.SKIN && SKIN.spawnFx){
        for(let i=0;i<n;i++){
          SKIN.spawnFx({ x:x+(Math.random()*12-6), y:y-6, vx:(Math.random()*80-40), vy:-60-Math.random()*60,
            r: kind==='meat'?4:5, color, life:0.5, maxLife:0.5 });
        }
      }
    }catch{}
    return n;
  }
  function dropLootAt(x,y){
    const INV = window.INVENTORY || (window.INVENTORY = {meat:0, loot:0, coins:0});
    const c = tryDrop('coin', INV, x,y, 'rgba(255,211,78,0.9)');
    const l = tryDrop('loot', INV, x,y, 'rgba(160,200,255,0.95)');
    const m = tryDrop('meat', INV, x,y, 'rgba(255,120,140,0.95)');
    const box = document.getElementById('toastBox');
    if(box && (c||l||m)){
      let msg = ''; if(c) msg += `ğŸª™x${c} `; if(l) msg += `ğŸx${l} `; if(m) msg += `ğŸ–x${m}`;
      box.textContent = `ç²å¾— ${msg.trim()}`;
      box.style.background='#000b'; box.style.padding='8px 12px'; box.style.borderRadius='8px';
      clearTimeout(dropLootAt._t); dropLootAt._t = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
    }
    if(typeof window.refreshBag === 'function') window.refreshBag();
  }

  /* ========== Spritesheetï¼šè¼‰å…¥èˆ‡ç•«åœ–å™¨ ========== */
  const SHEETS = (SKIN.sheets ||= {});

  function registerDragonSheet(url, cols, rows, name='dragon_sheet'){
    const img = new Image(); img.src = url;
    SHEETS[name] = { img, cols, rows, ready:false };
    img.onload = ()=>{ SHEETS[name].ready = true; };
    return name;
  }
  window.registerDragonSheet = registerDragonSheet;

  function makeDragonDrawer(sheetName='dragon_sheet', scale=3){
    return function drawDragonSheet(ctx, e, now){
      const sheet = SHEETS[sheetName];
      if(!sheet || !sheet.ready) return drawBlackHexDragon(ctx, e, now);
      e._anim ||= {
        name:'idle', t:0, i:0,
        map:{
          idle:   { frames:[0,1,2],     fps:6,  loop:true  },
          fly:    { frames:[3,4,5,6],   fps:10, loop:true  },
          attack: { frames:[7,8,9],     fps:9,  loop:false, next:'fly' },
          hit:    { frames:[10],        fps:1,  loop:false, next:'fly' },
          die:    { frames:[11],        fps:6,  loop:false }
        }
      };
      e._anim.t += (e._dt||0.016);
      const A = e._anim.map[e._anim.name] || e._anim.map.fly;
      e._anim.i += A.fps*(e._dt||0.016);
      let frame = A.frames[Math.floor(e._anim.i)%A.frames.length];
      if(!A.loop && e._anim.i >= A.frames.length){
        e._anim.name = A.next || 'fly'; e._anim.i = 0;
        frame = (e._anim.map[e._anim.name]||A).frames[0];
      }
      const cols = sheet.cols|0||4, rows = sheet.rows|0||3;
      const fw = sheet.img.width/cols, fh = sheet.img.height/rows;
      const sx = (frame%cols)*fw, sy = Math.floor(frame/cols)*fh;

      const drawW = Math.max(fw*scale, e.w*1.2);
      const drawH = Math.max(fh*scale, e.h*1.2);

      ctx.save();
      if(e._flash>0){ ctx.globalAlpha=0.65; e._flash--; }
      ctx.translate(e.x + e.w/2, e.y + e.h/2);
      ctx.scale(e.face>=0 ? 1 : -1, 1);
      ctx.drawImage(sheet.img, sx, sy, fw, fh, -drawW/2, -drawH/2, drawW, drawH);
      ctx.restore();
    };
  }
  window.makeDragonDrawer = makeDragonDrawer;

  /* ========== ä½”ä½é»‘é­”é¾ï¼ˆç„¡ç´ æä¹Ÿèƒ½çœ‹åˆ°æŒ‰éˆ•ï¼†ç•«é¢ï¼‰ ========== */
  function drawBlackHexDragon(ctx, e, t){
    const cx=e.x+e.w/2, cy=e.y+e.h/2 + Math.sin(t*2)*1.5;
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,0.35)';
    ctx.beginPath(); ctx.ellipse(e.x+e.w/2, e.y+e.h, Math.min(e.w,e.h)*0.5, Math.min(e.w,e.h)*0.18, 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();
    ctx.save();
    ctx.translate(cx, cy); ctx.scale(e.face>=0?1:-1, 1);
    const flap = Math.sin(t*7)*8;
    ctx.fillStyle = '#0C1E5A';
    ctx.beginPath(); ctx.moveTo(-e.w*0.46,-e.h*0.05);
    ctx.quadraticCurveTo(-e.w*0.9,-e.h*0.28-flap,-e.w*0.64,-e.h*0.55-flap);
    ctx.lineTo(-e.w*0.42,-e.h*0.22); ctx.lineTo(-e.w*0.58,-e.h*0.08); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo( e.w*0.46,-e.h*0.05);
    ctx.quadraticCurveTo( e.w*0.9,-e.h*0.28+flap, e.w*0.64,-e.h*0.55+flap);
    ctx.lineTo( e.w*0.42,-e.h*0.22); ctx.lineTo( e.w*0.58,-e.h*0.08); ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#14141A';
    ctx.beginPath(); ctx.ellipse(0,0, e.w*0.46, e.h*0.38, 0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#2F3A4A';
    ctx.beginPath(); ctx.ellipse(0, -e.h*0.02, e.w*0.30, e.h*0.26, 0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#F04A2F';
    ctx.beginPath(); ctx.ellipse(12, -e.h*0.42, 4,3, 0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(185,236,255,0.95)';
    ctx.beginPath(); ctx.ellipse(18, -e.h*0.36, 7,5, 0,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  /* ========== å™´ç«é¾ï¼ˆè¥¿æ–¹é»‘é­”é¾ï¼‰æœ¬é«” ========== */
  const DRAGON_BASE = {
    label:'å™´ç«é¾',
    kind: 'monster',
    ai:   'dragon',
    stats:{
      hp: 60,
      atk: 16,
      spd: 160,         // è¿½æ“Šé€Ÿåº¦
      patrolSpd: 90,    // å·¡é‚é€Ÿåº¦
      hover: 0.9,
      accelY: 520,
      dampY: 0.90,
      touchCD: 0.70,
      knockVx: 380,
      knockVy: 520
    }
  };

  function ensureInit(e){
    const W = loadWorldSnapshot(); if(!W) return;
    if(!e._init){
      e._init = true;
      e.hp = (typeof e.hp==='number') ? e.hp : DRAGON_BASE.stats.hp;

      // å¤–è§€å°ºå¯¸ï¼ˆç¢°æ’ç›’ç•¥å°ï¼‰
      e.sizeTiles = e.sizeTiles || { w:1, h:1 };
      const T=W.T;
      e.w = Math.floor(e.sizeTiles.w * T * 0.78);
      e.h = Math.floor(e.sizeTiles.h * T * 0.78);

      // ç§»å‹•/ç‹€æ…‹
      e.vx ||= 0; e.vy ||= 0; e.face ||= 1; e._cool ||= 0;
      e._state = 'patrol';          // patrol | chase | die
      e._spawn = { x:e.x, y:e.y };
      e._patrolDir = Math.random()<0.5 ? -1 : 1;
      e._patrolSpan = (e.patrolSpanTiles||3) * T; // å·¦å³æ“ºå‹•åŠå¾‘
      e._detectRadiusM = (e.detectRadiusM ?? 15); // 15 å…¬å°º
      e._metersPerTile = (e.metersPerTile ?? 1);  // 1 æ ¼ â‰ˆ 1 å…¬å°º
      e._lostSightTimer = 0;
      e._hoverPhase = Math.random()*Math.PI*2;
    }
  }

  // åªåœ¨ã€ŒéŠç©æ¨¡å¼ã€æ‰å®‰å…¨å–å¾—ç©å®¶ï¼Œé¿å…åœ¨ç·¨è¼¯æ¨¡å¼èª¤ç”Ÿæˆç©å®¶
  function getPlayerIfPlaying(){
    try{
      if (typeof window.__getMode === 'function' && window.__getMode() === 'play' &&
          typeof window.__ensurePlayer === 'function'){
        return window.__ensurePlayer();
      }
    }catch{}
    return null;
  }

  ENT.dragon = {
    label: DRAGON_BASE.label,
    kind:  DRAGON_BASE.kind,
    ai:    DRAGON_BASE.ai,
    stats: { ...DRAGON_BASE.stats },

    spawn(opts={}){
      const W = loadWorldSnapshot(); const T=W?W.T:48;
      const e = {
        x: opts.x||0, y: opts.y||0,
        vx:0, vy:0, face:1, hp:opts.hp||DRAGON_BASE.stats.hp,
        sizeTiles: opts.sizeTiles || { w:3, h:3 },
        patrolSpanTiles: opts.patrolSpanTiles || 3,
        detectRadiusM: opts.detectRadiusM || 15,
        metersPerTile: opts.metersPerTile || 1
      };
      return e;
    },

    render(ctx, e){
      const now = performance.now()/1000;
      const dt  = Math.min(0.033, Math.max(0.001, now - (e._last||now)));
      e._last   = now; e._dt = dt;

      if(e._dead){
        if(!e._dieAt) e._dieAt = now;
        if(now - e._dieAt > 0.40){
          e.x = e.y = -1e6; e.w = e.h = 0; e.vx = e.vy = 0;
        }
        return;
      }

      ensureInit(e);
      const W = loadWorldSnapshot(); if(!W) return;

      // ===== AIï¼šå·¡é‚ï¼ˆç·¨è¼¯/éŠç©éƒ½è·‘ï¼‰ + è¦–ç·šè¿½æ“Šï¼ˆåƒ…éŠç©ä¸”çœ‹å¾—åˆ°ç©å®¶ï¼‰ =====
      const T = W.T;
      const meterToPx = T / (e._metersPerTile || 1);
      const radiusPx = (e._detectRadiusM || 15) * meterToPx;

      const p = getPlayerIfPlaying(); // ç·¨è¼¯æ¨¡å¼æ™‚ç‚º null
      const ex = e.x + e.w/2, ey = e.y + e.h/2;
      const hover = (DRAGON_BASE.stats.hover + 0.25*Math.sin(now*0.7 + e._hoverPhase)) * T;

      let canSee = false, dx=0, dy=0, dist=0;
      if (p){
        const px = p.x + p.w/2, py = p.y + p.h/2;
        dx = px - ex; dy = py - ey; dist = Math.hypot(dx,dy);
        canSee = (dist <= radiusPx) && hasLineOfSight(ex,ey, px,py, W);
      }

      if(e._state==='patrol'){
        // æ°¸é å·¡é‚ï¼ˆç·¨è¼¯æ¨¡å¼ä¹Ÿæœƒï¼‰
        const targetX = e._spawn.x + e._patrolDir * e._patrolSpan;
        const dir = Math.sign(targetX - e.x) || e._patrolDir;
        e.vx = dir * DRAGON_BASE.stats.patrolSpd;
        e.vy += ((e._spawn.y - hover) - (e.y + e.h/2) > 0 ? 1 : -1) * DRAGON_BASE.stats.accelY * dt;
        e.vy *= DRAGON_BASE.stats.dampY;
        moveWithCollisions(e, dt);
        e.face = (e.vx>=0 ? 1 : -1);
        if(Math.abs(e.x - targetX) < 6 || W.isSolidRect(e.x + dir*8, e.y, e.w, e.h)) e._patrolDir *= -1;

        // åªæœ‰ã€ŒéŠç©ï¼‹å¯è¦‹ç©å®¶ã€æ‰é€²å…¥è¿½æ“Š
        if(canSee){
          e._state='chase'; if(e._anim){ e._anim.name='fly'; e._anim.i=0; }
        }
      }else if(e._state==='chase'){
        // æ²’ç©å®¶ï¼ˆä¾‹å¦‚åˆ‡å›ç·¨è¼¯ï¼‰å°±é€€å›å·¡é‚
        if(!p){ e._state='patrol'; if(e._anim){ e._anim.name='idle'; e._anim.i=0; } }
        else{
          if(canSee){
            e._lostSightTimer = 0;
            const SPD = DRAGON_BASE.stats.spd;
            e.vx = Math.sign(dx) * SPD;
            const tgtY = (p.y + p.h/2) - hover;
            e.vy += ((tgtY > (e.y+e.h/2)) ? 1 : -1) * DRAGON_BASE.stats.accelY * dt;
            e.vy *= DRAGON_BASE.stats.dampY;
            moveWithCollisions(e, dt);
            e.face = (dx>=0 ? 1 : -1);

            // è¿‘èº«ç¢°æ’ â†’ å‚·å®³ + æ“Šé€€ï¼ˆå†·å»ï¼‰
            if (e._cool > 0) e._cool -= dt;
            const touchR = Math.max(32, T*0.9);
            if (dist < touchR && e._cool <= 0){
              const ps = window.ENT && window.ENT.player && window.ENT.player.stats;
              if (ps){
                const raw = DRAGON_BASE.stats.atk;
                const mitig = Math.max(0, raw - (ps.def||0)*0.5);
                ps.hp = Math.max(0, ps.hp - mitig);
              }
              const dir = Math.sign((p.x+p.w/2)-ex) || 1;
              p.vx = dir * DRAGON_BASE.stats.knockVx;
              p.vy = -DRAGON_BASE.stats.knockVy;
              e._cool = DRAGON_BASE.stats.touchCD;
              if(e._anim){ e._anim.name='attack'; e._anim.i=0; }
              if(SKIN.spawnFx){
                for(let i=0;i<8;i++){
                  SKIN.spawnFx({
                    x: ex + (Math.random()*12-6),
                    y: ey + (Math.random()*8-4),
                    vx: (dir*120)+(Math.random()*80-40), vy: -40-Math.random()*60,
                    r: 3+Math.random()*3, color:'rgba(255,120,40,0.9)', life:0.35, maxLife:0.35
                  });
                }
              }
            }
          }else{
            e._lostSightTimer += dt;
            if(e._lostSightTimer > 1.2){
              e._state='patrol'; e._lostSightTimer=0;
              if(e._anim){ e._anim.name='idle'; e._anim.i=0; }
            }else{
              const dir = Math.sign(dx)||e.face;
              e.vx = dir * (DRAGON_BASE.stats.patrolSpd*0.8);
              e.vy *= DRAGON_BASE.stats.dampY;
              moveWithCollisions(e, dt);
            }
          }
        }
      }

      // --- å—æ“Šç›’ï¼ˆDD_HITBOXï¼‰ ---
      if (!e._hb && window.DD_HITBOX){
        e._hb = DD_HITBOX.track(e, {
          team: 'enemy',
          getBounds: ()=>({ x:e.x, y:e.y, w:e.w, h:e.h }),
          getHP: ()=> e.hp,
          setHP: v => { e.hp = v; },
          iframes: 0.12,
          knock: { force: 420 },
          getVel: ()=>({ vx:e.vx||0, vy:e.vy||0 }),
          setVel: (vx,vy)=>{ e.vx=vx; e.vy=vy; },
          onHit:   (en)=>{ en._flash = 8; if(en._anim){ en._anim.name='hit'; en._anim.i=0; } },
          onDeath: (en)=>{
            const cx = en.x + en.w/2, cy = en.y + en.h/2;
            dropLootAt(cx, cy);
            try{
              if(window.SKIN && SKIN.spawnFx){
                SKIN.spawnFx({ x:cx, y:cy, r:24, vx:0, vy:-60, color:'rgba(255,200,40,0.95)', life:0.30, maxLife:0.30 });
                SKIN.spawnFx({ x:cx, y:cy, r:16, vx:0, vy:0, color:'rgba(90,0,120,0.85)', life:0.22, maxLife:0.22 });
              }
            }catch{}
            en._dead = true;
            if(en._anim){ en._anim.name='die'; en._anim.i=0; }
          }
        });
      }

      // --- è¦–è¦ºï¼šspritesheet æˆ–ä½”ä½é»‘é­”é¾ ---
      const drawer = SKIN && SKIN.ent && SKIN.ent.get && SKIN.ent.get('dragon');
      if (typeof drawer === 'function'){
        try{ drawer(ctx, e, now, window.THEME); return; }catch{}
      }
      drawBlackHexDragon(ctx, e, now);
    }
  };

  /* ========== çš®è†šè¨»å†Šï¼šå…ˆæ›ä¸Šä½”ä½ç•«æ³•ï¼Œä¿è­‰èª¿è‰²ç›¤æœ‰ã€Œå™´ç«é¾ã€ ========== */
  if (SKIN && SKIN.useEnt && (!SKIN.ent.get || !SKIN.ent.get('dragon'))){
    SKIN.useEnt('dragon', drawBlackHexDragon);
  }

  /* ========== èª¿è‰²ç›¤åˆ·æ–°ï¼ˆè‹¥æ€ªç‰©åˆ†é å·²é–‹ï¼‰ ========== */
  const monsBtn = document.querySelector('#palette .pill[data-cat="monsters"]');
  if (monsBtn && monsBtn.classList.contains('active')) monsBtn.click();

  /* ====== å‚™è¨» =========================================================
   * - ç¾åœ¨ã€Œç·¨è¼¯æ¨¡å¼ã€æ”¾ä¸Šå»å°±æœƒå·¡é‚ï¼›åˆ‡åˆ°ã€ŒéŠç©ã€ä¸”çœ‹å¾—åˆ°ç©å®¶æ™‚æ‰è¿½æ“Šã€‚
   * - è‹¥æ—¥å¾Œéœ€è¦åœ¨ç·¨è¼¯æ¨¡å¼ä¹Ÿæœ‰è¿½æ“Šï¼Œå¯æŠŠ getPlayerIfPlaying() æ”¹ç‚ºå›å‚³
   *   ä½ è‡ªå·±çš„ Dummy ç©å®¶ã€æˆ–æä¾›ä¸€å€‹ Showroom æ¨¡å¼å°ˆç”¨çš„è™›æ“¬ç›®æ¨™ã€‚
   * =================================================================== */
})();
</script>
<!-- ============ /Plugin: è¥¿æ–¹é»‘é­”é¾çµæŸv2 ============ -->

<!-- ============ Plugin: æš´é¾ T-REX v1.2ï¼ˆå¼·åˆ¶ç”¨ spritesheetï¼›è²¼åœ°å·¡é‚ï¼è¿½æ“Šï¼‹å’¬æ“Šï¼‹è¡€èŠ±FXï¼‹æ‰è½ï¼‰ ============ -->
<script>
(() => {
  'use strict';

  const ENT  = window.ENT  || (window.ENT  = {});
  const SKIN = window.SKIN || (window.SKIN = { ent:{ get:()=>null }, useEnt:()=>{} });

  /* ===== ä½¿ç”¨è€…å¯èª¿ï¼šç²¾éˆåœ–è¨­å®š ===== */
  const SHEET_URL  = 'assets/rex.png'; // â† ä½ çš„ PNG è·¯å¾‘ï¼ˆé è¨­ assets/rex.pngï¼‰
  const SHEET_COLS = 6;                // æ¬„æ•¸
  const SHEET_ROWS = 5;                // åˆ—æ•¸
  const DRAW_SCALE = 2.0;              // ç¹ªè£½ç¸®æ”¾å€ç‡

  /* ========== ä¸–ç•Œå¿«ç…§ï¼ˆä¾›ç¢°æ’èˆ‡å°ºå¯¸ï¼‰ ========== */
  const SAVEK = 'dd_skel_phase1';
  let _rawCache=null, _world=null, _lastSnap=0;

  function loadWorldSnapshot(force=false){
    const now = performance.now();
    if(!force && now - _lastSnap < 450) return _world;
    const raw = localStorage.getItem(SAVEK) || '';
    if(!force && raw === _rawCache) return _world;
    _lastSnap = now; _rawCache = raw;
    try{
      const d = JSON.parse(raw || '{}');
      const tiles = (d.tileRows||[]).map(r=>r.split(''));
      const T = d.tileSize || 48;
      _world = {
        w: d.w || 40, h: d.h || 24, T, tiles,
        tileAt(gx,gy){
          if(gx<0||gy<0||gx>=this.w||gy>=this.h) return '#';
          const row=this.tiles[gy]||[]; return row[gx]||'.';
        },
        isSolidRect(rx,ry,rw,rh){
          const T=this.T;
          const x0=Math.floor(rx/T), x1=Math.floor((rx+rw-1)/T);
          const y0=Math.floor(ry/T), y1=Math.floor((ry+rh-1)/T);
          for(let y=y0;y<=y1;y++){
            for(let x=x0;x<=x1;x++){
              if(this.tileAt(x,y)==='#') return true;
            }
          }
          return false;
        }
      };
    }catch{
      _world = { w:40, h:24, T:48, tiles:[],
        tileAt(){return '.';}, isSolidRect(){return false;}
      };
    }
    return _world;
  }

  /* ========== ç¢°æ’ç§»å‹• ========== */
  function moveWithCollisions(o, dt){
    const W = loadWorldSnapshot(); if(!W) return;
    // X
    let nx = o.x + o.vx*dt;
    if(!W.isSolidRect(nx, o.y, o.w, o.h)){ o.x = nx; }
    else{
      const dir = Math.sign(o.vx)||1;
      let px=o.x; while(!W.isSolidRect(px+dir, o.y, o.w, o.h)) px+=dir;
      o.x=px; o.vx=0;
    }
    // Y
    let ny = o.y + o.vy*dt; o.onGround=false;
    if(!W.isSolidRect(o.x, ny, o.w, o.h)){ o.y = ny; }
    else{
      const dir = Math.sign(o.vy)||1;
      let py=o.y; while(!W.isSolidRect(o.x, py+dir, o.w, o.h)) py+=dir;
      o.y=py; if(dir>0) o.onGround=true; o.vy=0;
    }
    // é‚Šç•Œ
    const maxX=W.w*W.T - o.w, maxY=W.h*W.T - o.h;
    o.x = Math.max(0, Math.min(maxX, o.x));
    o.y = Math.max(0, Math.min(maxY, o.y));
  }

  /* ========== è¦–ç·šï¼ˆLOSï¼‰ ========== */
  function hasLineOfSight(ax,ay,bx,by,W){
    const dx=bx-ax, dy=by-ay;
    const dist = Math.hypot(dx,dy)||1;
    const step = Math.max(4, Math.floor(W.T*0.5));
    const steps = Math.ceil(dist/step);
    for(let i=0;i<=steps;i++){
      const t = i/steps;
      const x = ax + dx*t, y = ay + dy*t;
      const gx = Math.floor(x/W.T), gy = Math.floor(y/W.T);
      if(W.tileAt(gx,gy)==='#') return false;
    }
    return true;
  }

  /* ========== æ‰è½ ========== */
  const TREX_DROP = {
    coins: { chance: 0.75, min:2, max:5, color:'rgba(255,211,78,0.9)' },
    loot:  { chance: 0.40, min:1, max:2, color:'rgba(160,200,255,0.95)'},
    meat:  { chance: 0.50, min:1, max:1, color:'rgba(200,40,40,0.95)'}
  };
  const R = (a,b)=>Math.floor(a + Math.random()*(b-a+1));
  function trexDropLootAt(x,y){
    const INV = window.INVENTORY || (window.INVENTORY = {meat:0, loot:0, coins:0});
    let msg=[];
    for(const [k,cfg] of Object.entries(TREX_DROP)){
      if(Math.random()<=cfg.chance){
        const n = R(cfg.min, cfg.max);
        INV[k] = (INV[k]|0) + n;
        msg.push((k==='coins'?'ğŸª™':'meat'===k?'ğŸ–':'ğŸ')+'x'+n);
        try{
          if(SKIN.spawnFx){
            for(let i=0;i<n;i++){
              SKIN.spawnFx({ x:x+(Math.random()*12-6), y:y-6,
                vx:(Math.random()*80-40), vy:-60-Math.random()*60,
                r: k==='meat'?4:5, color:cfg.color, life:0.5, maxLife:0.5 });
            }
          }
        }catch{}
      }
    }
    const box = document.getElementById('toastBox');
    if(box && msg.length){
      box.textContent = `ç²å¾— ${msg.join(' ')}`;
      box.style.background='#000b'; box.style.padding='8px 12px'; box.style.borderRadius='8px';
      clearTimeout(trexDropLootAt._t); trexDropLootAt._t = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
    }
    if(typeof window.refreshBag === 'function') window.refreshBag();
  }

  /* ========== è¡€èŠ± FXï¼ˆç”¨ SKIN.spawnFxï¼›è‹¥ç„¡å‰‡éœé»˜ï¼‰ ========== */
  function bloodBurst(x,y,dirX=1,dirY=0,power=1){
    try{
      if(!SKIN.spawnFx) return;
      const N = Math.floor(16 + 10*power);
      for(let i=0;i<N;i++){
        const ang = Math.atan2(dirY,dirX) + (Math.random()*0.9 - 0.45);
        const spd = 110 + Math.random()*260 * power;
        SKIN.spawnFx({
          x, y,
          vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd - (40 + Math.random()*60),
          r: 2 + Math.random()*3.5,
          color: (['rgba(210,20,20,0.95)','rgba(170,10,10,0.90)','rgba(120,0,0,0.85)','rgba(255,80,60,0.80)'])[(Math.random()*4)|0],
          life: 0.22 + Math.random()*0.26, maxLife: 0.22 + Math.random()*0.26
        });
      }
      for(let i=0;i<5;i++){
        SKIN.spawnFx({ x: x+(Math.random()*26-13), y: y+(Math.random()*10+6),
          vx:0, vy:0, r: 6+Math.random()*10, color:'rgba(120,0,0,0.55)',
          life: 1.2 + Math.random()*0.8, maxLife: 1.2 + Math.random()*0.8 });
      }
    }catch{}
  }

  /* ========== Spritesheet è¨»å†Šèˆ‡ç•«æ³• ========== */
  const SHEETS = (SKIN.sheets ||= {});
  function registerTrexSheet(url, cols, rows, name='trex_sheet'){
    // è‹¥å·²è¨»å†Šä¸” readyï¼Œå°±ç›´æ¥å›å‚³
    if(SHEETS[name]?.ready) return name;
    const img = new Image(); img.src = url;
    SHEETS[name] = { img, cols, rows, ready:false };
    img.onload = ()=>{ SHEETS[name].ready = true; };
    return name;
  }
  window.registerTrexSheet = registerTrexSheet;

  function makeTrexDrawer(sheetName='trex_sheet', scale=DRAW_SCALE){
    return function drawTrex(ctx, e, now){
      const sh = SHEETS[sheetName];
      if(!sh || !sh.ready) return drawTrexPlaceholder(ctx, e, now);
      e._anim ||= {
        name:'idle', i:0,
        map:{
          idle:  { frames:[0,1,2,3],      fps:6,  loop:true  },
          walk:  { frames:[4,5,6,7,8,9],  fps:9,  loop:true  },
          roar:  { frames:[10,11,12,13],  fps:6,  loop:false, next:'walk' },
          bite:  { frames:[14,15,16,17,18,19], fps:12, loop:false, next:'walk', hit:[17,18] },
          hurt:  { frames:[20,21],        fps:10, loop:false, next:'walk' },
          dead:  { frames:[22,23,24,25,26,27], fps:8, loop:false }
        }
      };
      const dt = e._dt||0.016;
      const A  = e._anim.map[e._anim.name] || e._anim.map.walk;
      e._anim.i += A.fps*dt;
      let idx = Math.floor(e._anim.i);
      const end = !A.loop && (idx >= A.frames.length);
      if(end){ e._anim.name = A.next || 'walk'; e._anim.i=0; idx=0; }
      const frame = A.frames[idx % A.frames.length];

      const cols = sh.cols|0||SHEET_COLS, rows = sh.rows|0||SHEET_ROWS;
      const fw = sh.img.width/cols, fh = sh.img.height/rows;
      const sx = (frame%cols)*fw, sy = Math.floor(frame/cols)*fh;

      const drawW = Math.max(fw*scale, e.w*1.4);
      const drawH = Math.max(fh*scale, e.h*1.2);

      ctx.save();
      if(e._flash>0){ ctx.globalAlpha = 0.65; e._flash--; }
      ctx.translate(e.x + e.w/2, e.y + e.h);
      ctx.scale(e.face>=0 ? 1 : -1, 1);
      ctx.drawImage(sh.img, sx, sy, fw, fh, -drawW/2, -drawH, drawW, drawH);
      ctx.restore();
    };
  }
  window.makeTrexDrawer = makeTrexDrawer;

  function drawTrexPlaceholder(ctx,e,t){
    const cx=e.x+e.w/2, cy=e.y+e.h;
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,0.28)'; ctx.beginPath(); ctx.ellipse(cx, cy, e.w*0.45, e.h*0.16, 0,0,Math.PI*2); ctx.fill();
    ctx.translate(cx, cy); ctx.scale(e.face>=0?1:-1,1);
    ctx.fillStyle='#2b513a'; ctx.fillRect(-e.w*0.6, -e.h*0.9, e.w*1.2, e.h*0.9);
    ctx.fillStyle='#4b7a58'; ctx.fillRect(-e.w*0.2, -e.h*1.2, e.w*0.6, e.h*0.4);
    ctx.fillStyle='#9d2b2b'; ctx.fillRect(e.w*0.3, -e.h*1.05, 10, 6);
    ctx.restore();
  }

  /* ========== åªåœ¨éŠç©æ¨¡å¼å®‰å…¨å–å¾—ç©å®¶ ========== */
  function getPlayerIfPlaying(){
    try{
      if (typeof window.__getMode === 'function' && window.__getMode() === 'play' &&
          typeof window.__ensurePlayer === 'function'){
        return window.__ensurePlayer();
      }
    }catch{}
    return null;
  }

  /* ========== æš´é¾ï¼ˆè²¼åœ° AIï¼‰ ========== */
  const TREX_BASE = {
    label:'æš´é¾',
    kind:'monster',
    ai:'trex',
    stats:{
      hp: 220, atk: 18, def: 4,
      spd: 140, patrolSpd: 90,
      biteCD: 0.8, touchCD: 0.60,
      biteRange: 64, knockVx: 380, knockVy: 520
    }
  };

  ENT.trex = {
    label: TREX_BASE.label,
    kind:  TREX_BASE.kind,
    ai:    TREX_BASE.ai,
    stats: { ...TREX_BASE.stats },

    spawn(opts={}){
      const W = loadWorldSnapshot(); const T=W?W.T:48;
      const e = {
        x: opts.x||0, y: opts.y||0, vx:0, vy:0, face:1,
        hp: (typeof opts.hp==='number')?opts.hp:TREX_BASE.stats.hp,
        sizeTiles: opts.sizeTiles || { w:3, h:2 },
        detectRadiusM: opts.detectRadiusM || 15,
        metersPerTile: opts.metersPerTile || 1,
        patrolSpanTiles: opts.patrolSpanTiles || 3
      };
      return e;
    },

    render(ctx, e){
      const now = performance.now()/1000;
      const dt  = Math.min(0.033, Math.max(0.001, now - (e._last||now)));
      e._last   = now; e._dt = dt;

      if(e._dead){
        if(!e._dieAt) e._dieAt = now;
        if(now - e._dieAt > 0.60){ e.x = e.y = -1e6; e.w = e.h = 0; e.vx = e.vy = 0; }
        return;
      }

      const W = loadWorldSnapshot(); if(!W) return;

      if(!e._init){
        e._init = true;
        e.hp = (typeof e.hp==='number') ? e.hp : TREX_BASE.stats.hp;
        const T=W.T;
        e.w = Math.floor((e.sizeTiles?.w||3) * T * 0.75);
        e.h = Math.floor((e.sizeTiles?.h||2) * T * 0.80);
        e.vx ||= 0; e.vy ||= 0; e.face ||= 1; e._cool ||= 0; e._biteCD=0;
        e._state='patrol';
        e._spawn = { x:e.x, y:e.y };
        e._dir = Math.random()<0.5 ? -1 : 1;
        e._span = (e.patrolSpanTiles||3) * T;
        e._metersPerTile = e.metersPerTile || 1;
      }

      // é‡åŠ›
      const GRAV = 1800; e.vy += GRAV * dt;

      // è¦–é‡/ç©å®¶
      const meterToPx = W.T / (e._metersPerTile || 1);
      const radiusPx  = (e.detectRadiusM || 15) * meterToPx;
      const p = getPlayerIfPlaying();
      const ex=e.x+e.w/2, ey=e.y+e.h/2;
      let dx=0, dy=0, dist=1e9, canSee=false;

      if(p){
        const px=p.x+p.w/2, py=p.y+p.h/2;
        dx=px-ex; dy=py-ey; dist=Math.hypot(dx,dy);
        canSee = (dist<=radiusPx) && hasLineOfSight(ex,ey, px,py, W);
      }

      // AI
      if(e._state==='patrol'){
        const targetX = e._spawn.x + e._dir * e._span;
        const dir = Math.sign(targetX - e.x) || e._dir;
        e.vx = dir * TREX_BASE.stats.patrolSpd;

        moveWithCollisions(e, dt);
        if(e.onGround && e.vy>0) e.vy = 0;
        e.face = (e.vx>=0 ? 1 : -1);

        if(Math.abs(e.x - targetX) < 6 || W.isSolidRect(e.x + dir*8, e.y, e.w, e.h)) e._dir *= -1;

        if(canSee){ e._state='chase'; if(e._anim){ e._anim.name='walk'; e._anim.i=0; } }
      }
      else if(e._state==='chase'){
        if(!p){ e._state='patrol'; if(e._anim){ e._anim.name='idle'; e._anim.i=0; } }
        else{
          if(canSee){
            e._lostT=0;
            const dir = (dx>=0)?1:-1;
            e.vx = dir * TREX_BASE.stats.spd;
            e.face = dir>0?1:-1;

            if(e._biteCD>0) e._biteCD -= dt;

            moveWithCollisions(e, dt);
            if(e.onGround && e.vy>0) e.vy = 0;

            // å’¬æ“Š
            if(dist <= TREX_BASE.stats.biteRange && e._biteCD<=0){
              e._biteCD = TREX_BASE.stats.biteCD;
              if(e._anim){ e._anim.name='bite'; e._anim.i=0; }
              setTimeout(()=> {
                if(!p) return;
                const px=p.x+p.w/2, py=p.y+p.h/2;
                const hit = Math.hypot(px-(e.x+(e.face>0?e.w+18:-18)), py-(e.y+e.h*0.5)) <= TREX_BASE.stats.biteRange*0.75;
                if(hit){
                  if(typeof window.__applyDamageToPlayer==='function'){
                    window.__applyDamageToPlayer(TREX_BASE.stats.atk);
                  }else if(ENT.player?.stats){
                    const ps = ENT.player.stats;
                    const taken = Math.max(1, TREX_BASE.stats.atk - (ps.def||0));
                    ps.hp = Math.max(0, ps.hp - taken);
                  }
                  const dir2 = (px>ex)?1:-1;
                  p.vx = dir2 * TREX_BASE.stats.knockVx;
                  p.vy = -TREX_BASE.stats.knockVy;
                  bloodBurst(px, py, dir2, 0, 0.9);
                }
              }, 120);
            }
          }else{
            e._lostT = (e._lostT||0) + dt;
            if(e._lostT > 1.2){ e._state='patrol'; e._lostT=0; if(e._anim){e._anim.name='idle'; e._anim.i=0;} }
            else{
              const dir = Math.sign(dx)||e.face;
              e.vx = dir*(TREX_BASE.stats.patrolSpd*0.8);
              moveWithCollisions(e, dt);
              if(e.onGround && e.vy>0) e.vy = 0;
            }
          }
        }
      }

      // è¢«ç©å®¶æ‰“åˆ°ï¼ˆDD_HITBOXï¼‰
      if (!e._hb && window.DD_HITBOX){
        e._hb = DD_HITBOX.track(e, {
          team: 'enemy',
          getBounds: ()=>({ x:e.x, y:e.y, w:e.w, h:e.h }),
          getHP: ()=> e.hp,
          setHP: v => { e.hp = v; },
          iframes: 0.18,
          knock: { force: 480 },
          getVel: ()=>({ vx:e.vx||0, vy:e.vy||0 }),
          setVel: (vx,vy)=>{ e.vx=vx; e.vy=vy; },
          onHit:   (en,info)=>{ en._flash = 8; if(en._anim){ en._anim.name='hurt'; en._anim.i=0; }
                                bloodBurst(en.x+en.w/2, en.y+en.h*0.6, (info?.dirX)||-en.face, 0, 1.0); },
          onDeath: (en)=>{ const cx=en.x+en.w/2, cy=en.y+en.h*0.6;
                           trexDropLootAt(cx, cy);
                           try{ if(SKIN.spawnFx){
                             SKIN.spawnFx({ x:cx, y:cy, r:24, vx:0, vy:-60, color:'rgba(255,200,40,0.95)', life:0.30, maxLife:0.30 });
                             SKIN.spawnFx({ x:cx, y:cy, r:18, vx:0, vy:0,   color:'rgba(110,0,0,0.85)',    life:0.22, maxLife:0.22 });
                           }}catch{}
                           en._dead = true; if(en._anim){ en._anim.name='dead'; en._anim.i=0; } }
        });
      }

      // è¦–è¦ºï¼šspritesheet æˆ–ä½”ä½
      const drawer = SKIN && SKIN.ent && SKIN.ent.get && SKIN.ent.get('trex');
      if (typeof drawer === 'function'){
        try{ drawer(ctx, e, now, window.THEME); return; }catch{}
      }
      drawTrexPlaceholder(ctx, e, now);
    }
  };

  /* ========== å•Ÿç”¨ï¼šè¨»å†Šåœ–é›† + å¼·åˆ¶è¦†è“‹ç•«æ³•ï¼ˆå«å¿«å–ç ´å£ç¢¼ï¼›è¼‰å…¥å¾Œå†å¥—ï¼‰ ========== */
  const bust = (SHEET_URL.includes('?') ? '&' : '?') + 'v=' + Date.now();
  const SHEET_NAME = registerTrexSheet(SHEET_URL + bust, SHEET_COLS, SHEET_ROWS);

  function applyTrexDrawer(){
    try{
      if (window.SKIN && typeof SKIN.useEnt === 'function'){
        SKIN.useEnt('trex', makeTrexDrawer(SHEET_NAME, DRAW_SCALE)); // â˜… å¼·åˆ¶è¦†è“‹
        console.log('[T-REX] spritesheet drawer å·²å¥—ç”¨ï¼š', SHEET_URL);
      }
      window.dispatchEvent(new Event('dd:skin-updated'));
      const monsBtn = document.querySelector('#palette .pill[data-cat="monsters"]');
      if (monsBtn && monsBtn.classList.contains('active')) monsBtn.click();
    }catch(err){ console.warn('[T-REX] å¥—ç”¨ç•«æ³•å¤±æ•—', err); }
  }

  try{
    const sh = (window.SKIN?.sheets || {})[SHEET_NAME];
    if (sh?.img?.complete) applyTrexDrawer();
    else sh?.img?.addEventListener('load', applyTrexDrawer, { once:true });
  }catch{ applyTrexDrawer(); }

})();
</script>


<script>
(() => {
  // ä¾ä½ çš„å¯¦éš›è·¯å¾‘/æ ¼æ•¸èª¿æ•´
  const SHEET_URL  = 'assets/rex.png';
  const SHEET_COLS = 6;
  const SHEET_ROWS = 5;
  const DRAW_SCALE = 2.0;

  // 1) è¨»å†Š spritesheetï¼ˆåŠ  cache-bustï¼‰
  const bust = (SHEET_URL.includes('?') ? '&' : '?') + 'v=' + Date.now();
  const SHEET_NAME = (window.registerTrexSheet
    ? registerTrexSheet(SHEET_URL + bust, SHEET_COLS, SHEET_ROWS)
    : 'trex_sheet');

  // 2) å»ºç«‹ drawerï¼ˆçœŸæ­£ç•«åœ–çš„å‡½å¼ï¼‰
  const __trex_drawer = (window.makeTrexDrawer
    ? makeTrexDrawer(SHEET_NAME, DRAW_SCALE)
    : null);

  // 3) ç›¸å®¹æ€§ï¼šä¸è«–ä½ çš„ SKIN.useEnt éœ€è¦ function æˆ– {draw} ç‰©ä»¶ï¼Œéƒ½å¡å¾—é€²å»
  function applyTrexDrawerCompat() {
    try {
      if (!window.SKIN) return;
      const entry = (typeof __trex_drawer === 'function')
        ? __trex_drawer
        : (v)=>v; // Safety

      // A) å˜—è©¦å‡½å¼ç‰ˆ
      try { SKIN.useEnt && SKIN.useEnt('trex', entry); } catch {}

      // B) è‹¥ç³»çµ±ç”¨ç‰©ä»¶ç‰ˆï¼ˆget('trex')å›å‚³objectï¼‰ï¼Œå†ç”¨ç‰©ä»¶å½¢å¼è¦†å¯«ä¸€æ¬¡
      const got = SKIN?.ent?.get && SKIN.ent.get('trex');
      if (got && typeof got !== 'function') {
        const obj = { ...(got||{}), draw: __trex_drawer, name: (got.name || 'trex') };
        SKIN.useEnt && SKIN.useEnt('trex', obj);
      }

      // C) paletteåˆ·æ–°ï¼ˆè‹¥æ€ªç‰©åˆ†é å·²é–‹ï¼‰
      const monsBtn = document.querySelector('#palette .pill[data-cat="monsters"]');
      if (monsBtn && monsBtn.classList.contains('active')) monsBtn.click();
    } catch (e) {
      console.warn('[T-REX] applyTrexDrawerCompat failed:', e);
    }
  }

  // 4) ç­‰åœ–ç‰‡ ready å†å¥—ï¼›è‹¥å·²è¼‰å¥½å‰‡ç«‹åˆ»å¥—
  try {
    const sh = (SKIN?.sheets || {})[SHEET_NAME];
    if (sh?.img?.complete) applyTrexDrawerCompat();
    else sh?.img?.addEventListener('load', applyTrexDrawerCompat, { once: true });
  } catch {
    applyTrexDrawerCompat();
  }

  // 5) é˜²å‘†ï¼šæ¨¡å¼åˆ‡æ›/é é¢è¿”å›æ™‚å†å¥—ä¸€æ¬¡ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶åè¦†è¦†å¯«
  window.addEventListener('dd:mode-change', applyTrexDrawerCompat);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) applyTrexDrawerCompat(); });

  // 6) æ‰‹å‹•æ•‘æ´éˆ•ï¼ˆæƒ³æ‰‹å‹•é‡å¥—å°±åœ¨ Console æ‰“é€™è¡Œï¼‰
  window.__trex_reapply = applyTrexDrawerCompat;

  // 7) æ¸²æŸ“ç«¯ä¹ŸåŠ ç›¸å®¹è®€å–ï¼šè‹¥ get('trex') å›å‚³ç‰©ä»¶ï¼Œå°±å‘¼å« .draw/.render
  //    â€”â€”é€™æ®µæœƒæ³¨å…¥ä¸€å€‹å°ä»£ç†ï¼Œè®“ ENT.trex.render åœ¨æ‰¾ä¸åˆ°å‡½å¼æ™‚ä¹Ÿèƒ½ç•«
  const _origRender = window.ENT?.trex?.render;
  if (typeof _origRender === 'function') {
    window.ENT.trex.render = function(ctx, e) {
      // å…ˆè·‘åŸæœ¬é‚è¼¯ï¼ˆå«AI/ç‰©ç†ï¼‰
      _origRender.apply(this, arguments);

      // å¦‚æœåŸæœ¬é‚è¼¯æœ€å¾Œç”¨çš„æ˜¯ä½”ä½åœ–ï¼Œé€™è£¡å†å˜—è©¦ç›´æ¥ç•« spritesheetï¼ˆé˜²æ­¢å–åˆ°çš„æ˜¯ç‰©ä»¶ï¼‰
      try {
        const got = SKIN?.ent?.get && SKIN.ent.get('trex');
        let drawer = null;
        if (typeof got === 'function') drawer = got;
        else if (got && typeof got.draw === 'function') drawer = got.draw;
        else if (got && typeof got.render === 'function') drawer = got.render;
        // fallbackï¼šç›´æ¥ç”¨æˆ‘å€‘å‰›é€ çš„ drawer
        if (!drawer && typeof __trex_drawer === 'function') drawer = __trex_drawer;

        // å¯ä»¥ç•«çš„è©±å°±ç•«ï¼ˆè¦†è“‹ä½”ä½ï¼‰
        if (typeof drawer === 'function') {
          const now = performance.now() / 1000;
          drawer(ctx, e, now);
        }
      } catch {}
    };
  }
})();
</script>


<!-- ============ /Plugin: æš´é¾ T-REX v1.2 çµæŸ ============ -->


<!-- ============ Plugin: å²èŠå§†ï¼ˆå¯åˆé«”ï¼šä½è¡€æ™‚èšé›†â†’å·¨å¤§åŒ–ï¼‰ ============ -->
<script>
(() => {
  'use strict';

  const ENT  = window.ENT  || (window.ENT  = {});
  const SKIN = window.SKIN || (window.SKIN = { ent:{ get:()=>null }, useEnt:()=>{} });

  /* ========== ä¸–ç•Œå¿«ç…§ï¼ˆä¾›ç¢°æ’èˆ‡å°ºå¯¸ï¼‰ ========== */
  const SAVEK = 'dd_skel_phase1';
  let _rawCache=null, _world=null, _lastSnap=0;

  function loadWorldSnapshot(force=false){
    const now = performance.now();
    if(!force && now - _lastSnap < 450) return _world;
    const raw = localStorage.getItem(SAVEK) || '';
    if(!force && raw === _rawCache) return _world;
    _lastSnap = now; _rawCache = raw;
    try{
      const d = JSON.parse(raw || '{}');
      const tiles = (d.tileRows||[]).map(r=>r.split(''));
      const T = d.tileSize || 48;
      _world = {
        w: d.w || 40, h: d.h || 24, T, tiles,
        tileAt(gx,gy){
          if(gx<0||gy<0||gx>=this.w||gy>=this.h) return '#';
          const row=this.tiles[gy]||[]; return row[gx]||'.';
        },
        isSolidRect(rx,ry,rw,rh){
          const T=this.T;
          const x0=Math.floor(rx/T), x1=Math.floor((rx+rw-1)/T);
          const y0=Math.floor(ry/T), y1=Math.floor((ry+rh-1)/T);
          for(let y=y0;y<=y1;y++){
            for(let x=x0;x<=x1;x++){
              if(this.tileAt(x,y)==='#') return true;
            }
          }
          return false;
        }
      };
    }catch{
      _world = { w:40, h:24, T:48, tiles:[],
        tileAt(){return '.';}, isSolidRect(){return false;}
      };
    }
    return _world;
  }

  function moveWithCollisions(o, dt){
    const W = loadWorldSnapshot(); if(!W) return;
    // æ°´å¹³
    let nx = o.x + o.vx*dt;
    if(!W.isSolidRect(nx, o.y, o.w, o.h)){ o.x = nx; }
    else{
      const dir = Math.sign(o.vx)||1;
      let px=o.x; while(!W.isSolidRect(px+dir, o.y, o.w, o.h)) px+=dir;
      o.x=px; o.vx=0;
    }
    // å‚ç›´ï¼ˆç°¡å–®é‡åŠ›/å½ˆæ€§è½åœ°ï¼‰
    o.vy += (o._grav||900) * dt;
    let ny = o.y + o.vy*dt; o.onGround=false;
    if(!W.isSolidRect(o.x, ny, o.w, o.h)){ o.y = ny; }
    else{
      const dir = Math.sign(o.vy)||1;
      let py=o.y; while(!W.isSolidRect(o.x, py+dir, o.w, o.h)) py+=dir;
      o.y=py; if(dir>0){ o.onGround=true; o.vy = -Math.abs(o.vy)* (o._bounce||0.12); if(Math.abs(o.vy)<30) o.vy=0; } else { o.vy=0; }
    }
    // é‚Šç•Œå¤¾é™
    const maxX=W.w*W.T - o.w, maxY=W.h*W.T - o.h;
    o.x = Math.max(0, Math.min(maxX, o.x));
    o.y = Math.max(0, Math.min(maxY, o.y));
  }

  /* ========== è¦–ç·šï¼ˆLOSï¼‰æª¢æ¸¬ï¼šå¯é¸ï¼ˆå²èŠå§†è¿‘æˆ°ç‚ºä¸»ï¼‰ ========== */
  function hasLineOfSight(ax,ay,bx,by,W){
    const dx=bx-ax, dy=by-ay;
    const dist = Math.hypot(dx,dy)||1;
    const step = Math.max(4, Math.floor(W.T*0.5));
    const steps = Math.ceil(dist/step);
    for(let i=0;i<=steps;i++){
      const t = i/steps;
      const x = ax + dx*t, y = ay + dy*t;
      const gx = Math.floor(x/W.T), gy = Math.floor(y/W.T);
      if(W.tileAt(gx,gy)==='#') return false;
    }
    return true;
  }

  /* ========== æ‰è½ï¼ˆèˆ‡é¾ç‰ˆä¸€è‡´ï¼‰ ========== */
  const DROP = {
    coin: { chance: 0.60, min:1, max:3 },
    loot: { chance: 0.35, min:1, max:2 },
    meat: { chance: 0.25, min:1, max:1 }
  };
  function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
  function tryDrop(kind, inv, x, y, color){
    const cfg = DROP[kind]; if(!cfg) return 0;
    if(Math.random() > cfg.chance) return 0;
    const n = randInt(cfg.min, cfg.max);
    const key = (kind==='coin' ? 'coins' : kind);
    inv[key] = (inv[key]|0) + n;
    try{
      if(window.SKIN && SKIN.spawnFx){
        for(let i=0;i<n;i++){
          SKIN.spawnFx({ x:x+(Math.random()*12-6), y:y-6, vx:(Math.random()*80-40), vy:-60-Math.random()*60,
            r: kind==='meat'?4:5, color, life:0.5, maxLife:0.5 });
        }
      }
    }catch{}
    return n;
  }
  function dropLootAt(x,y){
    const INV = window.INVENTORY || (window.INVENTORY = {meat:0, loot:0, coins:0});
    const c = tryDrop('coin', INV, x,y, 'rgba(255,211,78,0.9)');
    const l = tryDrop('loot', INV, x,y, 'rgba(160,200,255,0.95)');
    const m = tryDrop('meat', INV, x,y, 'rgba(120,255,170,0.95)');
    const box = document.getElementById('toastBox');
    if(box && (c||l||m)){
      let msg = ''; if(c) msg += `ğŸª™x${c} `; if(l) msg += `ğŸx${l} `; if(m) msg += `ğŸ–x${m}`;
      box.textContent = `ç²å¾— ${msg.trim()}`;
      box.style.background='#000b'; box.style.padding='8px 12px'; box.style.borderRadius='8px';
      clearTimeout(dropLootAt._t); dropLootAt._t = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
    }
    if(typeof window.refreshBag === 'function') window.refreshBag();
  }

  /* ========== Spritesheetï¼ˆå¯é¸ï¼‰ ========== */
  const SHEETS = (SKIN.sheets ||= {});
  function registerSlimeSheet(url, cols, rows, name='slime_sheet'){
    const img = new Image(); img.src = url;
    SHEETS[name] = { img, cols, rows, ready:false };
    img.onload = ()=>{ SHEETS[name].ready = true; };
    return name;
  }
  window.registerSlimeSheet = registerSlimeSheet;

  function makeSlimeDrawer(sheetName='slime_sheet', scale=1.8){
    return function drawSlimeSheet(ctx, e, now){
      const sheet = SHEETS[sheetName];
      if(!sheet || !sheet.ready) return drawGreenBlob(ctx, e, now);
      e._anim ||= {
        name:'idle', t:0, i:0,
        map:{
          idle:   { frames:[0,1,2,1],       fps:5,  loop:true  },
          hop:    { frames:[3,4,5,4],       fps:8,  loop:true  },
          merge:  { frames:[6,7,8,9],       fps:9,  loop:false, next:'idle' },
          hit:    { frames:[10],            fps:1,  loop:false, next:'idle' },
          die:    { frames:[11],            fps:6,  loop:false }
        }
      };
      e._anim.t += (e._dt||0.016);
      const A = e._anim.map[e._anim.name] || e._anim.map.idle;
      e._anim.i += A.fps*(e._dt||0.016);
      let frame = A.frames[Math.floor(e._anim.i)%A.frames.length];
      if(!A.loop && e._anim.i >= A.frames.length){
        e._anim.name = A.next || 'idle'; e._anim.i = 0;
        frame = (e._anim.map[e._anim.name]||A).frames[0];
      }
      const cols = sheet.cols|0||4, rows = sheet.rows|0||3;
      const fw = sheet.img.width/cols, fh = sheet.img.height/rows;
      const sx = (frame%cols)*fw, sy = Math.floor(frame/cols)*fh;

      const drawW = Math.max(fw*scale*(1+0.25*(e._stack-1)), e.w*1.05);
      const drawH = Math.max(fh*scale*(1+0.20*(e._stack-1)), e.h*1.05);

      ctx.save();
      if(e._flash>0){ ctx.globalAlpha=0.65; e._flash--; }
      ctx.translate(e.x + e.w/2, e.y + e.h/2 + Math.sin(now*6 + e._phase)*2);
      ctx.drawImage(sheet.img, sx, sy, fw, fh, -drawW/2, -drawH/2, drawW, drawH);
      ctx.restore();
    };
  }
  window.makeSlimeDrawer = makeSlimeDrawer;

  /* ========== ä½”ä½ï¼šç¶ è‰²è† å²èŠå§† ========== */
  function drawGreenBlob(ctx, e, t){
    const cx=e.x+e.w/2, cy=e.y+e.h/2;
    // åœ°å½±
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,0.25)';
    ctx.beginPath(); ctx.ellipse(e.x+e.w/2, e.y+e.h, Math.max(12,e.w*0.46), Math.max(6,e.h*0.18), 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    ctx.save();
    ctx.translate(cx, cy + Math.sin(t*6 + e._phase)*2);
    const rX = e.w*0.45, rY = e.h*0.35;
    // å¤–å…‰
    const g = ctx.createRadialGradient(0,-rY*0.3, rX*0.1, 0,0, rX);
    g.addColorStop(0,'rgba(120,255,170,0.95)');
    g.addColorStop(1,'rgba(60,160,110,0.85)');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.ellipse(0,0,rX,rY,0,0,Math.PI*2); ctx.fill();

    // é«˜å…‰
    ctx.globalAlpha=0.7;
    ctx.fillStyle='rgba(255,255,255,0.75)';
    ctx.beginPath(); ctx.ellipse(-rX*0.25, -rY*0.35, rX*0.25, rY*0.18, 0,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;

    // è‡‰
    ctx.fillStyle='#0b1e10';
    ctx.beginPath(); ctx.arc(-rX*0.18, -rY*0.05, 3+2*(e._stack-1), 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( rX*0.18, -rY*0.05, 3+2*(e._stack-1), 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#143d20';
    ctx.beginPath(); ctx.ellipse(0, rY*0.20, rX*0.20, rY*0.10, 0, 0, Math.PI); ctx.fill();
    ctx.restore();
  }

  /* ========== å·¥å…·ï¼šç©å®¶ï¼ˆåƒ…éŠç©æ¨¡å¼æ‰å–ï¼‰ ========== */
  function getPlayerIfPlaying(){
    try{
      if (typeof window.__getMode === 'function' && window.__getMode() === 'play' &&
          typeof window.__ensurePlayer === 'function'){
        return window.__ensurePlayer();
      }
    }catch{}
    return null;
  }

  /* ========== å…¨åŸŸï¼šæŠŠåœ¨å ´å²èŠå§†æ”¶éŒ„ä»¥ä¾¿äº’ç›¸å°‹æ‰¾ ========== */
  const SL_POOL = new Set(); // å­˜æ”¾ entity åƒè€ƒ
  function poolAdd(e){ SL_POOL.add(e); }
  function poolDel(e){ SL_POOL.delete(e); }
  function forEachSlimeNear(e, radiusPx, cb){
    const ex = e.x + e.w/2, ey = e.y + e.h/2;
    for(const other of SL_POOL){
      if(other===e || other._dead) continue;
      const ox = other.x + other.w/2, oy = other.y + other.h/2;
      const d = Math.hypot(ox-ex, oy-ey);
      if(d <= radiusPx) cb(other, d);
    }
  }

  /* ========== å²èŠå§†æœ¬é«” ========== */
  const SLIME_BASE = {
    label:'å²èŠå§†',
    kind: 'monster',
    ai:   'slime',
    stats:{
      hp: 30,
      atk: 8,
      spd: 90,          // å·¡é‚/é æ”é€Ÿåº¦
      chaseSpd: 120,    // è¿½ç©å®¶
      touchCD: 0.8,
      knockVx: 280,
      knockVy: 420
    }
  };

  function ensureInit(e){
    const W = loadWorldSnapshot(); if(!W) return;
    if(!e._init){
      e._init = true;
      e.hp = (typeof e.hp==='number') ? e.hp : SLIME_BASE.stats.hp;
      e.maxHp = e.maxHp || e.hp;
      e._stack = e._stack || 1;        // åˆé«”æ•¸ï¼ˆåŒ…å«è‡ªå·±ï¼‰
      e._phase = Math.random()*Math.PI*2;
      e.sizeTiles = e.sizeTiles || { w:1, h:1 };

      const T=W.T;
      const scale = 1 + 0.55*(e._stack-1);
      e.w = Math.floor(e.sizeTiles.w * T * 0.72 * scale);
      e.h = Math.floor(e.sizeTiles.h * T * 0.62 * scale);

      e.vx ||= 0; e.vy ||= 0; e.face ||= 1; e._cool ||= 0;
      e._state = 'wander';   // wander | chase | merge_seek | die
      e._grav = 900; e._bounce = 0.14;
      e._spawn = { x:e.x, y:e.y };
      poolAdd(e);
    }
  }

  function applyStackScaling(e){
    // ä¾åˆé«”æ•¸èª¿æ•´ size / æ”»æ“Š / è§¸ç¢°åŠå¾‘ / HP ä¸Šé™
    const W = loadWorldSnapshot(); const T=W?W.T:48;
    const scale = 1 + 0.55*(e._stack-1);
    e.w = Math.floor((e.sizeTiles?.w||1) * T * 0.72 * scale);
    e.h = Math.floor((e.sizeTiles?.h||1) * T * 0.62 * scale);
    e._touchR = Math.max(22, Math.min(120, T*0.6 * scale));
    e._atkNow = Math.round(SLIME_BASE.stats.atk * (1 + 0.70*(e._stack-1)));
    e.maxHp   = Math.round((e.maxHp||SLIME_BASE.stats.hp) * (1 + 0.90*(e._stack-1)));
    // ä¸ç›´æ¥å›æ»¿ï¼šä¿ç•™ç•¶å‰ hp æ¯”ä¾‹
    const ratio = Math.max(0.05, Math.min(1, e.hp / Math.max(1,e.maxHp)));
    e.hp = Math.max(1, Math.round(ratio * e.maxHp));
  }

  // åˆé«”ï¼šleader å¸æ”¶ targetï¼ˆtarget è¢«æ¨™è¨˜æ­»äº¡/æ·¡å‡ºï¼‰
  function absorb(leader, target){
    if(leader._dead || target._dead) return false;
    // åƒ…åœ¨é›™æ–¹éƒ½ã€Œå¯åˆé«”ã€æ™‚å¸æ”¶ï¼ˆhp â‰¤ 30%ï¼‰
    const ready = (x)=> (x.hp / Math.max(1,x.maxHp)) <= 0.30;
    if(!ready(leader) || !ready(target)) return false;

    leader._stack = (leader._stack|0) + (target._stack|0||1);
    leader.maxHp  = Math.round(leader.maxHp + target.maxHp);
    leader.hp     = Math.min(leader.maxHp, leader.hp + Math.round(target.hp*0.8)); // å¸¶é»ä¿ç•™
    applyStackScaling(leader);
    leader._anim && (leader._anim.name='merge', leader._anim.i=0);
    // target æ¶ˆå¤±ï¼ˆæ‰ä¸€é» goo ç‰¹æ•ˆï¼‰
    try{
      if(window.SKIN && SKIN.spawnFx){
        const cx = target.x+target.w/2, cy=target.y+target.h/2;
        for(let i=0;i<10;i++){
          SKIN.spawnFx({ x:cx+(Math.random()*8-4), y:cy+(Math.random()*6-3),
            vx:(Math.random()*160-80), vy:-30-Math.random()*80, r:3+Math.random()*3,
            color:'rgba(120,255,170,0.9)', life:0.4, maxLife:0.4 });
        }
      }
    }catch{}
    // æ¨™è¨˜æ­»äº¡â†’æ·¡å‡º
    target._dead = true; target._dieAt = performance.now()/1000;
    target.w = Math.max(1, target.w*0.6); target.h = Math.max(1, target.h*0.6);
    return true;
  }

  ENT.slime = {
    label: SLIME_BASE.label,
    kind:  SLIME_BASE.kind,
    ai:    SLIME_BASE.ai,
    stats: { ...SLIME_BASE.stats },

    spawn(opts={}){
      const W = loadWorldSnapshot(); const T=W?W.T:48;
      const e = {
        x: opts.x||0, y: opts.y||0,
        vx:0, vy:0, face:1,
        hp: opts.hp||SLIME_BASE.stats.hp,
        maxHp: opts.maxHp||SLIME_BASE.stats.hp,
        sizeTiles: opts.sizeTiles || { w:1, h:1 },
        _stack: opts.stack||1
      };
      return e;
    },

    render(ctx, e){
      const now = performance.now()/1000;
      const dt  = Math.min(0.033, Math.max(0.001, now - (e._last||now)));
      e._last   = now; e._dt = dt;

      if(e._dead){
        poolDel(e);
        if(!e._dieAt) e._dieAt = now;
        ctx.save(); const k = Math.max(0, 1 - (now - e._dieAt)/0.35);
        ctx.globalAlpha = k; drawGreenBlob(ctx, e, now); ctx.restore();
        if(now - e._dieAt > 0.40){
          e.x = e.y = -1e6; e.w = e.h = 0; e.vx = e.vy = 0;
        }
        return;
      }

      ensureInit(e);
      applyStackScaling(e);
      const W = loadWorldSnapshot(); if(!W) return;

      const T = W.T;
      const p = getPlayerIfPlaying(); // ç·¨è¼¯æ¨¡å¼æ™‚ç‚º null
      const ex = e.x + e.w/2, ey = e.y + e.h/2;

      // ===== ç‹€æ…‹æ©Ÿ =====
      const lowHP = (e.hp / Math.max(1,e.maxHp)) <= 0.30;

      if(lowHP && e._state!=='merge_seek') e._state='merge_seek';
      if(!p && e._state==='chase') e._state='wander';

      // ---- Wanderï¼ˆç·¨è¼¯/éŠç©éƒ½æœƒæ™ƒï¼‰----
      if(e._state==='wander'){
        // å¶çˆ¾å°è·³/å·¦æˆ–å³
        e._wanderT = (e._wanderT||0) - dt;
        if(e._wanderT<=0){
          e._wanderT = 0.6 + Math.random()*0.8;
          const dir = (Math.random()<0.5?-1:1);
          e.vx = dir * SLIME_BASE.stats.spd * (0.4+Math.random()*0.5);
          if(e.onGround) e.vy = - (220 + Math.random()*120);
          e.face = dir;
          e._anim && (e._anim.name='hop', e._anim.i=0);
        }
        moveWithCollisions(e, dt);

        // è‹¥çœ‹å¾—åˆ°ç©å®¶å°±è¿½ï¼ˆåªåœ¨éŠç©ï¼‰
        if(p){
          const px=p.x+p.w/2, py=p.y+p.h/2;
          const canSee = hasLineOfSight(ex,ey, px,py, W) && Math.hypot(px-ex,py-ey) < T*10;
          if(canSee) e._state='chase';
        }
      }

      // ---- Chaseï¼ˆåªåœ¨éŠç©ï¼‰----
      else if(e._state==='chase' && p){
        const px=p.x+p.w/2, py=p.y+p.h/2;
        const dx = px - ex, dy = py - ey;
        const spd = SLIME_BASE.stats.chaseSpd * (1 + 0.15*(e._stack-1));
        e.vx += Math.sign(dx) * spd * 0.04; // æ©«å‘é»
        e.vx = Math.max(-spd, Math.min(spd, e.vx));
        if(e.onGround && Math.abs(dy) > T*0.3) e.vy = - (240 + 30*(e._stack-1)); // å°è·³
        moveWithCollisions(e, dt);
        e.face = (dx>=0?1:-1);

        // è¿‘èº«è§¸ç¢°å‚·å®³ï¼‹æ“Šé€€ï¼ˆCDï¼‰
        if (e._cool > 0) e._cool -= dt;
        const dist = Math.hypot(px-ex, py-ey);
        if (dist < (e._touchR||T*0.6) && e._cool <= 0){
          const ps = window.ENT && window.ENT.player && window.ENT.player.stats;
          if (ps){
            const raw = e._atkNow||SLIME_BASE.stats.atk;
            const mitig = Math.max(0, raw - (ps.def||0)*0.4);
            ps.hp = Math.max(0, ps.hp - mitig);
          }
          const dir = Math.sign(px-ex) || 1;
          p.vx = dir * SLIME_BASE.stats.knockVx * (0.9 + 0.25*(e._stack-1));
          p.vy = -SLIME_BASE.stats.knockVy * (0.9 + 0.20*(e._stack-1));
          e._cool = SLIME_BASE.stats.touchCD * 0.85;
          e._anim && (e._anim.name='hit', e._anim.i=0);
          if(SKIN.spawnFx){
            for(let i=0;i<6+2*(e._stack-1);i++){
              SKIN.spawnFx({
                x: ex + (Math.random()*12-6),
                y: ey + (Math.random()*8-4),
                vx: (dir*100)+(Math.random()*80-40), vy: -40-Math.random()*60,
                r: 2+Math.random()*3, color:'rgba(120,255,170,0.95)', life:0.35, maxLife:0.35
              });
            }
          }
        }

        // å¤±å»è¦–ç·šâ†’å› Wander
        const canSee = hasLineOfSight(ex,ey, px,py, W) && dist < T*12;
        if(!canSee) e._state='wander';
      }

      // ---- Merge Seekï¼ˆè¡€ä½æ–¼ 30%ï¼šæ‰¾éšŠå‹åˆé«”ï¼›ç·¨è¼¯/éŠç©éƒ½å¯ï¼‰----
      else if(e._state==='merge_seek'){
        // æœæœ€è¿‘çš„ã€Œä¹Ÿä½è¡€ä¸”æœªæ­»äº¡ã€å²èŠå§†ç§»å‹•ï¼›è·é›¢å¤ è¿‘å°±å¸æ”¶
        let nearest=null, nd=1e9;
        forEachSlimeNear(e, W.T*8, (o,d)=>{
          if(o._dead) return;
          const oLow = (o.hp / Math.max(1,o.maxHp)) <= 0.30;
          if(!oLow) return;
          if(d<nd){ nd=d; nearest=o; }
        });

        if(nearest){
          const ox = nearest.x+nearest.w/2, oy=nearest.y+nearest.h/2;
          const dx=ox-ex, dy=oy-ey;
          const spd = SLIME_BASE.stats.spd * 1.1;
          e.vx += Math.sign(dx) * spd * 0.05;
          e.vx = Math.max(-spd, Math.min(spd, e.vx));
          if(e.onGround && Math.abs(dy)>T*0.2) e.vy = - (200 + 20*(e._stack-1));
          moveWithCollisions(e, dt);
          e.face = (dx>=0?1:-1);

          if(nd < Math.max(18, Math.min(e.w,e.h)*0.6)){
            // æ±ºå®šèª°æ˜¯ã€Œé ˜éšŠã€ï¼šhp æ¯”è¼ƒé«˜è€…ç•¶é ˜éšŠï¼›è‹¥ç›¸åŒå°± id å°ï¼ˆå¼•ç”¨ä½å€ï¼‰è€…
            const leader = (e.hp>=nearest.hp) ? e : nearest;
            const target = (leader===e) ? nearest : e;
            absorb(leader, target);
            // è¢«å¸æ”¶çš„ target å·²æ¨™è¨˜æ­»äº¡ï¼›é ˜éšŠè‹¥æ˜¯ eï¼Œä¿æŒ merge_seek çœ‹æœ‰ç„¡æ›´å¤š
            if(leader!==e){ e._state='wander'; }
          }
        }else{
          // æ‰¾ä¸åˆ°å¯åˆé«”ç›®æ¨™ â†’ é€æ­¥å›åˆ° wander
          e._mergeIdle = (e._mergeIdle||0) + dt;
          if(e._mergeIdle>1.0){ e._mergeIdle=0; e._state='wander'; }
          moveWithCollisions(e, dt);
        }
      }

      // --- å—æ“Šç›’ï¼ˆDD_HITBOXï¼‰ ---
      if (!e._hb && window.DD_HITBOX){
        e._hb = DD_HITBOX.track(e, {
          team: 'enemy',
          getBounds: ()=>({ x:e.x, y:e.y, w:e.w, h:e.h }),
          getHP: ()=> e.hp,
          setHP: v => { e.hp = v; },
          iframes: 0.10,
          knock: { force: 300 },
          getVel: ()=>({ vx:e.vx||0, vy:e.vy||0 }),
          setVel: (vx,vy)=>{ e.vx=vx; e.vy=vy; },
          onHit:   (en)=>{ en._flash = 8; en._anim && (en._anim.name='hit', en._anim.i=0); },
          onDeath: (en)=>{
            const cx = en.x + en.w/2, cy = en.y + en.h/2;
            dropLootAt(cx, cy);
            try{
              if(window.SKIN && SKIN.spawnFx){
                SKIN.spawnFx({ x:cx, y:cy, r:18+4*(en._stack-1), vx:0, vy:-50, color:'rgba(120,255,170,0.95)', life:0.30, maxLife:0.30 });
                SKIN.spawnFx({ x:cx, y:cy, r:12+3*(en._stack-1), vx:0, vy:0,  color:'rgba(40,120,80,0.85)',  life:0.22, maxLife:0.22 });
              }
            }catch{}
            en._dead = true; en._dieAt = performance.now()/1000;
          }
        });
      }

      // --- è¦–è¦ºï¼šspritesheet æˆ–ä½”ä½ç¶ è†  ---
      const drawer = SKIN && SKIN.ent && SKIN.ent.get && SKIN.ent.get('slime');
      if (typeof drawer === 'function'){
        try{ drawer(ctx, e, now, window.THEME); return; }catch{}
      }
      drawGreenBlob(ctx, e, now);
    }
  };

  /* ========== çš®è†šè¨»å†Šï¼šå…ˆæ›ä½”ä½ï¼ŒPalette èƒ½çœ‹è¦‹ã€Œå²èŠå§†ã€ ========== */
  if (SKIN && SKIN.useEnt && (!SKIN.ent.get || !SKIN.ent.get('slime'))){
    SKIN.useEnt('slime', drawGreenBlob);
  }

  /* ========== Palette åˆ·æ–°ï¼ˆè‹¥æ€ªç‰©åˆ†é å·²é–‹ï¼‰ ========== */
  const monsBtn = document.querySelector('#palette .pill[data-cat="monsters"]');
  if (monsBtn && monsBtn.classList.contains('active')) monsBtn.click();

})();
</script>
<!-- ============ /Plugin: å²èŠå§† ============ -->

//æ€ªç¸æ’ä»¶çµæŸ


//å‹•ç‰©æ’ä»¶é–‹å§‹

<!-- ============ Plugin: æ£•ç†Šï¼ˆæœ€ç°¡ç‰ˆï¼Œå¯æ”¾ç½®ï¼›å‡ºç¾åœ¨ã€Œå‹•ç‰©ã€åˆ†é¡ï¼‰ ============ -->
<script>
(()=>{'use strict';

  // åŸºæœ¬å‘½åç©ºé–“
  const ENT  = window.ENT  || (window.ENT = {});
  const SKIN = window.SKIN || (window.SKIN = { ent:{ get:()=>null }, useEnt:()=>{} });

  // å–å¾—æ ¼å­å°ºå¯¸ï¼ˆå¤±æ•—å‰‡ç”¨ 48ï¼‰
  function getTileSize(){
    try{
      const W = window.world || window.__WORLD;
      if (W && (W.tileSize||W.T)) return (W.tileSize||W.T);
      const raw = localStorage.getItem('dd_skel_phase1')||'';
      const d = JSON.parse(raw||'{}');
      return d.tileSize || d.T || 48;
    }catch{ return 48; }
  }

  // ä½”ä½ç•«æ³•ï¼ˆå°±ç®—æ²’æœ‰ç´ æä¹Ÿèƒ½çœ‹åˆ°ï¼‰
  function drawBear(ctx, e, t){
    const cx=e.x+e.w/2, cy=e.y+e.h/2 + Math.sin((t||performance.now()/1000)*2)*1.0;
    // å½±å­
    ctx.save(); ctx.fillStyle='rgba(0,0,0,0.25)';
    ctx.beginPath(); ctx.ellipse(e.x+e.w/2, e.y+e.h, Math.min(e.w,e.h)*0.48, Math.min(e.w,e.h)*0.18, 0,0,Math.PI*2); ctx.fill(); ctx.restore();
    // èº«é«”/é ­
    ctx.save(); ctx.translate(cx,cy); ctx.scale(e.face>=0?1:-1,1);
    const bw=e.w*0.9, bh=e.h*0.6;
    const g=ctx.createLinearGradient(0,-bh/2,0,bh/2); g.addColorStop(0,'#6a432f'); g.addColorStop(1,'#3b251b');
    ctx.fillStyle=g; ctx.beginPath(); ctx.ellipse(0,0,bw/2,bh/2,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(bw*0.22,-bh*0.35,bw*0.23,bh*0.19,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#2a1a14';
    for(const dx of [-1,1]){ ctx.beginPath(); ctx.ellipse(bw*0.22+dx*bw*0.10,-bh*0.52,bw*0.07,bh*0.07,0,0,Math.PI*2); ctx.fill(); }
    ctx.fillStyle='#22150f'; ctx.beginPath(); ctx.ellipse(bw*0.27,-bh*0.32,bw*0.08,bh*0.06,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#120b08'; ctx.beginPath(); ctx.arc(bw*0.24,-bh*0.36,2.4,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  if (SKIN && SKIN.useEnt && (!SKIN.ent.get || !SKIN.ent.get('bear'))) {
    SKIN.useEnt('bear', drawBear);
  }

  // â˜… æœ€ç°¡ç‰ˆç†Šï¼ˆåªæœ‰ spawn + renderï¼Œç¢ºä¿èƒ½æ”¾ä¸Šåœ°åœ–ï¼‰
  ENT.bear = {
    label: 'æ£•ç†Š',
    kind:  'animal',     // åˆ†é¡ç”¨
    ai:    'bear',

    spawn(opts={}){
      const T = getTileSize();
      const w = Math.max(40, Math.floor((opts.sizeTiles?.w||2)   * T * 0.74));
      const h = Math.max(36, Math.floor((opts.sizeTiles?.h||1.4) * T * 0.68));
      return {
        x: opts.x||0, y: opts.y||0, w, h,
        vx:0, vy:0, face:1, _phase: Math.random()*Math.PI*2
      };
    },

    render(ctx,e){
      // ç¢ºä¿æœ‰å°ºå¯¸ï¼ˆé˜²å…¶ä»–æµç¨‹æ¼è¨­ï¼‰
      if(!e.w || !e.h){
        const T=getTileSize();
        e.w=Math.max(40, Math.floor(2*T*0.74));
        e.h=Math.max(36, Math.floor(1.4*T*0.68));
      }
      // ç°¡å–®å·¦å³æ™ƒå‹•ï¼ˆå¯åˆªï¼‰
      const now=performance.now()/1000;
      e._dir = e._dir ?? (Math.random()<0.5?-1:1);
      e._span = e._span ?? getTileSize()*3;
      e._spawn = e._spawn || { x:e.x, y:e.y };
      const targetX = e._spawn.x + e._dir*e._span;
      const dir = Math.sign(targetX - e.x) || e._dir;
      e.x += dir * 60 * Math.min(0.033, (now-(e._last||now)));
      e.face = dir>=0 ? 1 : -1;
      if (Math.abs(e.x - targetX) < 6) e._dir *= -1;
      e._last = now;

      // ç•«åœ–ï¼ˆä½”ä½ï¼‰
      (SKIN.ent.get?.('bear') || drawBear)(ctx, e, now);
    }
  };

  // å–æ”¾ç½®åº§æ¨™ï¼ˆæ»‘é¼ ä½ç½® â†’ è¦–çª—ä¸­å¿ƒ â†’ 0,0ï¼‰
  function getSpawnXY(){
    const c = window.__cursor || window.editorCursor;
    if (c && typeof c.x==='number' && typeof c.y==='number') return {x:c.x, y:c.y};
    const T = getTileSize();
    const vx = window.scrollX||0, vy = window.scrollY||0;
    const cx = vx + (innerWidth>>1), cy = vy + (innerHeight>>1);
    return { x: Math.floor(cx/T)*T, y: Math.floor(cy/T)*T };
  }

  // å°‡ã€Œæ£•ç†Šã€åŠ å…¥ Palette çš„ã€Œå‹•ç‰©ã€åˆ†é ï¼ŒæŒ‰ä¸‹å³å¯æ”¾ç½®
  function injectAnimalsPalette(){
    const root = document.querySelector('#palette');
    if (!root) return false;

    // æ‰¾åˆ°ã€Œå‹•ç‰©ã€åˆ†é å®¹å™¨ï¼ˆå¸¸è¦‹ class åç¨±éƒ½è©¦ï¼‰
    let list = root.querySelector('.grid[data-cat="animals"], .list[data-cat="animals"], .panel[data-cat="animals"]');
    if (!list) list = root.querySelector('.grid, .list, .panel'); // å¾Œå‚™ï¼šä»»ä½•æ¸…å–®

    if (!list) return false;
    if (root.querySelector('[data-key="bear"]')) return true; // å·²å­˜åœ¨

    const btn = document.createElement('button');
    btn.className = 'tile ent';
    btn.dataset.key = 'bear';
    btn.dataset.cat = 'animals';
    btn.type = 'button';
    btn.title = 'æ£•ç†Š';
    btn.textContent = 'æ£•ç†Š';

    btn.addEventListener('click', () => {
      try{
        const pos = getSpawnXY();
        if (typeof window.__spawn === 'function' && ENT?.bear?.spawn){
          window.__spawn(() => ENT.bear.spawn({ x:pos.x, y:pos.y }));
        } else {
          const e = ENT.bear.spawn({ x:pos.x, y:pos.y });
          (window.__entities ||= []).push(e);
        }
      }catch(err){ console.warn('spawn bear failed', err); }
    });

    list.appendChild(btn);
    return true;
  }

  // å˜—è©¦æ³¨å…¥ä¸€æ¬¡ï¼›ä¹‹å¾Œç›£è½ DOM è®ŠåŒ–å†è£œä¸€æ¬¡
  setTimeout(injectAnimalsPalette, 80);
  new MutationObserver(() => { injectAnimalsPalette(); })
    .observe(document.documentElement, { subtree:true, childList:true });

  // è‹¥ã€Œå‹•ç‰©ã€åˆ†é æ­£åœ¨é–‹å•Ÿï¼Œé»ä¸€ä¸‹åˆ·æ–°
  const aniBtn = document.querySelector('#palette .pill[data-cat="animals"]');
  if (aniBtn && aniBtn.classList.contains('active')) aniBtn.click();

})();</script>
<!-- ============ /Plugin: æ£•ç†Šï¼ˆæœ€ç°¡ç‰ˆï¼‰ ============ -->





<!-- =========================
     æ’ä»¶ï¼šå€‰é¼ ï¼ˆé‡ç”Ÿâ†”å¯µç‰©ï¼‰
     - èª¿è‰²ç›¤æ–°å¢ã€Œå€‰é¼ ã€ï¼ˆåˆ†é¡ï¼šå‹•ç‰©/crittersï¼‰
     - é‡ç”Ÿï¼šåœ°ä¸Šé–’é€›ã€é‡ç‰†æœƒæ‰é ­ã€é‡å°å‘æœƒè©¦è·³
     - é¤µé£Ÿï¼šé è¿‘æŒ‰ Fï¼Œæ¶ˆè€— INVENTORY.meat x1 â†’ é¦´æœæˆå¯µç‰©
     - å¯µç‰©ï¼šè·Ÿéš¨ç©å®¶ã€é‡éšœç¤™æœƒè·³ï¼Œå¤ªé æœƒç¬ç§»å›ä¾†
========================= -->
<script>
(()=>{
  'use strict';

  const ENT = window.ENT || (window.ENT = {});
  const SKIN = window.SKIN;

  /* -------- è®€å–ä¸–ç•Œï¼ˆä¾›ç¢°æ’æŸ¥è©¢ï¼‰ -------- */
  const SAVEK = 'dd_skel_phase1';
  let _rawCache=null, _world=null, _lastSnap=0;
  function loadWorldSnapshot(force=false){
    const now = performance.now();
    if(!force && now - _lastSnap < 450) return _world;
    const raw = localStorage.getItem(SAVEK)||'';
    if(!force && raw===_rawCache) return _world;
    _rawCache = raw; _lastSnap=now;
    try{
      const d = JSON.parse(raw||'{}');
      const tiles = (d.tileRows||[]).map(r=>r.split(''));
      const T = d.tileSize || 48;
      _world = {
        w:d.w||40, h:d.h||24, T, tiles,
        tileAt(gx,gy){
          if(gx<0||gy<0||gx>=this.w||gy>=this.h) return '#';
          const row=this.tiles[gy]||[]; return row[gx]||'.';
        },
        isSolidRect(rx,ry,rw,rh){
          const T=this.T;
          const x0=Math.floor(rx/T), x1=Math.floor((rx+rw-1)/T);
          const y0=Math.floor(ry/T), y1=Math.floor((ry+rh-1)/T);
          for(let y=y0;y<=y1;y++) for(let x=x0;x<=x1;x++){
            if(this.tileAt(x,y)==='#') return true;
          }
          return false;
        }
      };
    }catch{
      _world={w:40,h:24,T:48,tiles:[],tileAt(){return '.';},isSolidRect(){return false;}};
    }
    return _world;
  }

  function moveWithCollisions(o, dt){
    const W = loadWorldSnapshot(); if(!W) return;
    // æ°´å¹³
    let nx = o.x + o.vx*dt;
    if(!W.isSolidRect(nx, o.y, o.w, o.h)){ o.x=nx; }
    else{ const dir=Math.sign(o.vx)||1; let px=o.x; while(!W.isSolidRect(px+dir,o.y,o.w,o.h)) px+=dir; o.x=px; o.vx=0; }
    // å‚ç›´
    let ny = o.y + o.vy*dt; o.onGround=false;
    if(!W.isSolidRect(o.x, ny, o.w, o.h)){ o.y=ny; }
    else{ const dir=Math.sign(o.vy)||1; let py=o.y; while(!W.isSolidRect(o.x,py+dir,o.w,o.h)) py+=dir; o.y=py; if(dir>0) o.onGround=true; o.vy=0; }
    // é‚Šç•Œ
    const maxX = W.w*W.T - o.w, maxY = W.h*W.T - o.h;
    o.x=Math.max(0,Math.min(maxX,o.x)); o.y=Math.max(0,Math.min(maxY,o.y));
  }

  /* -------- å°å·¥å…·ï¼šç°¡æ˜“é€šçŸ¥ï¼ˆç”¨ Phase3 çš„ toastBox è‹¥å­˜åœ¨ï¼‰ -------- */
  function notify(msg){
    const box = document.getElementById('toastBox');
    if(!box){ alert(msg); return; }
    box.textContent = msg;
    box.style.background = '#000b'; box.style.padding='8px 12px'; box.style.borderRadius='8px';
    clearTimeout(notify._t); notify._t = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 1200);
  }

  /* -------- æŒ‰ F é¤µé£Ÿï¼šè¨­æ——æ¨™ï¼Œè®“å€‰é¼  render è®€ -------- */
  let _feedKeyDown = false;
  addEventListener('keydown', (e)=>{
    if(e.code==='KeyF' && typeof window.__getMode==='function' && window.__getMode()==='play'){
      _feedKeyDown = true;
    }
  });
  addEventListener('keyup', (e)=>{ if(e.code==='KeyF') _feedKeyDown=false; });

  /* -------- å€‰é¼ å®šç¾© -------- */
  const BASE = {
    label:'å€‰é¼ ',
    kind:'critter',          // æ”¾åœ¨ã€Œå‹•ç‰©ã€åˆ†é¡
    ai:'hamster',
    stats:{
      spd: 180,              // åœ°é¢è·‘é€Ÿ
      jump: 520,             // å°è·³åŠ›
      grav: 2000,            // é‡åŠ›
      petFollow: 220,        // å¯µç‰©è·Ÿéš¨åŸºç¤é€Ÿ
      petJump:  560,         // å¯µç‰©è·³åŠ›
      maxGap:   20           // è·¨è¶Šå‘æ´çš„åµæ¸¬åƒç´ ï¼ˆç´„åŠæ ¼ï¼‰
    }
  };

  ENT.hamster = {
    label: BASE.label,
    kind:  BASE.kind,
    ai:    BASE.ai,
    stats: { ...BASE.stats },

    render(ctx, e){
      const W = loadWorldSnapshot(); const T=W.T;
      // åˆå§‹åŒ–å°ºå¯¸/ç‹€æ…‹
      if(!e._init){
        e.w = Math.max(22, Math.floor(T*0.46));
        e.h = Math.max(18, Math.floor(T*0.36));
        e.vx = e.vx||0; e.vy=e.vy||0; e.face=e.face||1;
        e.mode = e.mode || 'wild'; // 'wild' | 'pet'
        e._think = 0;
        e._init = true;
      }

      const now = performance.now()/1000;
      const dt  = Math.min(0.033, e._last ? now - e._last : 0); e._last = now;

      // å…±åŒï¼šé‡åŠ›
      e.vy += (BASE.stats.grav) * dt;
      if (e.vy > 1800) e.vy = 1800;

      // å–å¾—ç©å®¶ï¼ˆè·Ÿéš¨/é¤µé£Ÿè¦ç”¨ï¼‰
      const player = (typeof window.__ensurePlayer==='function') ? window.__ensurePlayer() : null;

      if(e.mode==='wild'){
        // ---- é‡ç”Ÿï¼šç°¡å–®å·¡éŠ ----
        // é€±æœŸæ€§æ±ºç­–ï¼šå·¦å³èµ°ã€åœ
        e._think -= dt;
        if(e._think <= 0){
          e._think = 0.8 + Math.random()*1.2;
          const r = Math.random();
          if(r < 0.6){ e.vx = (Math.random()<0.5 ? -1 : 1) * BASE.stats.spd; e.face = Math.sign(e.vx)||1; }
          else        { e.vx = 0; }
        }

        // ç‰†ï¼å°å°éšï¼šè²¼é‚Šæ™‚çµ¦å€‹å°è·³
        const ahead = e.face>=0 ? e.x+e.w+1 : e.x-1;
        const stepProbeY = e.y + e.h - 2;
        const hitWall = W.isSolidRect(ahead, e.y, 2, e.h-4);
        if(hitWall && e.onGround){ e.vy = -BASE.stats.jump; }

        // å‘æ´ï¼šå‰æ–¹ä¸‹ç·£æ¢æ¸¬ï¼Œå¿«æ‰ä¸‹å»å°±å°è·³
        const gapProbeX = e.face>=0 ? e.x + e.w + BASE.stats.maxGap : e.x - BASE.stats.maxGap;
        const gap = !W.isSolidRect(gapProbeX, e.y + e.h + 1, 6, 6);
        if(gap && e.onGround){ e.vy = -BASE.stats.jump * 0.9; }

        // --- å˜—è©¦è¢«é¤µé£Ÿï¼ˆé è¿‘ + æŒ‰ F + æœ‰è‚‰ï¼‰ ---
        if(player && _feedKeyDown){
          const px = player.x + player.w/2, py = player.y + player.h/2;
          const hx = e.x + e.w/2, hy = e.y + e.h/2;
          const dist = Math.hypot(px-hx, py-hy);
          if(dist < Math.max(42, T*0.9)){
            const inv = window.INVENTORY || (window.INVENTORY = {meat:0,loot:0,coins:0});
            if((inv.meat|0) > 0){
              inv.meat--;    // æ¶ˆè€—è‚‰
              // ç™»è¨˜åˆ°ç©å®¶å¯µç‰©æ¸…å–®
              const GEAR = window.GEAR || (window.GEAR = { slots:{}, stash:[], weapons:[], pets:[] });
              (GEAR.pets || (GEAR.pets=[])).push({ type:'hamster', name:'å€‰é¼ ' });
              if(typeof window.saveGear==='function') window.saveGear();

              // åˆ‡æ›æ¨¡å¼ â†’ å¯µç‰©
              e.mode='pet';
              // çµ¦ä¸€å°æ®µæ„›å¿ƒ FXï¼ˆç”¨ Phase4 FX å¦‚æœæœ‰ï¼‰
              if(window.SKIN && SKIN.spawnFx){
                SKIN.spawnFx({ x:hx, y:hy-10, vx:0, vy:-20, r:4, color:'#ff90b3', life:0.6, maxLife:0.6 });
                SKIN.spawnFx({ x:hx-8, y:hy-16, vx:-15, vy:-30, r:3, color:'#ffd1e0', life:0.6, maxLife:0.6 });
                SKIN.spawnFx({ x:hx+8, y:hy-16, vx: 15, vy:-30, r:3, color:'#ffd1e0', life:0.6, maxLife:0.6 });
              }
              notify('ğŸ¹ æˆç‚ºä½ çš„å¯µç‰©äº†ï¼( -1 ğŸ– )');
              _feedKeyDown = false; // æœ¬æ¬¡è™•ç†å®Œ
            }else{
              notify('éœ€è¦ ğŸ– è…è‚‰ æ‰èƒ½é¤µé£Ÿ');
              _feedKeyDown = false;
            }
          }
        }

      }else{
        // ---- å¯µç‰©ï¼šè·Ÿéš¨ç©å®¶ ----
        if(player){
          const tx = player.x + (player.w/2) - (e.w/2) - 28 * player.face; // ç¨å¾®åœ¨ç©å®¶å¾Œå´
          const ty = player.y + player.h - e.h;

          // X å‘è¿½éš¨
          const dx = tx - e.x;
          const followV = BASE.stats.petFollow * (1.1 - 0.3*Math.cos(now*6)); // å¾®å‘¼å¸
          e.vx = Math.sign(dx) * followV;
          e.face = dx >= 0 ? 1 : -1;

          // è‹¥å‰æ–¹æœ‰ç‰†ä¸”åœ¨åœ° â†’ è·³ä¸€ä¸‹
          const ahead = e.face>=0 ? e.x+e.w+1 : e.x-1;
          const hitWall = W.isSolidRect(ahead, e.y, 2, e.h-4);
          if(hitWall && e.onGround){ e.vy = -BASE.stats.petJump; }

          // è‹¥è¦è·Ÿçš„é»åœ¨ä¸Šæ–¹å¾ˆå¤š â†’ è©¦è‘—è·³
          if(ty < e.y - 6 && e.onGround){ e.vy = -BASE.stats.petJump; }

          // å‘æ´ä¿è­·ï¼ˆå¯µç‰©ç›¡é‡ä¸æ‰å‘ï¼‰
          const gapProbeX = e.face>=0 ? e.x + e.w + BASE.stats.maxGap : e.x - BASE.stats.maxGap;
          const gap = !W.isSolidRect(gapProbeX, e.y + e.h + 1, 6, 6);
          if(gap && e.onGround){ e.vy = -BASE.stats.petJump * 0.9; }

          // è·é›¢éé  â†’ ç¬ç§»åˆ°ç©å®¶é™„è¿‘
          const hx = e.x + e.w/2, hy = e.y + e.h/2;
          const px = player.x + player.w/2, py = player.y + player.h/2;
          if(Math.hypot(px-hx, py-hy) > Math.max(380, T*8)){
            e.x = player.x + (player.face>0 ? -T*0.6 : T*0.6);
            e.y = player.y - 4; e.vx=0; e.vy=0;
          }
        }else{
          // æ²’ç©å®¶å°±å¾…æ©Ÿ
          e.vx *= 0.9;
        }
      }

      // ç‰©ç†è§£ç®—
      moveWithCollisions(e, dt);

      // --- è¦–è¦ºï¼šè‹¥ Phase4 æœ‰çš®è†šå°±ç”¨ï¼Œå¦å‰‡ç°¡å–®ç•« ---
      const useSkin = SKIN && SKIN.ent && SKIN.ent.get && SKIN.ent.get('hamster');
      if(typeof useSkin === 'function'){
        try{ useSkin(ctx, e, now, window.THEME); return; }catch{}
      }

      // å‚™æ´å°åœ“åœ˜ï¼ˆé‡ç”Ÿ=æ£•è‰²ï¼Œå¯µç‰©=äº®ç²‰ï¼‰
      ctx.save();
      ctx.translate(e.x + e.w/2, e.y + e.h/2);
      ctx.fillStyle = (e.mode==='pet' ? '#ff90b3' : '#d9a074');
      ctx.beginPath();
      ctx.arc(0,0, Math.min(e.w,e.h)*0.48, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  };

  // è‹¥ä½ å·²è¼‰å…¥ Phase4 çš„ç¯„ä¾‹çš®è†šï¼Œå¹«ä½ æ›å€‰é¼ çš®
  if(SKIN && SKIN.useEnt && !SKIN.ent.get('hamster') && typeof window.drawHamster==='function'){
    SKIN.useEnt('hamster', window.drawHamster);
  }

  // èª¿è‰²ç›¤æœƒè‡ªå‹•æŠŠ ENT.kind==='critter' çš„é …ç›®æ”¾åˆ°ã€Œå‹•ç‰©ã€åˆ†é¡ï¼›
  // å¦‚æœä½ æ­¤æ™‚å·²ç¶“é–‹è‘—ã€Œå‹•ç‰©ã€é‚£é ï¼Œå¹«ä½ åˆ·æ–°ä¸€æ¬¡
  const critBtn = document.querySelector('#palette .pill[data-cat="critters"]');
  if (critBtn && critBtn.classList.contains('active')) critBtn.click();

})();
</script>
//å€‰é¼ æ’ä»¶çµæŸ


<!-- ============ Plugin: ç†Šï¼ˆBearï½œCrittersï½œå´èº«ç´°é•·ç‰ˆï¼Œå«å®Œæ•´AIï¼‰ ============ -->
<script>
(()=>{ 'use strict';
  /* ======================== å…¨åŸŸæ¥å£ ======================== */
  const ENT  = (window.ENT  ||= {});
  const SKIN = (window.SKIN ||= { ent:{ map:new Map(), get(k){return this.map.get(k)}, set(k,v){this.map.set(k,v)} }, useEnt(k,fn){ this.ent.set(k,fn) } });

  /* ======================== åƒæ•¸ ======================== */
  const CFG = {
    saveKey: 'dd_skel_phase1',
    worldSnapCooldownMs: 450,
    gravity: 980, bounce: 0.08,

    base: {
      hp: 80,
      atkSwipe: 14, atkCharge: 20,
      spd: 70, chaseSpd: 135,
      touchCD: 0.9,
      swipeRangePx: 46,
      chargeMinPx: 120, chargeMaxPx: 360,
      chargeDur: 0.8, chargeSpd: 260,
      knockSwipe: { vx:320, vy:420 },
      knockCharge:{ vx:480, vy:520 }
    },

    drop: {
      loot: { chance:0.35, min:1, max:2, color:'rgba(160,200,255,0.95)' },
      meat: { chance:0.55, min:1, max:2, color:'rgba(200,120,90,0.95)' }
    },

    paletteCat: 'critters' // ä½ çš„åˆ†é ï¼ˆä¹Ÿæœƒå®¹å¿ "Critters"ï¼‰
  };

  /* ======================== ä¸–ç•Œå¿«ç…§ ======================== */
  let _rawCache=null, _world=null, _lastSnap=0;
  function loadWorldSnapshot(force=false){
    const now=performance.now();
    if(!force && now-_lastSnap<CFG.worldSnapCooldownMs) return _world;
    const raw = localStorage.getItem(CFG.saveKey)||'';
    if(!force && raw===_rawCache) return _world;
    _lastSnap=now; _rawCache=raw;
    try{
      const d = JSON.parse(raw||'{}');
      const tiles = (d.tileRows||[]).map(r=>r.split(''));
      const T = d.tileSize||48;
      _world = {
        w:d.w||40, h:d.h||24, T, tiles,
        tileAt(gx,gy){ if(gx<0||gy<0||gx>=this.w||gy>=this.h) return '#'; const row=this.tiles[gy]||[]; return row[gx]||'.'; },
        isSolidRect(rx,ry,rw,rh){
          const x0=Math.floor(rx/T), x1=Math.floor((rx+rw-1)/T);
          const y0=Math.floor(ry/T), y1=Math.floor((ry+rh-1)/T);
          for(let y=y0;y<=y1;y++){ for(let x=x0;x<=x1;x++){ if(this.tileAt(x,y)==='#') return true; } }
          return false;
        }
      };
    }catch{
      _world = { w:40,h:24,T:48, tiles:[], tileAt(){return '.'}, isSolidRect(){return false} };
    }
    return _world;
  }

  /* ======================== ç§»å‹•/ç¢°æ’ ======================== */
  function moveWithCollisions(o, dt){
    const W = loadWorldSnapshot(); if(!W) return;
    // X
    let nx = o.x + (o.vx||0)*dt;
    if(!W.isSolidRect(nx, o.y, o.w, o.h)){ o.x = nx; }
    else{
      const dir = Math.sign(o.vx||0)||1;
      let px=o.x; while(!W.isSolidRect(px+dir, o.y, o.w, o.h)) px+=dir;
      o.x=px; o.vx=0;
    }
    // Y
    o.vy = (o.vy||0) + (o._grav||CFG.gravity)*dt;
    let ny = o.y + o.vy*dt; o.onGround=false;
    if(!W.isSolidRect(o.x, ny, o.w, o.h)){ o.y = ny; }
    else{
      const dir = Math.sign(o.vy||0)||1;
      let py=o.y; while(!W.isSolidRect(o.x, py+dir, o.w, o.h)) py+=dir;
      o.y=py;
      if(dir>0){
        o.onGround=true;
        o.vy = -Math.abs(o.vy) * (o._bounce||CFG.bounce);
        if(Math.abs(o.vy)<30) o.vy=0;
      } else o.vy=0;
    }
    // é‚Šç•Œ
    const maxX = _world.w*_world.T - o.w, maxY = _world.h*_world.T - o.h;
    o.x = Math.max(0, Math.min(maxX, o.x));
    o.y = Math.max(0, Math.min(maxY, o.y));
  }

  /* ======================== LOS ======================== */
  function hasLOS(ax,ay,bx,by,W){
    const dx=bx-ax, dy=by-ay, dist=Math.hypot(dx,dy)||1;
    const step=Math.max(4, Math.floor((W?.T||48)*0.5)), n=Math.ceil(dist/step);
    for(let i=0;i<=n;i++){ const t=i/n, x=ax+dx*t, y=ay+dy*t; const gx=Math.floor(x/(W?.T||48)), gy=Math.floor(y/(W?.T||48)); if(W.tileAt(gx,gy)==='#') return false; }
    return true;
  }

  /* ======================== æ‰è½ ======================== */
  function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
  function tryDrop(kind, inv, x, y, color, cfg){
    if(Math.random() > cfg.chance) return 0;
    const n = randInt(cfg.min, cfg.max);
    const key = (kind==='coin'?'coins':kind);
    inv[key] = (inv[key]|0) + n;
    try{
      if(SKIN && SKIN.spawnFx){
        for(let i=0;i<n;i++){
          SKIN.spawnFx({ x:x+(Math.random()*12-6), y:y-6, vx:(Math.random()*80-40), vy:-60-Math.random()*60,
            r: 5, color, life:0.6, maxLife:0.6 });
        }
      }
    }catch{}
    return n;
  }
  function dropLootAt(x,y){
    const INV = (window.INVENTORY ||= {meat:0, loot:0, coins:0});
    const l = tryDrop('loot', INV, x,y, CFG.drop.loot.color, CFG.drop.loot);
    const m = tryDrop('meat', INV, x,y, CFG.drop.meat.color, CFG.drop.meat);
    const box = document.getElementById('toastBox');
    if(box && (l||m)){
      let msg=''; if(l) msg+=`ğŸx${l} `; if(m) msg+=`ğŸ–x${m}`;
      box.textContent = `ç²å¾— ${msg.trim()}`;
      box.style.background='#000b'; box.style.padding='8px 12px'; box.style.borderRadius='8px';
      clearTimeout(dropLootAt._t); dropLootAt._t = setTimeout(()=>{ box.textContent=''; box.style.padding='0'; }, 900);
    }
    if(typeof window.refreshBag==='function') window.refreshBag();
  }

  /* ======================== è¦–è¦ºï¼šå´èº«ç´°é•·ç†Š ======================== */
  const PALETTE = {
    furDark:   'rgba(95,60,40,0.95)',
    furMid:    'rgba(130,85,55,0.95)',
    furLight:  'rgba(170,120,85,0.95)',
    belly:     'rgba(190,150,115,0.95)',
    nose:      '#2b1a12',
    eye:       '#1a0e08',
    claw:      'rgba(240,230,220,0.95)',
    shadow:    'rgba(0,0,0,0.25)'
  };

  function drawBearSidePlaceholder(ctx, e, t){
    const W = Math.max(48, e.w || 96);
    const H = Math.max(36, e.h || 64);
    const cx = e.x + e.w/2, cy = e.y + e.h/2;

    // åœ°å½±
    ctx.save();
    ctx.fillStyle = PALETTE.shadow;
    ctx.beginPath(); ctx.ellipse(e.x + e.w/2, e.y + e.h, Math.max(18, e.w*0.48), Math.max(8, e.h*0.18), 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    const step = Math.sin(t*6), step2 = Math.sin(t*6 + Math.PI), lift = Math.max(0, Math.sin(t*6)*6);
    ctx.save();
    const face = (e.face || 1) >= 0 ? 1 : -1;
    ctx.translate(cx, cy - 2 + Math.sin(t*4)*1.5);
    ctx.scale(face, 1);

    // èº«é«”ï¼ˆç´°é•·ï¼‰
    const bodyW = W * 0.95, bodyH = H * 0.60, bodyX = -bodyW*0.10;
    ctx.save();
    const gBody = ctx.createLinearGradient(-bodyW/2, 0, bodyW/2, 0);
    gBody.addColorStop(0, PALETTE.furMid); gBody.addColorStop(1, PALETTE.furDark);
    ctx.fillStyle = gBody;
    ctx.beginPath(); ctx.ellipse(bodyX, -6+lift*0.15, bodyW*0.50, bodyH*0.52, 0, 0, Math.PI*2); ctx.fill();
    // è…¹éƒ¨
    ctx.fillStyle = PALETTE.belly;
    ctx.beginPath(); ctx.ellipse(bodyX + bodyW*0.05, bodyH*0.05-6+lift*0.15, bodyW*0.32, bodyH*0.25, 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    // é ­
    const headW=W*0.40, headH=H*0.40, headX=bodyX+bodyW*0.50+headW*0.15, headY=-bodyH*0.20-4+lift*0.1;
    ctx.save();
    const gHead = ctx.createRadialGradient(headX - headW*0.15, headY - headH*0.15, headW*0.1, headX, headY, headW*0.8);
    gHead.addColorStop(0, PALETTE.furLight); gHead.addColorStop(1, PALETTE.furMid);
    ctx.fillStyle = gHead;
    ctx.beginPath(); ctx.ellipse(headX, headY, headW*0.48, headH*0.50, 0, 0, Math.PI*2); ctx.fill();
    // è€³æœµ
    ctx.fillStyle = PALETTE.furDark; ctx.beginPath(); ctx.arc(headX - headW*0.18, headY - headH*0.50, headW*0.12, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(headX + headW*0.00,  headY - headH*0.55, headW*0.10, 0, Math.PI*2); ctx.fill();
    // é¼»å£ & é¼»
    ctx.fillStyle = PALETTE.belly; ctx.beginPath(); ctx.ellipse(headX + headW*0.20, headY + headH*0.05, headW*0.23, headH*0.18, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = PALETTE.nose;  ctx.beginPath(); ctx.ellipse(headX + headW*0.32, headY + headH*0.02, headW*0.10, headH*0.08, 0, 0, Math.PI*2); ctx.fill();
    // çœ¼ç›
    ctx.fillStyle = PALETTE.eye; ctx.beginPath(); ctx.arc(headX + headW*0.10, headY - headH*0.08, Math.max(1.8, headW*0.04), 0, Math.PI*2); ctx.fill();
    // ä¸‹é¡é™°å½±
    ctx.globalAlpha=0.25; ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(headX + headW*0.18, headY + headH*0.15, headW*0.20, headH*0.10, 0, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    ctx.restore();

    // å››è‚¢
    const legLen = H*0.55, legW=Math.max(6, W*0.08), footW=legW*1.4;
    const hipY = bodyH*0.25 - 2 + lift*0.15;
    const frontX = bodyX + bodyW*0.28, rearX = bodyX - bodyW*0.25;
    drawLeg(frontX, hipY, step2, true);
    drawLeg(frontX - legW*0.8, hipY+1, -step2*0.8, false, 0.7);
    drawLeg(rearX, hipY+1, step, true);
    drawLeg(rearX - legW*0.8, hipY+2, -step*0.8, false, 0.7);

    // å°¾å·´
    ctx.save(); ctx.fillStyle=PALETTE.furDark;
    ctx.beginPath(); ctx.ellipse(bodyX - bodyW*0.50, -bodyH*0.15 + lift*0.1, W*0.06, H*0.05, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();

    ctx.restore();

    if (e._flash>0){
      ctx.save(); ctx.globalCompositeOperation='screen'; ctx.globalAlpha=0.45; ctx.fillStyle='#fff'; ctx.fillRect(e.x, e.y, e.w, e.h); ctx.restore();
    }

    function drawLeg(rootX, rootY, phase, closeSide, dim=1){
      const swing = phase*8, liftY=Math.max(0,phase)*5; const shade=closeSide?1:0.75*dim;
      ctx.save(); ctx.translate(rootX + swing, rootY - liftY);
      ctx.fillStyle = shade>0.9 ? PALETTE.furDark : PALETTE.furMid;
      roundRect(ctx, -legW/2, 0, legW, legLen*0.55, legW*0.4); ctx.fill();
      roundRect(ctx, -legW*0.9/2, legLen*0.55 - 2, legW*0.9, legLen*0.45, legW*0.35); ctx.fill();
      ctx.fillStyle=PALETTE.claw; ctx.beginPath(); ctx.ellipse(0, legLen*0.45, footW*0.55, legW*0.40, 0, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
    function roundRect(ctx, x, y, w, h, r){
      const rr=Math.min(r,w/2,h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y, x+w,y+h, rr);
      ctx.arcTo(x+w,y+h, x,y+h, rr);
      ctx.arcTo(x,y+h, x,y, rr);
      ctx.arcTo(x,y, x+w,y, rr);
      ctx.closePath();
    }
  }
  // æä¾› Drawer APIï¼Œè‹¥æœªä¾†è¦ç”¨ spritesheet å¯è‡ªè¡Œæ”¹è¨»å†Š
  function makeBearSideDrawer(){ return function(ctx,e,now){ drawBearSidePlaceholder(ctx,e,now); }; }

  /* ======================== ç©å®¶å·¥å…· ======================== */
  function getPlayerIfPlaying(){
    try{ if(typeof window.__getMode==='function' && window.__getMode()==='play' && typeof window.__ensurePlayer==='function') return window.__ensurePlayer(); }catch{}
    return null;
  }

  /* ======================== ç†Šï¼ˆå®Œæ•´ AIï¼‰ ======================== */
  ENT.bear = {
    label:'ç†Š',
    kind:'critter',          // æ”¾åœ¨ Critters
    ai:'bear',
    stats:{ ...CFG.base },

    spawn(opts={}){
      loadWorldSnapshot(); // åˆå§‹åŒ–ä¸–ç•Œ
      return {
        x:opts.x||0, y:opts.y||0,
        vx:0, vy:0, face:1,
        hp: opts.hp ?? CFG.base.hp,
        maxHp: opts.maxHp ?? CFG.base.hp,
        sizeTiles: opts.sizeTiles || { w:2, h:2 },
        _state: 'wander',
        _phase: Math.random()*Math.PI*2
      };
    },

    render(ctx, e){
      const now = performance.now()/1000;
      const dt  = Math.min(0.033, Math.max(0.001, now - (e._last||now)));
      e._last = now; e._dt = dt;

      if(e._dead){
        if(!e._dieAt) e._dieAt = now;
        ctx.save(); const k = Math.max(0, 1 - (now - e._dieAt)/0.4);
        ctx.globalAlpha = k; drawEntity(ctx,e,now); ctx.restore();
        if(now - e._dieAt > 0.45){ e.x=e.y=-1e6; e.w=e.h=0; e.vx=e.vy=0; }
        return;
      }

      ensureInit(e);
      applySize(e);

      const W = loadWorldSnapshot(); if(!W) return;
      const T=W.T, p=getPlayerIfPlaying();
      const ex=e.x+e.w/2, ey=e.y+e.h/2;

      if(!p && e._state==='chase') e._state='wander';

      // --- Wander ---
      if(e._state==='wander'){
        e._wanderT = (e._wanderT||0) - dt;
        if(e._wanderT<=0){
          e._wanderT = 1.0 + Math.random()*1.0;
          const dir = (Math.random()<0.5?-1:1);
          e.vx = dir * CFG.base.spd * (0.4+Math.random()*0.5);
          if(e.onGround && Math.random()<0.35) e.vy = -(200 + Math.random()*80);
          e.face = dir;
        }
        moveWithCollisions(e,dt);

        if(p){
          const px=p.x+p.w/2, py=p.y+p.h/2;
          const canSee = hasLOS(ex,ey,px,py,W) && Math.hypot(px-ex,py-ey) < T*12;
          if(canSee) e._state='chase';
        }
      }

      // --- Chase ---
      else if(e._state==='chase' && p){
        const px=p.x+p.w/2, py=p.y+p.h/2;
        const dx=px-ex, dy=py-ey; const dist=Math.hypot(px-ex,py-ey);

        if(e._chargeT && e._chargeT>0){
          e._chargeT -= dt;
          const sign = Math.sign(dx) || (e.face||1);
          e.vx = sign * CFG.base.chargeSpd;
          if(e.onGround && Math.random()<0.12) e.vy = -120;
          moveWithCollisions(e,dt);
          e.face = sign;

          if(dist < Math.max(CFG.base.swipeRangePx, T*0.8) && e._cool<=0){
            hitPlayer(e, p, CFG.base.atkCharge, CFG.base.knockCharge);
            e._cool = CFG.base.touchCD;
          }
        } else {
          const spd = CFG.base.chaseSpd;
          e.vx += Math.sign(dx) * spd * 0.05;
          e.vx = Math.max(-spd, Math.min(spd, e.vx));
          if(e.onGround && Math.abs(dy)>T*0.3) e.vy = -240;
          moveWithCollisions(e,dt);
          e.face = (dx>=0?1:-1);

          e._chargeCD = Math.max(0, (e._chargeCD||0) - dt);
          if(e._chargeCD<=0 && dist>=CFG.base.chargeMinPx && dist<=CFG.base.chargeMaxPx && hasLOS(ex,ey,px,py,W)){
            e._chargeT = CFG.base.chargeDur;
            e._chargeCD = 2.6;
            try{
              if(SKIN.spawnFx){
                for(let i=0;i<10;i++){
                  SKIN.spawnFx({ x:ex+(Math.random()*12-6), y:e.y+e.h,
                    vx:(Math.random()*160-80), vy:-60-Math.random()*80,
                    r:3+Math.random()*3, color:'rgba(180,120,80,0.9)', life:0.25, maxLife:0.25 });
                }
              }
            }catch{}
          }

          if(e._cool>0) e._cool-=dt;
          if(dist < CFG.base.swipeRangePx && e._cool<=0){
            hitPlayer(e, p, CFG.base.atkSwipe, CFG.base.knockSwipe);
            e._cool = CFG.base.touchCD * 0.9;
          }
        }

        const canSee = hasLOS(ex,ey,px,py,W) && dist < T*14;
        if(!canSee) e._state='wander';
      }

      // ç¶å®š Hitbox
      if(!e._hb && window.DD_HITBOX){
        e._hb = DD_HITBOX.track(e,{
          team:'critter',
          getBounds: ()=>({x:e.x,y:e.y,w:e.w,h:e.h}),
          getHP: ()=>e.hp,
          setHP: v=>{ e.hp=v },
          iframes:0.12,
          knock:{ force:360 },
          getVel: ()=>({vx:e.vx||0, vy:e.vy||0}),
          setVel: (vx,vy)=>{ e.vx=vx; e.vy=vy; },
          onHit:   (en)=>{ en._flash=8; },
          onDeath: (en)=>{
            const cx=en.x+en.w/2, cy=en.y+en.h/2;
            dropLootAt(cx,cy);
            try{
              if(SKIN.spawnFx){
                SKIN.spawnFx({ x:cx, y:cy, r:22, vx:0, vy:-60, color:'rgba(180,120,80,0.95)', life:0.30, maxLife:0.30 });
                SKIN.spawnFx({ x:cx, y:cy, r:14, vx:0, vy:0,  color:'rgba(70,45,30,0.85)',  life:0.22, maxLife:0.22 });
              }
            }catch{}
            en._dead=true; en._dieAt=performance.now()/1000;
          }
        });
      }

      // è¦–è¦º
      drawEntity(ctx,e,now);

      /* === å…§éƒ¨å·¥å…· === */
      function hitPlayer(en, p, atk, knock){
        const ps = ENT.player && ENT.player.stats;
        if(ps){
          const mitig = Math.max(0, atk - (ps.def||0)*0.4);
          ps.hp = Math.max(0, ps.hp - mitig);
        }
        const dir = Math.sign((p.x+p.w/2) - (en.x+en.w/2)) || (en.face||1);
        p.vx = dir * (knock.vx||360);
        p.vy = -(knock.vy||420);
        try{
          if(SKIN.spawnFx){
            for(let i=0;i<8;i++){
              SKIN.spawnFx({ x: en.x+en.w/2+(Math.random()*10-5), y: en.y+en.h/2+(Math.random()*6-3),
                vx: (dir*120)+(Math.random()*100-50), vy: -50-Math.random()*100,
                r: 2+Math.random()*3, color:'rgba(200,150,110,0.95)', life:0.30, maxLife:0.30 });
            }
          }
        }catch{}
      }
      function drawEntity(ctx,e,now){
        const drawer = SKIN && SKIN.ent && SKIN.ent.get && SKIN.ent.get('bear');
        if(typeof drawer==='function'){ try{ drawer(ctx,e,now,window.THEME); return; }catch{} }
        drawBearSidePlaceholder(ctx,e,now);
      }
    }
  };

  /* ======================== åˆå§‹åŒ–/å°ºå¯¸ ======================== */
  function ensureInit(e){
    const W = loadWorldSnapshot(); if(!W) return;
    if(!e._init){
      e._init=true;
      e.hp = (typeof e.hp==='number') ? e.hp : CFG.base.hp;
      e.maxHp = e.maxHp || e.hp;
      e._grav = CFG.gravity; e._bounce = CFG.bounce;
      e.vx ||= 0; e.vy ||= 0; e.face ||= 1; e._cool ||= 0;
      e._state ||= 'wander';
      e._spawn = { x:e.x, y:e.y };
    }
  }
  function applySize(e){
    const W = loadWorldSnapshot(); const T=W?W.T:48; const scale=1;
    e.w = Math.floor((e.sizeTiles?.w||2) * T * 0.90 * scale);
    e.h = Math.floor((e.sizeTiles?.h||2) * T * 0.85 * scale);
    e._touchR = Math.max(28, Math.min(160, T*0.7*scale));
  }

  /* ======================== Palette è¨»å†Šï¼†åˆ·æ–°ï¼ˆCrittersï¼‰ ======================== */
  // ä½¿ç”¨å´èº«ç´°é•·ç¹ªæ³•ä½œç‚ºé è¨­å¤–è§€ï¼ˆä¹‹å¾Œè‹¥ç”¨ spritesheetï¼Œå¯æ”¹ SKIN.useEnt('bear', makeBearDrawer(...)) è¦†è“‹ï¼‰
  if(SKIN && SKIN.useEnt && (!SKIN.ent?.get || !SKIN.ent.get('bear'))){
    SKIN.useEnt('bear', makeBearSideDrawer());
  }
  (function refreshCritters(){
    const sels = ['critters','Critters'].map(cat=>`#palette .pill[data-cat="${cat}"]`).join(',');
    const btn = document.querySelector(sels);
    if(btn && btn.classList.contains('active')) btn.click();
  })();

})();
</script>
<!-- ============ /Plugin: ç†Šï¼ˆBearï½œCrittersï½œå´èº«ç´°é•·ç‰ˆï¼‰ ============ -->



//å‹•ç‰©æ’ä»¶çµæŸ


<!-- æ’å…¥ï¼šæ­¦å™¨å¤–è§€ç®¡ç†ï¼ˆå…¨åŸŸ WEAPONï¼‰ -->
<script>
(() => {
  'use strict';
  // å˜—è©¦æŠ“ tileSizeï¼ˆç”¨ä¾†åšæ¯”ä¾‹ï¼‰
  let T = 48;
  try{ const d=JSON.parse(localStorage.getItem('dd_skel_phase1')||'{}'); T = d.tileSize||48; }catch{}

  const SKINS = {
    wood: {         // æœ¨åˆ€ï¼ˆæ£•è‰²ï¼‰
      id:'wood',
      blade:'#a8744f', edge:'#f2e6d2', trail:'rgba(168,116,79,0.35)',
      len: T*0.95, width: T*0.18
    },
    iron: {         // éµåŠï¼ˆå†·ç°ï¼‰
      id:'iron',
      blade:'#cfd4da', edge:'#ffffff', trail:'rgba(200,220,255,0.35)',
      len: T*1.05, width: T*0.16
    },
    steel: {        // é‹¼åŠï¼ˆæ·±ç°ï¼‰
      id:'steel',
      blade:'#b0b6bf', edge:'#f7f7f7', trail:'rgba(190,210,255,0.32)',
      len: T*1.08, width: T*0.17
    }
  };

  const WEAPON = {
    _id: 'wood',
    set(id){ this._id = SKINS[id] ? id : 'wood'; },
    get(){ return SKINS[this._id] || SKINS.wood; },
    skins: SKINS
  };

  window.WEAPON = WEAPON;
  // ä½ å¯ä»¥éš¨æ™‚åˆ‡æ›ï¼šWEAPON.set('wood') / WEAPON.set('iron') / WEAPON.set('steel')
})();
</script>


<!-- =========================
 A) å¤–æ›ï¼šDD_HITBOXï¼ˆé€šç”¨å—æ“Š/æ‰£è¡€ç³»çµ±ï¼‰
 - è®“ä»»ä½•ã€Œæ”»æ“Šäº‹ä»¶ã€â†’ è‡ªå‹•å°å·²è¨»å†Šçš„å¯¦é«”æ‰£è¡€ / æ“Šé€€ / è§¸ç™¼æ­»äº¡
========================= -->
<script>
(() => {
  'use strict';

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function center(b){ return { cx:b.x+b.w/2, cy:b.y+b.h/2 }; }

  function circleHitsAABB(cx,cy,r, box){
    const nx = clamp(cx, box.x, box.x+box.w);
    const ny = clamp(cy, box.y, box.y+box.h);
    const dx = cx - nx, dy = cy - ny;
    return dx*dx + dy*dy <= r*r;
  }
  function sectorHitsAABB(cx,cy, r, dir, spread, box){
    const c = center(box);
    const vx = c.cx - cx, vy = c.cy - cy;
    const d2 = vx*vx + vy*vy; if(d2>r*r) return false;
    const len = Math.hypot(vx,vy)||1;
    const dot = (vx/len)*dir[0] + (vy/len)*dir[1];
    return dot >= Math.cos(spread*0.5);
  }

  const regs = new Set(); // { e, team, getBounds, getHP, setHP, iframes, _cd, knock, getVel, setVel, onHit, onDeath }

  function track(entity, opts={}){
    const r = {
      e: entity,
      team: opts.team || 'enemy',
      getBounds: opts.getBounds || (()=>({x:entity.x,y:entity.y,w:entity.w,h:entity.h})),
      getHP: opts.getHP || (()=> (opts.hpRef ? +opts.hpRef[opts.hpKey] : +entity.hp)),
      setHP: opts.setHP || (v=>{ if(opts.hpRef) opts.hpRef[opts.hpKey]=v; else entity.hp=v; }),
      iframes: Math.max(0, opts.iframes ?? 0.12),
      _cd: 0,
      knock: opts.knock || null,
      getVel: opts.getVel || (()=>({vx:entity.vx||0, vy:entity.vy||0})),
      setVel: opts.setVel || ((vx,vy)=>{ entity.vx=vx; entity.vy=vy; }),
      onHit:   typeof opts.onHit==='function'? opts.onHit : null,
      onDeath: typeof opts.onDeath==='function'?opts.onDeath: null
    };
    regs.add(r);
    return r;
  }
  function untrack(entity){ for(const r of regs){ if(r.e===entity){ regs.delete(r); break; } } }

  (function coolLoop(){
    for(const r of regs){ if(r._cd>0) r._cd=Math.max(0, r._cd-1/60); }
    requestAnimationFrame(coolLoop);
  })();

  window.addEventListener('dd:attack', (ev)=>{
    const a = ev.detail || {};
    const atkTeam = a.team || 'player';
    const dmg = Math.max(0, +a.atk||0);
    if(!dmg) return;

    for(const r of regs){
      if(r.team===atkTeam) continue;
      if(r._cd>0) continue;

      const box = r.getBounds();
      let hit=false;
      if(a.shape==='circle') hit = circleHitsAABB(a.cx,a.cy,+a.r||0, box);
      else if(a.shape==='sector') hit = sectorHitsAABB(a.cx,a.cy,+a.r||0, a.dir||[1,0], +a.spread||0, box);
      else if(a.shape==='point') hit = circleHitsAABB(a.cx,a.cy,1, box);
      if(!hit) continue;

      const hp0 = r.getHP();
      const hp1 = Math.max(0, hp0 - dmg);
      r.setHP(hp1);
      r._cd = r.iframes;

      if(r.knock && a.dir){
        const k = +r.knock.force||0;
        if(k){
          const v = r.getVel();
          r.setVel((v.vx||0)+a.dir[0]*k, (v.vy||0)+a.dir[1]*(-0.2*k)-0.35*k);
        }
      }

      const info = { dmg, hp0, hp1, atk:a, bounds:box };
      if(r.onHit)   try{ r.onHit(r.e, info); }catch{}
      if(hp1<=0 && r.onDeath) try{ r.onDeath(r.e, info); }catch{}

      try{
        if(window.SKIN && SKIN.spawnFx){
          const c = center(box);
          SKIN.spawnFx({ x:c.cx, y:c.cy-8, r:10, vx:0, vy:-30, color:'rgba(255,90,90,0.85)', life:0.18, maxLife:0.18 });
        }
      }catch{}
    }
  });

  window.DD_HITBOX = { track, untrack };
})();
</script>







//äººç‰©æ’ä»¶é–‹å§‹


<!-- æ’ä»¶ï¼šäººç‰©ã€Œå¦¤ç¦ã€â€” å¹ç¬›è§¸ç™¼æ­Œè²é ˜åŸŸï¼ˆæŒçºŒæšˆçœ©+å°å‚·ï¼‰ï¼›å–œå‹•ç‰©ï¼›å¯æ”¶æœ -->
<script>
(()=>{ 'use strict';

  const ENT   = window.ENT  || (window.ENT={});
  const SKIN  = window.SKIN;
  const GEAR  = window.GEAR || (window.GEAR={ slots:{}, stash:[], weapons:[], pets:[] });

  /* ===== ä¸–ç•Œå¿«ç…§ï¼ˆä¾›æ¯”ä¾‹/ç¢°æ’ï¼‰ ===== */
  const SAVEK='dd_skel_phase1';
  let _rawCache=null,_world=null,_lastSnap=0;
  function loadWorldSnapshot(force=false){
    const now=performance.now();
    if(!force && now-_lastSnap<450) return _world;
    const raw=localStorage.getItem(SAVEK)||'';
    if(!force && raw===_rawCache) return _world;
    _rawCache=raw; _lastSnap=now;
    try{
      const d=JSON.parse(raw||'{}');
      const T=d.tileSize||48;
      const tiles=(d.tileRows||[]).map(r=>r.split(''));
      _world={
        w:d.w||40, h:d.h||24, T, tiles,
        isSolidRect(rx,ry,rw,rh){
          const x0=Math.floor(rx/T), x1=Math.floor((rx+rw-1)/T);
          const y0=Math.floor(ry/T), y1=Math.floor((ry+rh-1)/T);
          for(let y=y0;y<=y1;y++) for(let x=x0;x<=x1;x++){
            if(y<0||x<0||x>=this.w||y>=this.h) return true;
            if((this.tiles[y]||[])[x]==='#') return true;
          }
          return false;
        }
      };
    }catch{ _world={w:40,h:24,T:48,tiles:[],isSolidRect(){return false;}}; }
    return _world;
  }
  function moveWithCollisions(o,dt){
    const W=loadWorldSnapshot(); if(!W) return;
    // æ°´å¹³
    let nx=o.x+o.vx*dt;
    if(!W.isSolidRect(nx,o.y,o.w,o.h)) o.x=nx;
    else{ const dir=Math.sign(o.vx)||1; let px=o.x; while(!W.isSolidRect(px+dir,o.y,o.w,o.h)) px+=dir; o.x=px; o.vx=0; }
    // å‚ç›´
    let ny=o.y+o.vy*dt; o.onGround=false;
    if(!W.isSolidRect(o.x,ny,o.w,o.h)) o.y=ny;
    else{ const dir=Math.sign(o.vy)||1; let py=o.y; while(!W.isSolidRect(o.x,py+dir,o.w,o.h)) py+=dir; o.y=py; if(dir>0) o.onGround=true; o.vy=0; }
  }

  /* ===== åƒæ•¸ ===== */
  const CFG={
    hp:120,
    grav:2200,
    // æ­Œè²é ˜åŸŸï¼ˆå¹ç¬›è§¸ç™¼ï¼‰
    meters:10,               // åŠå¾‘ï¼š10 å…¬å°ºï¼ˆâ‰ˆ 10 æ ¼ï¼‰
    auraDur:3.5,             // é ˜åŸŸæŒçºŒç§’æ•¸
    tick:0.35,               // å‚·å®³/æšˆçœ©çš„è§¸ç™¼é–“éš”
    dmgPerTick:2,            // æ¯è·³å‚·å®³
    stunSec:0.8,             // æ¯è·³æšˆçœ©ç§’æ•¸ï¼ˆæ€ª AI éœ€è‡ªè¡Œè®€å– dd:statusï¼‰
    singChance:0.6,          // å¹ç¬›æ™‚è§¸ç™¼æ©Ÿç‡
    minSingInterval:0.9,     // æœ€çŸ­é–“éš”ï¼ˆé¿å…é€£ç™¼ï¼‰
    // AI
    likeCritterRangeTiles:30,
    walkSpd:150,
    jump:680,
    wallProbeTiles:2,
    wallJumpChance:0.55,
    tameOverlapSec:3.0       // èˆ‡å‹•ç‰©é‡ç–Šæ»¿ 3 ç§’ â†’ æœ‰æ©Ÿç‡æ”¶æœ
  };

  /* ===== å‹•ç‰© ping æ”¶é›†ï¼š{id,x,y,w,h,ts} ===== */
  const critters=new Map(); // key -> last sight
  let _pingId=0;
  window.addEventListener('ent:ping',(ev)=>{
    const d=ev.detail||{};
    if(d.kind!=='critter') return;
    const id = d.id || (d.type+':' + (++_pingId));
    critters.set(id,{id,x:d.x,y:d.y,w:d.w||28,h:d.h||28,ts:performance.now()});
    // æ¸…éèˆŠ
    const now=performance.now();
    for(const [k,v] of critters){ if(now - v.ts > 900) critters.delete(k); }
  });

  /* ===== è‡ªå‹•æ›¿å‹•ç‰©å¤–æ›åŒ…ä¸€å±¤ ping ===== */
  function wrapPing(type){
    const ENT = window.ENT || {};
    const def=ENT[type]; if(!def || typeof def.render!=='function' || def.__pingWrapped) return;
    const orig=def.render;
    def.render=function(ctx,e){
      window.dispatchEvent(new CustomEvent('ent:ping',{detail:{
        id:e.__id||(e.__id=(type+'-'+Math.random().toString(36).slice(2))),
        type, kind:'critter', x:e.x, y:e.y, w:e.w, h:e.h
      }}));
      return orig.call(this,ctx,e);
    };
    def.__pingWrapped=true;
  }
  wrapPing('hamster'); wrapPing('squirrel'); // æœ‰å°±åŒ…èµ·ä¾†ï¼›æ²’æœ‰å°±å¿½ç•¥

  /* ===== å¹ç¬›äº‹ä»¶ï¼ˆKeyL æˆ– dd:fluteï¼‰ ===== */
  const fluteQueue=[];
  function onFlute(){ fluteQueue.push(performance.now()); }
  addEventListener('keydown',(e)=>{ if(e.code==='KeyL') onFlute(); });
  window.addEventListener('dd:flute', onFlute);

  /* ===== æ­Œè²é ˜åŸŸç®¡ç†ï¼ˆæ¯å€‹å¦¤ç¦å„è‡ªæŒæœ‰ï¼‰ ===== */
  function makeAura(cx,cy,r){
    return { cx,cy,r, left:CFG.auraDur, tick:0 };
  }
  function tickAura(e,dt,ctx){
    if(!e._auras || !e._auras.length) return;
    for(let i=e._auras.length-1;i>=0;i--){
      const a=e._auras[i];
      a.left -= dt; a.tick -= dt;
      if(a.tick<=0){
        a.tick += CFG.tick;
        // å°å‚·å®³
        window.dispatchEvent(new CustomEvent('dd:attack',{
          detail:{ shape:'circle', cx:a.cx, cy:a.cy, r:a.r, atk:CFG.dmgPerTick, team:'player', dir:[1,0], meta:{kind:'song-dot'} }
        }));
        // æšˆçœ©ï¼šå»£æ’­ç‹€æ…‹äº‹ä»¶ï¼ˆæ€ªç‰© AI è‹¥æœ‰ç›£è½å°±èƒ½åƒåˆ°ï¼‰
        window.dispatchEvent(new CustomEvent('dd:status',{
          detail:{ shape:'circle', cx:a.cx, cy:a.cy, r:a.r, team:'player', effect:{ stun:CFG.stunSec }, source:'yuqi-song' }
        }));
      }
      // è¦–è¦ºï¼ˆæŸ”å’ŒéŸ³åœˆï¼‰
      if(ctx){
        const p = Math.max(0, a.left/CFG.auraDur);
        ctx.save();
        ctx.globalAlpha = 0.18 + 0.22*p;
        const g = ctx.createRadialGradient(a.cx,a.cy, a.r*0.15, a.cx,a.cy, a.r);
        g.addColorStop(0,'rgba(255,190,255,0.8)');
        g.addColorStop(1,'rgba(255,190,255,0.0)');
        ctx.fillStyle=g;
        ctx.beginPath(); ctx.arc(a.cx,a.cy,a.r,0,Math.PI*2); ctx.fill();
        ctx.restore();
      }
      if(a.left<=0) e._auras.splice(i,1);
    }
  }

  /* ===== å¦¤ç¦å®šç¾© ===== */
  ENT.yuqi={
    label:'å¦¤ç¦ï¼ˆæ­Œæ‰‹ï¼‰',
    kind:'character',
    ai:'singer2',
    stats:{ hp:CFG.hp },

    render(ctx,e){
      const W=loadWorldSnapshot(); const T=W.T;
      const PX_PER_M=T;

      // åˆå§‹åŒ–
      if(!e._init){
        e.w=Math.max(28,Math.floor(T*0.60));
        e.h=Math.max(44,Math.floor(T*1.10));
        e.vx=0; e.vy=0; e.face=1;
        e._last=performance.now()/1000;
        e._goal=null;           // {x,y,ttl}
        e._tameTarget=null;     // {id,acc}
        e._lastSingAt=0;
        e._auras=[];
        e._init=true;
      }

      // æ™‚é–“æ­¥
      const now=performance.now()/1000;
      const dt = Math.min(0.033, now-(e._last||now)); e._last=now;

      /* ---- AIï¼šç›®æ¨™é¸æ“‡ ---- */
      const MAXR = CFG.likeCritterRangeTiles*T;
      let best=null, cx=e.x+e.w/2, cy=e.y+e.h/2;
      for(const v of critters.values()){
        const dx=(v.x+v.w/2)-cx, dy=(v.y+v.h/2)-cy;
        const d2=dx*dx+dy*dy;
        if(d2 <= MAXR*MAXR){
          if(!best || d2<best.d2) best={x:v.x,y:v.y,w:v.w,h:v.h,d2,id:v.id};
        }
      }
      if(best){
        e._goal = { x:best.x, y:best.y, ttl:1.2 };
        e._seekCritterId = best.id;
      }else{
        if(!e._goal || e._goal.ttl<=0){
          const dir = (Math.random()<0.5 ? -1 : 1);
          const roam = dir*(T*(2+Math.random()*4));
          e._goal={ x:cx+roam, y:cy, ttl: 2.2+Math.random()*1.5 };
        }else{
          e._goal.ttl -= dt;
        }
      }

      /* ---- ç§»å‹• + ç°¡æ˜“è·³ç‰† ---- */
      const targetX = (e._goal? e._goal.x : cx);
      const ax = Math.sign(targetX - cx);
      e.vx = ax * CFG.walkSpd;
      if(ax) e.face = ax>0 ? 1 : -1;

      const probeX = ax>=0 ? e.x+e.w+1 : e.x-1;
      const probeW = CFG.wallProbeTiles*T;
      const hitWall = W.isSolidRect(probeX, e.y, probeW, e.h-4);
      if(hitWall && e.onGround && Math.random() < CFG.wallJumpChance){
        e.vy = -CFG.jump;
      }

      e.vy += CFG.grav*dt; if(e.vy>2000) e.vy=2000;
      moveWithCollisions(e, dt);

      /* ---- æ”¶æœå¯µç‰©ï¼ˆèˆ‡å‹•ç‰©é‡ç–Šç´¯ç©æ™‚é–“ï¼‰ ---- */
      if(best){
        const bx=best.x, by=best.y, bw=best.w||28, bh=best.h||28;
        const overlap = !( (e.x+e.w)<bx || (bx+bw)<e.x || (e.y+e.h)<by || (by+bh)<e.y );
        if(overlap){
          if(!e._tameTarget || e._tameTarget.id!==best.id) e._tameTarget={id:best.id, acc:0};
          e._tameTarget.acc += dt;
          if(e._tameTarget.acc >= CFG.tameOverlapSec){
            (GEAR.pets||(GEAR.pets=[])).push({ type:'pet_'+(best.id||'critter'), name:'è¢«æ”¶æœçš„å°å¤¥ä¼´' });
            if(window.saveGear) window.saveGear();
            e._tameTarget=null;
            if(window.toast) window.toast('ğŸ¶ å¦¤ç¦æ”¶æœäº†ä¸€éš»å°å‹•ç‰©ï¼');
          }
        }else{
          if(e._tameTarget && e._tameTarget.id===best.id) e._tameTarget.acc=Math.max(0, e._tameTarget.acc-dt*0.6);
        }
      }else{
        e._tameTarget=null;
      }

      /* ---- å¹ç¬› â†’ æœ‰æ©Ÿç‡å•Ÿå‹•æ­Œè²é ˜åŸŸï¼ˆDoT + Stunï¼‰ ---- */
      if(fluteQueue.length){
        const _ = fluteQueue.shift(); // æ‹¿ä¸€å€‹è¨Šè™Ÿ
        const tooSoon = (now - e._lastSingAt) < CFG.minSingInterval;
        if(!tooSoon && Math.random() < CFG.singChance){
          e._lastSingAt = now;
          const r  = CFG.meters * PX_PER_M;
          const ocx = e.x + e.w/2, ocy = e.y + e.h/2;
          e._auras.push( makeAura(ocx, ocy, r) );
        }
      }

      /* ---- æ­Œè²é ˜åŸŸï¼šæŒçºŒè§¸ç™¼æ”»æ“Šèˆ‡æšˆçœ© ---- */
      tickAura(e, dt, ctx);

      /* ---- è¦–è¦ºï¼ˆç°¡æ½”ç²‰ç³»æ­Œæ‰‹ï¼‰ ---- */
      const t=now; const sway=Math.sin(t*2.2)*3;
      ctx.save();
      ctx.translate(e.x+e.w/2, e.y+e.h);
      ctx.scale(e.face>0?1:-1,1);
      // éº¥å…‹é¢¨æ¶
      ctx.fillStyle='#d16ad3';
      ctx.fillRect( e.w*0.15, -e.h*0.98, 3, e.h*0.96 );
      ctx.beginPath(); ctx.arc(e.w*0.15+1.5, -e.h*0.98, 6, 0, Math.PI*2); ctx.fill();
      // é•·é«®
      ctx.fillStyle='#f7b7ff';
      ctx.beginPath(); ctx.ellipse(-e.w*0.08, -e.h*0.82, e.w*0.22, e.h*0.32, 0, 0, Math.PI*2); ctx.fill();
      // ç¦®æœ
      const g=ctx.createLinearGradient(0,-e.h*0.9,0,0);
      g.addColorStop(0,'#ffd8ff'); g.addColorStop(1,'#ffbdf2');
      ctx.fillStyle=g;
      ctx.save(); ctx.rotate(sway*0.01);
      roundRect(ctx, -e.w*0.22, -e.h*0.85, e.w*0.44, e.h*0.78, 8); ctx.fill();
      ctx.restore();
      ctx.restore();
    }
  };

  function roundRect(ctx,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  /* ===== å¯é¸ UIï¼šå³ä¸‹è§’åŠ ã€ŒğŸº å¹ç¬›ã€æŒ‰éˆ• ===== */
  (function injectFluteBtn(){
    const controls = document.getElementById('controls');
    if(!controls) return;
    let right = controls.querySelector('.cluster.right');
    if(!right){
      const d=document.createElement('div');
      d.className='cluster right';
      d.style.cssText='position:absolute;right:12px;bottom:12px;display:flex;gap:10px;align-items:flex-end;flex-direction:column';
      controls.appendChild((right=d));
    }
    if(right.querySelector('#btn-flute')) return;
    const b=document.createElement('div');
    b.id='btn-flute';
    b.textContent='ğŸº';
    b.style.cssText='width:56px;height:56px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:26px;backdrop-filter:blur(4px);pointer-events:auto;user-select:none;';
    right.prepend(b);
    const fire=()=>{ window.dispatchEvent(new CustomEvent('dd:flute')); };
    b.addEventListener('touchstart', (e)=>{ fire(); e.preventDefault(); }, {passive:false});
    b.addEventListener('mousedown', (e)=>{ fire(); e.preventDefault(); });
  })();

  // è‹¥æ­¤æ™‚æ­£åœåœ¨ã€Œäººç‰©ã€åˆ†é ï¼Œåˆ·æ–°ä¸€æ¬¡åˆ—è¡¨
  const charBtn=document.querySelector('#palette .pill[data-cat="characters"]');
  if(charBtn && charBtn.classList.contains('active')) charBtn.click();

})();</script>
//å¦¤ç¦æ’ä»¶çµæŸ

//äººç‰©æ’ä»¶çµæŸ



//å³ä¸‹è§’ã€ŒğŸ¥©é¦´é¤Šã€æŒ‰éˆ•
<script>
(()=> {
  'use strict';
  function sendKey(code, type){
    const ev = new KeyboardEvent(type, { code, key: code, bubbles: true });
    window.dispatchEvent(ev);
  }
  function injectTameButton(){
    const controls = document.getElementById('controls');
    if(!controls) return;                           // Phase3 æœƒå»ºç«‹
    const right = controls.querySelector('.cluster.right');
    if(!right) return;
    if(document.getElementById('btn-tame')) return; // å·²å­˜åœ¨å°±ä¸é‡è¤‡

    const b = document.createElement('div');
    b.id = 'btn-tame';
    b.className = 'key';
    b.textContent = 'ğŸ¥© é¦´é¤Š';
    b.title = 'ç”¨è…è‚‰å˜—è©¦é¦´åŒ–é™„è¿‘æ¾é¼ ';
    b.style.cssText = 'width:84px;height:40px;border-radius:10px;background:rgba(255,255,255,.12);backdrop-filter:blur(4px);font-weight:900;pointer-events:auto;display:flex;align-items:center;justify-content:center;';

    // é»ä¸€ä¸‹ â†’ ç™¼å‡º dd:tameï¼Œä¸¦ç›¸å®¹èˆŠ KeyF
    const fire = (e)=>{
      window.dispatchEvent(new CustomEvent('dd:tame', { detail:{ source:'button' }}));
      sendKey('KeyF','keydown'); setTimeout(()=>sendKey('KeyF','keyup'), 20);
      e.preventDefault();
    };
    b.addEventListener('click',  fire);
    b.addEventListener('touchend', fire, {passive:false});

    right.appendChild(b);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', injectTameButton);
  } else {
    injectTameButton();
  }
})();
</script>

<!-- å¤–æ›ï¼šäººç‰©åˆ†é æ¸²æŸ“ï¼ˆä¸è¦†è“‹ Phase1ï¼›è®“ã€Œäººç‰©ã€pill æ­£å¸¸å·¥ä½œï¼‰ -->
<script>
(()=> {
  'use strict';

  const ENT = window.ENT || (window.ENT = {});

  // 1) è‹¥æ²’æœ‰ã€Œäººç‰©ã€pillï¼Œå»ºç«‹ä¸€é¡†
  const hdr = document.querySelector('#palette .pal-row.header');
  if (hdr && !hdr.querySelector('.pill[data-cat="characters"]')) {
    const btn = document.createElement('button');
    btn.className = 'pill';
    btn.setAttribute('data-cat','characters');
    btn.textContent = 'äººç‰©';
    const backBtn = document.getElementById('palBackBtn');
    hdr.insertBefore(btn, backBtn); // æ”¾åœ¨ã€Œè¿”å›ã€å‰
  }

  // 2) é»æ“Šã€Œäººç‰©ã€â†’ ç›´æ¥æ¸²æŸ“äººç‰©æ¸…å–®åˆ° #palTiles
  const pal = document.getElementById('palette');
  const tilesBox = document.getElementById('palTiles');
  const backBtn  = document.getElementById('palBackBtn');

  function renderCharacters(){
    // æ¨™è¨˜ pill ç‹€æ…‹
    document.querySelectorAll('#palette .pill[data-cat]').forEach(b=>b.classList.remove('active'));
    const charBtn = document.querySelector('#palette .pill[data-cat="characters"]');
    if (charBtn) charBtn.classList.add('active');
    if (backBtn) backBtn.classList.remove('hidden');

    // æ”¶é›† ENT ä¸­ kind==='character' çš„é …ç›®
    const items = [];
    for (const [key, def] of Object.entries(ENT)) {
      if (def && def.kind === 'character') {
        items.push({label: def.label || key, val: key});
      }
    }

    tilesBox.innerHTML = '';
    if (items.length === 0) {
      const div = document.createElement('div');
      div.className = 'tile';
      div.textContent = 'ï¼ˆå°šç„¡äººç‰©ï¼‰';
      div.style.opacity = .7;
      tilesBox.appendChild(div);
      return;
    }

    // é€ å‡ºæ¯å€‹å¯é» tileï¼›data-brush=å¯¦é«”éµ
    items.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'tile';
      div.setAttribute('data-brush', it.val);
      div.textContent = it.label;
      tilesBox.appendChild(div);
    });

    // ä¸éœ€è¦è‡ªå·±è™•ç† brushï¼šä½ çš„ Phase1 å·²æœ‰é¢æ¿çš„äº‹ä»¶ä»£ç†ï¼Œ
    // æœƒè®€å– .tile çš„ data-brush ä¸¦è¨­å®šç•«ç­†ï¼Œç„¶å¾Œå°±èƒ½æ”¾åœ¨åœ°åœ–ä¸Šäº†ã€‚
  }

  // 3) æ¥æ‰‹ã€Œäººç‰©ã€pill çš„é»æ“Š
  pal.addEventListener('click', (e)=>{
    const b = e.target.closest('.pill[data-cat="characters"]');
    if (b) { renderCharacters(); }
  });

  // 4) è‹¥è¼‰å…¥æ™‚ã€Œäººç‰©ã€pillå·²æ˜¯ activeï¼ˆå°‘è¦‹ï¼‰ï¼Œä¹Ÿåˆ·æ–°ä¸€æ¬¡
  const initCharActive = document.querySelector('#palette .pill[data-cat="characters"].active');
  if (initCharActive) renderCharacters();

})();
</script>



<!-- ====== ğŸ– ä¸»æŒ‰éˆ• + å­é¸å–® Script é–‹å§‹ ====== -->
<script>
(()=> {
  'use strict';

  function sendKey(code, type){
    const ev = new KeyboardEvent(type, { code, key: code, bubbles: true });
    window.dispatchEvent(ev);
  }

  function ensureHandMenu(){
    const controls = document.getElementById('controls');
    if(!controls) return;

    let right = controls.querySelector('.cluster.right');
    if(!right){
      right = document.createElement('div');
      right.className='cluster right';
      right.style.cssText='position:absolute;right:12px;bottom:12px;display:flex;gap:10px;align-items:flex-end;flex-direction:column';
      controls.appendChild(right);
    }

    let hand =
      controls.querySelector('#btn-hand') ||
      controls.querySelector('[data-action="hand"]') ||
      Array.from(controls.querySelectorAll('.key,div,button'))
           .find(el => (el.textContent||'').includes('ğŸ–'));

    if(!hand){
      hand = document.createElement('div');
      hand.id = 'btn-hand';
      hand.className = 'key';
      hand.textContent = 'ğŸ–';
      hand.title = 'äº’å‹•';
      hand.style.cssText = 'width:56px;height:56px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:26px;backdrop-filter:blur(4px);pointer-events:auto;user-select:none;';
      right.insertBefore(hand, right.firstChild || null);
      hand.style.marginBottom = '10px';
    }

    // ç§»é™¤èˆŠçš„ ğŸº / ğŸ¥© ç¨ç«‹æŒ‰éˆ•
    ['btn-flute','btn-tame'].forEach(id=>{
      const old = document.getElementById(id);
      if(old && old.parentElement) old.parentElement.removeChild(old);
    });

    if(hand.querySelector('.hand-menu')) return;

    const menu = document.createElement('div');
    menu.className = 'hand-menu';
    menu.style.cssText = [
      'position:absolute',
      'bottom:64px',
      'right:0',
      'display:none',
      'flex-direction:column',
      'gap:8px',
      'padding:10px',
      'border-radius:12px',
      'background:rgba(12,14,28,.75)',
      'border:1px solid rgba(255,255,255,.18)',
      'backdrop-filter:blur(6px)',
      'box-shadow:0 8px 26px rgba(0,0,0,.35)',
      'z-index:9999'
    ].join(';');

    const btnCss = 'width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;user-select:none;cursor:pointer;';

    // ğŸº å¹ç¬›
    const bFlute = document.createElement('div');
    bFlute.className = 'hand-menu-item';
    bFlute.textContent = 'ğŸº';
    bFlute.title = 'å¹ç¬›ï¼ˆæ´¾é€ dd:fluteï¼‰';
    bFlute.style.cssText = btnCss;
    const fireFlute = ()=>window.dispatchEvent(new CustomEvent('dd:flute'));
    // âœ… é»æ“Šå¾Œä¸è‡ªå‹•æ”¶èµ·
    bFlute.addEventListener('click', (e)=>{ fireFlute(); e.preventDefault(); }, {passive:false});
    bFlute.addEventListener('touchend', (e)=>{ fireFlute(); e.preventDefault(); }, {passive:false});

    // ğŸ¥© é¦´é¤Š
    const bTame = document.createElement('div');
    bTame.className = 'hand-menu-item';
    bTame.textContent = 'ğŸ¥©';
    bTame.title = 'é¦´é¤Šï¼ˆæ´¾é€ dd:tame + KeyFï¼‰';
    bTame.style.cssText = btnCss;
    const fireTame = ()=>{
      window.dispatchEvent(new CustomEvent('dd:tame', { detail:{ source:'hand-menu' }}));
      sendKey('KeyF','keydown'); setTimeout(()=>sendKey('KeyF','keyup'), 20);
    };
    // âœ… é»æ“Šå¾Œä¸è‡ªå‹•æ”¶èµ·
    bTame.addEventListener('click', (e)=>{ fireTame(); e.preventDefault(); }, {passive:false});
    bTame.addEventListener('touchend', (e)=>{ fireTame(); e.preventDefault(); }, {passive:false});

    menu.appendChild(bFlute);
    menu.appendChild(bTame);

    hand.style.position = 'relative';
    hand.appendChild(menu);

    let open = false;
    const showMenu = ()=>{ menu.style.display = 'flex'; requestAnimationFrame(()=>{ open = true; }); };
    const hideMenu = ()=>{ menu.style.display = 'none'; open = false; };
    const toggleMenu = ()=>{ open ? hideMenu() : showMenu(); };

    // âœ… åªæœ‰é»ğŸ–ä¸»æŒ‰éˆ•æ‰æœƒé–‹/é—œ
    hand.addEventListener('click', (e)=>{
  if (e.target !== hand) return;   // åªæ¥å—é»åˆ° ğŸ–æœ¬é«”
  e.preventDefault();
  e.stopPropagation();
  toggleMenu();
}, {passive:false});


    // âœ… é•·æŒ‰åªè² è²¬ã€Œæ‰“é–‹ã€ï¼Œä¸æœƒè‡ªå‹•é—œé–‰
    hand.addEventListener('touchstart', (e)=>{
      let held = false;
      const t = setTimeout(()=>{ held = true; showMenu(); }, 250);
      const end = ()=>{ clearTimeout(t); hand.removeEventListener('touchend', end); hand.removeEventListener('touchmove', cancel);
        if(!held) toggleMenu(); // çŸ­æŒ‰ => åˆ‡æ›
      };
      const cancel = ()=>{ clearTimeout(t); };
      hand.addEventListener('touchend', end, {once:true});
      hand.addEventListener('touchmove', cancel, {once:true});
      e.preventDefault();
    }, {passive:false});

    // âŒ ç§»é™¤å¤–éƒ¨é»æ“Šèˆ‡ ESC è‡ªå‹•é—œé–‰ï¼ˆæ”¹ç”±ğŸ–æ§åˆ¶ï¼‰
    // document.addEventListener('click', (e)=>{ if(open && !hand.contains(e.target)) hideMenu(); });
    // window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideMenu(); });
  }

  function init(){
    const controls = document.getElementById('controls');
    if(!controls){
      const obs = new MutationObserver((muts, ob)=>{
        if(document.getElementById('controls')){ ensureHandMenu(); ob.disconnect(); }
      });
      obs.observe(document.documentElement || document.body, { childList:true, subtree:true });
      return;
    }
    ensureHandMenu();
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();
</script>
<!-- ====== ğŸ– ä¸»æŒ‰éˆ• + å­é¸å–® Script çµæŸ ====== -->

<!-- ====== ğŸ– è¦†è“‹æª”ï¼šåªç”¨ä¸»æŒ‰éˆ•é–‹/é—œï¼Œå­é …ç›®ä¸é—œé¸å–® ====== -->
<script>
(()=> {
  'use strict';

  function ready(selector, cb){
    const el = document.querySelector(selector);
    if (el) return cb(el);
    const obs = new MutationObserver(()=>{
      const el2 = document.querySelector(selector);
      if (el2){ obs.disconnect(); cb(el2); }
    });
    obs.observe(document.documentElement||document.body, {childList:true, subtree:true});
  }

  // ç­‰å¾… ğŸ– ä¸»æŒ‰éˆ•å‡ºç¾
  ready('#btn-hand', (hand)=>{
    // ç­‰åˆ°å­é¸å–®å‡ºç¾
    const ensureMenu = ()=>{
      const menu = hand.querySelector('.hand-menu');
      if (!menu) return false;

      // 1) é˜»æ­¢å­é¸å–®å…§çš„é»æ“Š/è§¸æ§å¾€ä¸Šå†’æ³¡ï¼ˆé¿å…è§¸ç™¼ hand çš„åˆ‡æ›ï¼‰
      const stop = e => { e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.(); };
      menu.addEventListener('click', stop, {passive:false});
      menu.addEventListener('touchstart', stop, {passive:false});
      menu.addEventListener('touchend', stop, {passive:false});

      // ä¹Ÿå¹«å­æŒ‰éˆ•æœ¬é«”åŠ ä¸Šä¿éšª
      const btns = menu.querySelectorAll('.hand-menu-item, .hand-menu *');
      btns.forEach(btn=>{
        btn.addEventListener('click', stop, {passive:false});
        btn.addEventListener('touchend', stop, {passive:false});
      });

      // 2) åœ¨æ•ç²éšæ®µæ””æˆª hand çš„ click/touchï¼š
      //    åªæœ‰ã€Œé»åˆ° hand æœ¬é«”ã€æ‰å¾€å¾Œå‚³åˆ°åŸæœ¬çš„ toggle ç›£è½ï¼›
      //    é»åˆ°å­å­«å°±ç›´æ¥æ“‹æ‰ï¼Œé¿å…è§¸ç™¼æ”¶åˆã€‚
      const gate = (e)=>{
        // åªæ”¾è¡Œé»åˆ° hand æœ¬é«”çš„äº‹ä»¶
        if (e.target !== hand){
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation?.();
        }
      };
      hand.addEventListener('click', gate, {capture:true, passive:false});
      hand.addEventListener('touchstart', gate, {capture:true, passive:false});

      // 3) å¯é¸ï¼šé˜²æ­¢é é¢å…¶å®ƒå€åŸŸèª¤è§¸é€ æˆé—œé–‰ï¼ˆè‹¥ä½ çš„åŸç¢¼æœ‰å¤–éƒ¨é»æ“Šé—œé–‰ï¼‰
      // document.addEventListener('click', (e)=>{
      //   if (menu.style.display === 'flex' && !hand.contains(e.target)) {
      //     // ç›´æ¥åƒæ‰æ­¤äº‹ä»¶ï¼Œé¿å…å¤–éƒ¨é—œé–‰
      //     e.stopPropagation();
      //     e.stopImmediatePropagation?.();
      //   }
      // }, {capture:true});

      return true;
    };

    if (!ensureMenu()){
      // è‹¥æ­¤åˆ» hand-menu é‚„æ²’åŠ åˆ° DOMï¼Œè§€å¯Ÿä¸¦ç¨å¾Œè£œä¸Š
      const obs = new MutationObserver(()=>{
        if (ensureMenu()) obs.disconnect();
      });
      obs.observe(hand, {childList:true, subtree:true});
    }
  });

})();
</script>
<!-- ====== è¦†è“‹æª”çµæŸ ====== -->


<!-- ====== ğŸ– å­é¸å–®ï¼šæ“´å…… API é–‹å§‹ ====== -->
<script>
(() => {
  'use strict';

  function getHandAndMenu(){
    const controls = document.getElementById('controls');
    if(!controls) return {};
    const hand =
      controls.querySelector('#btn-hand') ||
      controls.querySelector('[data-action="hand"]') ||
      Array.from(controls.querySelectorAll('.key,div,button'))
           .find(el => (el.textContent||'').includes('ğŸ–'));
    const menu = hand && hand.querySelector('.hand-menu');
    return { hand, menu };
  }

  window.DD = window.DD || {};
  const REG = window.DD._handActions = window.DD._handActions || new Map();

  function rerender(){
    const { menu } = getHandAndMenu();
    if(!menu) return;
    menu.innerHTML = '';

    const items = Array.from(REG.values())
      .filter(x => (typeof x.visible==='function' ? !!x.visible() : x.visible!==false))
      .sort((a,b) => (a.order||100) - (b.order||100));

    items.forEach((item) => {
      if (item.type === 'separator') {
        const hr = document.createElement('div');
        hr.style.cssText = 'height:1px;background:rgba(255,255,255,.12);margin:4px 0';
        menu.appendChild(hr);
        return;
      }

      const btn = document.createElement('div');
      btn.style.cssText = 'width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;user-select:none;cursor:pointer;';
      btn.title = item.title || item.label || item.id || '';
      btn.textContent = item.icon || 'â€¢'; // åªé¡¯ç¤ºåœ–ç¤º

      const disabled = (typeof item.disabled==='function') ? !!item.disabled() : !!item.disabled;
      if(disabled){ btn.style.opacity = .5; btn.style.cursor = 'not-allowed'; }

      function hideMenu(){
        menu.style.display = 'none';
        const hand = menu.parentElement;
        if(hand) hand._handMenuOpen = false;
      }
      const fire = (ev)=>{
        if(disabled) return ev && ev.preventDefault();
        try{ item.onTrigger && item.onTrigger(ev); }
        finally{ if(item.autoClose !== false) hideMenu(); }
      };
      btn.addEventListener('click', fire, {passive:false});
      btn.addEventListener('touchend', (e)=>{ fire(e); e.preventDefault(); }, {passive:false});

      menu.appendChild(btn);
    });
  }

  window.DD.registerHandAction = function(action){
    if(!action || !action.id) throw new Error('registerHandAction éœ€è¦å”¯ä¸€ id');
    REG.set(action.id, action); rerender();
  };
  window.DD.unregisterHandAction = function(id){ REG.delete(id); rerender(); };
  window.DD.refreshHandMenu = rerender;

  // é è¨­è¨»å†Š ğŸº èˆ‡ ğŸ¥©
  if(!REG.has('flute')){
    window.DD.registerHandAction({ id:'flute', icon:'ğŸº', title:'å¹ç¬›ï¼ˆæ´¾é€ dd:fluteï¼‰', order:10,
      onTrigger(){ window.dispatchEvent(new CustomEvent('dd:flute')); } });
  }
  if(!REG.has('sep-1')) window.DD.registerHandAction({ id:'sep-1', type:'separator', order:49 });
  if(!REG.has('tame')){
    window.DD.registerHandAction({ id:'tame', icon:'ğŸ¥©', title:'é¦´é¤Šï¼ˆæ´¾é€ dd:tame + KeyFï¼‰', order:50,
      onTrigger(){
        window.dispatchEvent(new CustomEvent('dd:tame',{detail:{source:'hand-menu'}}));
        const evDown = new KeyboardEvent('keydown',{code:'KeyF',key:'KeyF',bubbles:true});
        const evUp   = new KeyboardEvent('keyup',{code:'KeyF',key:'KeyF',bubbles:true});
        window.dispatchEvent(evDown); setTimeout(()=>window.dispatchEvent(evUp),20);
      }
    });
  }

  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', rerender); }
  else{ rerender(); }
})();
</script>
<!-- ====== ğŸ– å­é¸å–®ï¼šæ“´å…… API çµæŸ ====== -->


<!-- B) å¤–æ›ï¼šMELEE8ï¼ˆåªé€ dd:slashï¼›ä¸è‡ªç•«ï¼‰ + æ‰‹æ©ŸğŸ”ªæŒ‰éˆ• -->
<script>
(() => {
  'use strict';

  // æ–¹å‘ï¼ˆéµç›¤/æ‰‹æ©Ÿéƒ½æœƒæ›´æ–°ï¼‰
  const DIR = (window.__attackDir ||= {x:1,y:0});

  // ä¸–ç•Œ tileSizeï¼ˆæ¯”ä¾‹ï¼‰
  const SAVEK='dd_skel_phase1';
  let T = 48;
  try{ const d=JSON.parse(localStorage.getItem(SAVEK)||'{}'); T = d.tileSize||48; }catch{}

  // å‡ºåˆ€åƒæ•¸ï¼ˆä¸å«ä»»ä½•ç¹ªè£½ï¼‰
  const cfg = { damage: 10, cooldown: 0.24, life: 0.18 };
  let cd = 0;

  function ensurePlayer(){ return (typeof window.__ensurePlayer==='function') ? window.__ensurePlayer() : null; }
  function isPlay(){ return (typeof window.__getMode==='function') ? window.__getMode()==='play' : true; }

  // å‡ºåˆ€ï¼ˆJï¼‰
  addEventListener('keydown', (e)=>{
    if(e.code!=='KeyJ') return;
    if(!isPlay()) return;
    if(cd>0) return;

    const p = ensurePlayer(); if(!p) return;

    // æ–¹å‘ï¼šæ²’è¼¸å…¥å°±ç”¨é¢å‘
    let dx = DIR.x, dy = DIR.y;
    if(Math.abs(dx)+Math.abs(dy) < 0.0001){
      const f = (typeof p.face==='number'?p.face:1);
      dx = f>=0?1:-1; dy = 0;
    }
    const len = Math.hypot(dx,dy)||1; dx/=len; dy/=len;

    // è®“åˆ€å…‰è²¼èº«ï¼šåŠå¾‘èˆ‡åç§»ä¾è§’è‰²å°ºå¯¸
    const body = Math.max(p.w, p.h);
    const r   = Math.max(14, body * 0.46);
    const off = Math.max(10, body * 0.52);
    const cx = p.x + p.w/2 + dx*off;
    const cy = p.y + p.h/2 + dy*off;

    // åªé€ã€Œä¸€æ¬¡ã€è¯éº—åˆ€å…‰äº‹ä»¶ï¼ˆå¸¶æ­¦å™¨å¤–è§€ï¼‰
    const weapon = (window.WEAPON && WEAPON.get && WEAPON.get()) ||
                   { blade:'#ffd34e', edge:'#fff', trail:'rgba(255,220,120,0.35)', len:48, width:9 };

    window.dispatchEvent(new CustomEvent('dd:slash', {
      detail: { cx, cy, dx, dy, r, dur: cfg.life, swing:'topdown', weapon }
    }));

    // å‚·å®³äº¤çµ¦ DD_HITBOX
    window.dispatchEvent(new CustomEvent('dd:attack', {
      detail:{ shape:'circle', cx, cy, r, atk:cfg.damage, team:'player', dir:[dx,dy], meta:{kind:'melee'} }
    }));

    cd = cfg.cooldown;
  });

  // ç°¡å–®å†·å»è¨ˆæ™‚
  (function loop(){ if(cd>0) cd=Math.max(0, cd-1/60); requestAnimationFrame(loop); })();

  // ===== æ‰‹æ©ŸğŸ”ªæŒ‰éˆ•ï¼ˆæ‹–ç§»æ”¹æ–¹å‘ï¼›é»ä¸€ä¸‹å‡ºåˆ€ï¼‰ =====
  function sendKey(code, type){
    const ev = new KeyboardEvent(type, { code, key: code, bubbles: true });
    window.dispatchEvent(ev);
  }
  function injectKnifeButton(){
    if(document.getElementById('btn-knife')) return;
    const controls = document.getElementById('controls'); if(!controls) return;

    let right = controls.querySelector('.cluster.right');
    if(!right){
      right = document.createElement('div');
      right.className = 'cluster right';
      right.style.cssText = 'position:absolute;right:12px;bottom:12px;display:flex;gap:10px;align-items:flex-end;flex-direction:column';
      controls.appendChild(right);
    }

    const base = document.createElement('div');
    base.id = 'btn-knife';
    base.style.cssText = `
      width:64px;height:64px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      position:relative; pointer-events:auto; user-select:none;
      touch-action:none; display:flex;align-items:center;justify-content:center;
      font-size:28px; line-height:1; backdrop-filter:blur(4px);
    `;
    base.textContent = 'ğŸ”ª';
    // æŠŠğŸ”ªæ’åœ¨ğŸ–ä¸‹é¢ï¼›æ‰¾ä¸åˆ°ğŸ–å°±åŠ åœ¨æœ€å¾Œ
const handBtn =
  right.querySelector('#btn-hand') ||
  right.querySelector('[data-action="hand"]') ||
  Array.from(right.querySelectorAll('.key,div,button'))
       .find(el => (el.textContent||'').includes('ğŸ–'));

if (handBtn && handBtn.parentElement === right) {
  right.insertBefore(base, handBtn.nextSibling);
} else {
  right.appendChild(base);
}

    const R=28, TAP=12; let dragging=false, moved=0;
    function setDir(dx,dy){ const l=Math.hypot(dx,dy); if(l>=4){ DIR.x=dx/l; DIR.y=dy/l; } }
    function P(ev){ if(ev.touches&&ev.touches[0]) return {x:ev.touches[0].clientX,y:ev.touches[0].clientY}; return {x:ev.clientX,y:ev.clientY}; }
    function onDown(e){ dragging=true; moved=0; base.style.boxShadow='0 0 0 6px rgba(255,255,255,0.10)'; e.preventDefault(); }
    function onMove(e){
      if(!dragging) return;
      const p=P(e), rc=base.getBoundingClientRect();
      const dx=p.x-(rc.left+rc.width/2), dy=p.y-(rc.top+rc.height/2);
      moved=Math.max(moved, Math.hypot(dx,dy));
      const l=Math.hypot(dx,dy)||1, k=Math.min(1,R/l);
      base.style.transform=`translate(${dx*k*0.2}px, ${dy*k*0.2}px)`; // è¦–è¦ºå¾®å‹•
      setDir(dx,dy);
      e.preventDefault();
    }
    function onUp(e){
      if(!dragging) return;
      dragging=false;
      base.style.boxShadow='0 0 0 0 rgba(255,255,255,0)';
      base.style.transform='translate(0,0)';
      if(moved<TAP){ sendKey('KeyJ','keydown'); setTimeout(()=>sendKey('KeyJ','keyup'),30); }
      e.preventDefault();
    }
    base.addEventListener('touchstart', onDown, {passive:false});
    base.addEventListener('touchmove',  onMove,  {passive:false});
    base.addEventListener('touchend',   onUp,    {passive:false});
    base.addEventListener('touchcancel',onUp,    {passive:false});
    base.addEventListener('pointerdown',onDown);
    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup',   onUp);
    window.addEventListener('blur',        onUp);
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', injectKnifeButton); } else { injectKnifeButton(); }
})();
</script>

//ğŸ”ªæ”»æ“ŠæŒ‰éˆ•çµæŸ

//åˆ€å…‰é–‹å§‹
<!-- C) å¤–æ›ï¼šæ­¦å£«åˆ€æ®ç ï¼ˆç´°é•·ç‰ˆï¼‰ -->
<script>
(() => {
  'use strict';

  const slashes = [];

  // ====== ç´°é•·æ­¦å£«åˆ€æ¨£å¼ ======
  const KATANA = {
    blade: '#eaf0f9',
    edge:  '#ffffff',
    trail: 'rgba(150,200,255,0.35)',
    len:   96,   // åˆ€é•·ï¼ˆç´°é•· â†’ æ‹‰é•·ï¼‰
    width: 6     // åŸºç¤åˆ€å¯¬ï¼ˆæ›´ç´°ï¼‰
  };

  const STYLE = {
    segs: 18,                         // æ›´ç´°åˆ†æ®µ
    width: t => 1 - 0.8*t,            // taper æ›´åŠ‡çƒˆï¼Œå°¾ç«¯æ¥µç´°
    fade:  t => 1 - t*t,
    rotEase: t => 1 - (1-t)*(1-t),
    curveAmt: 0.30,                   // å¾®å½åº¦
    sideFlipByFacing: true,
    trailBlend: 'lighter',
    bladeBlend: 'source-over'
  };

  window.addEventListener('dd:slash', (ev) => {
    const d = ev.detail || {};
    const weapon = Object.assign({}, KATANA, d.weapon || {});
    slashes.push({
      cx: d.cx|0, cy: d.cy|0,
      dx: d.dx||1, dy: d.dy||0,
      ang0: Math.atan2(d.dy||0, d.dx||1),
      r: d.r || 60,
      life: 0,
      max: (+d.dur>0 ? +d.dur : 0.20),
      weapon
    });
  });

  let _last = performance.now();
  function tick(now){
    const dt = Math.min(0.033,(now-_last)/1000); _last=now;
    for(let i=slashes.length-1;i>=0;i--){
      slashes[i].life+=dt;
      if(slashes[i].life>=slashes[i].max) slashes.splice(i,1);
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  function sampleCubic(p0,p1,p2,p3,t){
    const u=1-t;
    const x=u*u*u*p0.x+3*u*u*t*p1.x+3*u*t*t*p2.x+t*t*t*p3.x;
    const y=u*u*u*p0.y+3*u*u*t*p1.y+3*u*t*t*p2.y+t*t*t*p3.y;
    const dx=3*u*u*(p1.x-p0.x)+6*u*t*(p2.x-p1.x)+3*t*t*(p3.x-p2.x);
    const dy=3*u*u*(p1.y-p0.y)+6*u*t*(p2.y-p1.y)+3*t*t*(p3.y-p2.y);
    return {x,y,dx,dy};
  }
  function buildCurve(s,tNorm){
    const {cx,cy,ang0,r}=s;
    const extra=Math.PI*0.5*(1-STYLE.rotEase(tNorm));
    const ang=ang0+extra;
    const fwd={x:Math.cos(ang),y:Math.sin(ang)};
    const side={x:-fwd.y,y:fwd.x};
    const flip=STYLE.sideFlipByFacing?Math.sign(Math.cos(s.ang0)||1):1;
    const sway=STYLE.curveAmt*flip;
    const p0={x:cx+fwd.x*(r*0.05),y:cy+fwd.y*(r*0.05)};
    const p3={x:cx+fwd.x*(r*0.98),y:cy+fwd.y*(r*0.98)};
    const sideStrength=r*0.28;
    const p1={x:cx+fwd.x*(r*0.33)+side.x*(sideStrength*sway),
              y:cy+fwd.y*(r*0.33)+side.y*(sideStrength*sway)};
    const p2={x:cx+fwd.x*(r*0.66)+side.x*(sideStrength*-sway),
              y:cy+fwd.y*(r*0.66)+side.y*(sideStrength*-sway)};
    return {p0,p1,p2,p3};
  }
  function extrudeRibbon(curve,segs,baseW,widthFn){
    const L=[],R=[];
    for(let i=0;i<=segs;i++){
      const t=i/segs, pt=sampleCubic(curve.p0,curve.p1,curve.p2,curve.p3,t);
      const v=Math.hypot(pt.dx,pt.dy)||1, nx=-pt.dy/v, ny=pt.dx/v;
      const w=baseW*(widthFn?widthFn(t):(1-0.65*t));
      L.push({x:pt.x+nx*w,y:pt.y+ny*w});
      R.push({x:pt.x-nx*w,y:pt.y-ny*w});
    }
    return {left:L,right:R};
  }
  function fillRibbon(ctx,L,R){
    ctx.beginPath();
    ctx.moveTo(L[0].x,L[0].y);
    for(let i=1;i<L.length;i++) ctx.lineTo(L[i].x,L[i].y);
    for(let i=R.length-1;i>=0;i--) ctx.lineTo(R[i].x,R[i].y);
    ctx.closePath(); ctx.fill();
  }

  function draw(ctx){
    for(const s of slashes){
      const k=Math.min(1,s.life/s.max);
      const fade=STYLE.fade(k);
      const theme=s.weapon;

      const curve=buildCurve(s,k);
      const rib=extrudeRibbon(curve,STYLE.segs,theme.width,STYLE.width);

      // Trail
      ctx.save();
      ctx.globalCompositeOperation=STYLE.trailBlend;
      ctx.globalAlpha=0.25+0.30*fade;
      const g=ctx.createRadialGradient(s.cx,s.cy,(theme.len||96)*0.08,s.cx,s.cy,s.r);
      g.addColorStop(0.00,'rgba(230,240,255,0.85)');
      g.addColorStop(0.35,theme.trail);
      g.addColorStop(1.00,'rgba(180,220,255,0.0)');
      ctx.fillStyle=g;
      fillRibbon(ctx,rib.left,rib.right);
      ctx.restore();

      // Blade
      ctx.save();
      ctx.globalCompositeOperation=STYLE.bladeBlend;
      ctx.globalAlpha=0.97;
      ctx.fillStyle=theme.blade;
      fillRibbon(ctx,rib.left,rib.right);

      // å–®å´äº®åˆƒ
      ctx.globalAlpha=0.8;
      ctx.strokeStyle=theme.edge;
      ctx.lineWidth=1.2;
      ctx.beginPath();
      ctx.moveTo(rib.left[0].x,rib.left[0].y);
      for(let i=1;i<rib.left.length;i++) ctx.lineTo(rib.left[i].x,rib.left[i].y);
      ctx.stroke();

      // åˆ€å°–å…‰
      const tipL=rib.left[rib.left.length-1];
      const tipR=rib.right[rib.right.length-1];
      const tipX=(tipL.x+tipR.x)/2, tipY=(tipL.y+tipR.y)/2;
      ctx.globalAlpha=0.85*fade;
      const glow=ctx.createRadialGradient(tipX,tipY,0,tipX,tipY,Math.max(10,theme.width*3));
      glow.addColorStop(0,'rgba(255,255,255,0.95)');
      glow.addColorStop(1,'rgba(200,230,255,0.0)');
      ctx.fillStyle=glow;
      ctx.beginPath(); ctx.arc(tipX,tipY,Math.max(8,theme.width*2),0,Math.PI*2); ctx.fill();

      ctx.restore();
    }
  }

  window.__drawCombat=draw;
})();
</script>
//åˆ€å…‰çµæŸ



<script>
/* ===== Tile å¤–æ› APIï¼ˆä¸€æ¬¡æ€§æ©‹æ¥ï¼‰======================================
   åŠŸèƒ½ï¼š
   - TILES.add({ key, label, solid, draw, onEnter, onStay, onExit, meta })
   - è‡ªå‹•æŠŠ tile æ”¾åˆ°ã€Œå»ºç¯‰ã€åˆ†é¡çš„èª¿è‰²ç›¤ï¼ˆå¯ç›´æ¥æ”¾ç½®åˆ°åœ°åœ–ï¼‰
   - __tileIsSolidï¼šè®“æ ¸å¿ƒç¢°æ’é‚è¼¯èªå¾—å¤–æ› tile çš„å¯¦å¿ƒèˆ‡å¦
   - __drawUnknownTileï¼šè®“æ ¸å¿ƒæ¸²æŸ“æœªçŸ¥å­—å…ƒæ™‚ï¼Œäº¤çµ¦å¤–æ›çš„ draw
   - è‡ªå‹•åµæ¸¬ç©å®¶ç«™åœ¨å“ªæ ¼ â†’ è§¸ç™¼ onEnter/onStay/onExitï¼ˆä¸æ”¹æ ¸å¿ƒï¼‰
   ====================================================================== */
(()=> {
  // ---- è¨­å‚™æª¢æŸ¥ ----
  const SAVE_KEY = 'dd_skel_phase1';
  // 1) å…¨åŸŸå¤–æ›å®¹å™¨
  const TILES = (window.TILES ||= {
    meta:new Map(),           // key -> {solid, draw, ...}
    hooks:{                   // key -> { onEnter,onStay,onExit }
      onEnter:new Map(), onStay:new Map(), onExit:new Map()
    },
    add(def){
      const {key,label,solid=false,draw,onEnter,onStay,onExit,meta} = def||{};
      if (!key) return;
      // è¨»å†Šåˆ° paletteï¼ˆå»ºç¯‰ï¼‰
      const TT = (window.TILE_TYPES ||= { building:[] });
      if (!TT.building.some(t=>t.val===key)) {
        TT.building.push({ label: label||key, val:key, solid:!!solid });
      }
      // ç´€éŒ„è¡Œç‚º/ç¹ªåœ–
      TILES.meta.set(key, { solid: !!solid, draw, ...(meta||{}) });
      if (onEnter) TILES.hooks.onEnter.set(key,onEnter);
      if (onStay ) TILES.hooks.onStay .set(key,onStay);
      if (onExit ) TILES.hooks.onExit .set(key,onExit);
      // å¦‚æœ palette å·²ç¶“åœ¨ã€Œå»ºç¯‰ã€åˆ†é¡é é¢ï¼Œé‡æ–°æ¸²æŸ“ä¸€æ¬¡
      try {
        const pill = document.querySelector('#palette .pill[data-cat="building"]');
        if (pill && pill.classList.contains('active') && typeof window.__renderCategory==='function'){
          window.__renderCategory('building');
        }
      } catch {}
    }
  });
  window.TILES = TILES;

  // 2) è®“æ ¸å¿ƒå¯å•æˆ‘å€‘ï¼šé€™å€‹å­—å…ƒæ˜¯ä¸æ˜¯å¯¦å¿ƒï¼Ÿ
  window.__tileIsSolid = function(ch){
    const m = TILES.meta.get(ch);
    if (!m) return (ch==='#'); // æ ¸å¿ƒçš„ fallback
    return !!m.solid;
  };

  // 3) è®“æ ¸å¿ƒåœ¨é‡åˆ°æœªçŸ¥å­—å…ƒæ™‚å§”è¨—æˆ‘å€‘ç•«
  window.__drawUnknownTile = function(ctx, ch, px, py, TILE){
    const m = TILES.meta.get(ch);
    if (m && typeof m.draw === 'function'){
      m.draw(ctx, px, py, TILE, ch);
      return true;
    }
    return false;
  };

  // 4) æˆ‘å€‘è‡ªå·±è®€ã€Œå½±å­åœ°åœ–ã€å¿«ç…§ï¼ˆä¸å‹•æ ¸å¿ƒï¼‰
  let _rawCache = null, world = null;
  function loadWorldSnapshot(force=false){
    const raw = localStorage.getItem(SAVE_KEY) || '';
    if (!force && raw===_rawCache) return world;
    _rawCache = raw;
    try{
      const d = JSON.parse(raw||'{}');
      world = {
        w: d.w||40, h:d.h||24,
        tileSize: d.tileSize||48,
        tiles: (d.tileRows||[]).map(r=>r.split('')),
        start: d.start || {x:2,y:(d.h||24)-6}
      };
    }catch{ world = { w:40,h:24,tileSize:48, tiles:[], start:{x:2,y:18} }; }
    return world;
  }
  function tileAtGX(gx,gy){
    if(!world) return '.';
    if (gx<0||gy<0||gx>=world.w||gy>=world.h) return '#';
    const row = world.tiles[gy]||[];
    return row[gx]||'.';
  }

  // 5) è¿½è¹¤ç©å®¶åœ¨å“ªä¸€æ ¼ â†’ è§¸ç™¼ tile hooksï¼ˆenter/stay/exitï¼‰
  const INPUT = { jump:false }; // æä¾›å¤–æ›è®€å–ï¼ˆä¾‹ï¼šæ°´ä¸­æŒ‰ä½è·³ä¸Šæµ®ï¼‰
  addEventListener('keydown', e=>{
    if (window.__getMode && window.__getMode()!=='play') return;
    if (e.code==='Space' || e.code==='ArrowUp' || e.code==='KeyW') INPUT.jump = true;
  });
  addEventListener('keyup', e=>{
    if (e.code==='Space' || e.code==='ArrowUp' || e.code==='KeyW') INPUT.jump = false;
  });
  window.__INPUT = INPUT; // å¤–æ›å¯é¸è®€

  let lastKey = null; // ä¸Šä¸€å¹€æ‰€åœ¨ tile key
  let _lastTs = 0;
  function loop(ts){
    const dt = Math.min(0.033, _lastTs ? (ts - _lastTs)/1000 : 0); _lastTs = ts;
    try{
      if (window.__getMode && window.__getMode()==='play'){
        loadWorldSnapshot(); // åœ°åœ–å¯èƒ½åœ¨ç·¨è¼¯æ™‚è¢«æ”¹
        const p = (window.__ensurePlayer && window.__ensurePlayer());
        if (p && world){
          const T = world.tileSize;
          const gx = Math.floor((p.x + p.w/2)/T);
          const gy = Math.floor((p.y + p.h/2)/T);
          const key = tileAtGX(gx,gy);

          // enter / exit
          if (key !== lastKey){
            const onExit = TILES.hooks.onExit.get(lastKey);
            if (onExit) try{ onExit({e:p,gx,gy,dt,world,INPUT}); }catch{}
            const onEnter = TILES.hooks.onEnter.get(key);
            if (onEnter) try{ onEnter({e:p,gx,gy,dt,world,INPUT}); }catch{}
            lastKey = key;
          }
          // stay
          const onStay = TILES.hooks.onStay.get(key);
          if (onStay) try{ onStay({e:p,gx,gy,dt,world,INPUT}); }catch{}
        }
      } else {
        lastKey = null; // å›åˆ°ç·¨è¼¯æ™‚é‡ç½®
      }
    }catch{}
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // 6) æä¾› palette é‡æ–°æ¸²æŸ“ï¼ˆå¯é¸ï¼‰
  window.__renderCategory = function(cat){
    // è®“ Phase1 çš„ renderCategory èƒ½è¢«å‘¼å«ï¼›è‹¥æ²’æœ‰å°±å¿½ç•¥
    try{
      const ev = new Event('click');
      const pill = document.querySelector(`#palette .pill[data-cat="${cat}"]`);
      if (pill) pill.dispatchEvent(ev);
    }catch{}
  };
})();
</script>
//TILE API çµæŸ




//åœ°å½¢æ’ä»¶é–‹å§‹
<script>
/* =========================
   æ°´å¤–æ›ï¼ˆ~ï¼‰
   - é€²æ°´ï¼šæ¸¸æ³³æ‰‹æ„Ÿï¼ˆé˜»å°¼ï¼‹æµ®åŠ›ï¼‰
   - é•·æŒ‰ã€Œè·³èºã€ï¼šæŒçºŒä¸Šæµ®ï¼ˆå°é ‚é€Ÿåº¦é¿å…ç©¿ç‰†ï¼‰
   - å‡ºæ°´ï¼šå™´æ°´èŠ±ç²’å­
   - ç•«æ³•ï¼šç„¡æ³¢ç´‹ï¼Œåƒ…æŸ”å’Œå‚ç›´æ¼¸å±¤
   ä¾è³´ï¼š
   - ä½ å·²ç¶“æœ‰ TILES.add / DD_HOOKS æ´¾ç™¼å™¨ / __ensurePlayer / __getMode
   ========================= */

/* ---- è¼•é‡æ°´èŠ± FXï¼šæ›åˆ° __drawCombatï¼Œèˆ‡æ—¢æœ‰æ•ˆæœå…±å­˜ ---- */
(function setupWaterFX(){
  if (window.__WATER_FX_PATCHED) return;        // é˜²é‡è¤‡
  window.__WATER_FX_PATCHED = true;

  const FX = (window.WATER_FX ||= []);
  let prevDraw = window.__drawCombat;
  let last = performance.now();

  function spawnSplash(x, y, vyBoost = 0){
    const n = 12 + Math.floor(Math.random()*10);
    for (let i=0; i<n; i++){
      FX.push({
        x, y,
        vx: (Math.random()*280 - 140),
        vy: (-260 - Math.random()*220) - vyBoost*0.15,
        r: 1.8 + Math.random()*2.2,
        t: 0,
        life: 0.55 + Math.random()*0.25
      });
    }
  }
  window.WATER_FX_spawn = spawnSplash;

  window.__drawCombat = function(ctx){
    if (typeof prevDraw === 'function') prevDraw(ctx);

    const now = performance.now();
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;

    for (let i=FX.length-1; i>=0; i--){
      const p = FX[i];
      p.t += dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 1400*dt;     // é‡åŠ›

      const a = Math.max(0, 1 - p.t/p.life);
      if (a <= 0){ FX.splice(i,1); continue; }

      ctx.globalAlpha = a;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = '#8fd3ff';
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  };
})();

/* ---- æ°´ tile æœ¬é«” ---- */
TILES.add({
  key: '~',
  label: '~ æ°´ï¼ˆå¯æ¸¸æ³³ï¼‰',
  solid: false,
  meta: { isWater: true },

  // ç„¡æ³¢ç´‹ç•«æ³•ï¼šæŸ”å’Œå‚ç›´æ¼¸å±¤
  draw(ctx, x, y, T){
    const g = ctx.createLinearGradient(0, y, 0, y+T);
    g.addColorStop(0.00, '#6ecbff');
    g.addColorStop(1.00, '#1c5b9a');
    ctx.fillStyle = g;
    ctx.fillRect(x, y, T, T);
  },

  onEnter({ e, gy }) {
    e._inWater = true;
    e._lastWaterGy = gy;         // ç´€éŒ„æ°´é¢åˆ—ï¼Œç”¨æ–¼å‡ºæ°´æ™‚å®šä½
  },

  onExit({ e, gx, gy, world }) {
    // å¾€ä¸Šé›¢é–‹æ°´é¢æ‰å™´æ°´èŠ±ï¼ˆvy < -40ï¼‰
    if (e._inWater && e.vy < -40 && world?.tileSize){
      const T = world.tileSize;
      const waterGy = (e._lastWaterGy != null ? e._lastWaterGy : (gy+1));
      const surfaceY = waterGy * T;           // æ°´æ ¼é ‚é‚Šç•¶ä½œæ°´é¢
      const cx = e.x + e.w/2;
      if (typeof window.WATER_FX_spawn === 'function'){
        window.WATER_FX_spawn(cx, surfaceY, -e.vy);
      }
    }
    e._inWater = false;
    e._lastWaterGy = null;
  },

  onStay({ e, dt, INPUT, gy }) {
    // æ¨™è¨˜æŒçºŒåœ¨æ°´ä¸­
    e._inWater = true;
    e._lastWaterGy = gy;

    // åŸºç¤æ¸¸æ³³æ‰‹æ„Ÿï¼šé˜»å°¼ + æµ®åŠ›
    e.vx *= 0.82;        // æ°´ä¸­æ°´å¹³é˜»å°¼
    e.vy *= 0.72;        // å‚ç›´é˜»å°¼
    e.vy -= 320 * dt;    // åŸºç¤æµ®åŠ›ï¼ˆä¸æŒ‰éµä¹Ÿæœƒæ…¢æ…¢ä¸Šæµ®ï¼‰

    // é•·æŒ‰ã€Œè·³èºã€â†’ é¡¯è‘—ä¸Šæµ®ï¼›å°é ‚é¿å…ç©¿ç‰†
    if (INPUT?.jump){
      const maxUp = -800;     // ä¸Šæµ®æœ€å¤§é€Ÿåº¦ï¼ˆè² å€¼ï¼å¾€ä¸Šï¼‰
      e.vy -= 6500 * dt;       // é¡å¤–ä¸Šæµ®åŠ›
      if (e.vy < maxUp) e.vy = maxUp;
    }

    // åœ¨æ°´ä¸­ä¸è¦–ç‚ºè‘—åœ°ï¼Œé¿å…é™¸ä¸Šè·³é‚è¼¯å¹²æ“¾
    e.onGround = false;
  }
});
</script>



//åœ°å½¢æ’ä»¶çµæŸ





